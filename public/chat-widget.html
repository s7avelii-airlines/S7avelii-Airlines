<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat Widget ‚Äî S7avelii SynAir</title>
<style>
/* ---------- –°—Ç–∏–ª–∏ –≤–∏–¥–∂–µ—Ç–∞ (–≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ) ---------- */
:root{
  --accent:#9bd009;
  --accent-dark:#7fb200;
  --bg:#f1f4f8;
  --card:#ffffff;
  --text:#0b2b3a;
}

body{ margin:0; font-family: Arial, Helvetica, sans-serif; background:transparent; }

/* –∫–Ω–æ–ø–∫–∞ */
.chat-button {
  position: fixed;
  right: 24px;
  bottom: 24px;
  width: 64px;
  height: 64px;
  background: linear-gradient(180deg,var(--accent),var(--accent-dark));
  border-radius: 50%;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: 0 8px 28px rgba(0,0,0,0.25);
  cursor:pointer;
  z-index: 99999;
  transition: transform .15s ease;
}
.chat-button:hover{ transform: scale(1.06); }
.chat-button svg{ width:34px; height:34px; }

/* –æ–∫–Ω–æ */
#chat-window {
  position: fixed;
  right: 24px;
  bottom: 100px;
  width: 360px;
  max-width: calc(100% - 48px);
  height: 560px;
  background: var(--card);
  border-radius: 16px;
  box-shadow: 0 18px 48px rgba(0,0,0,0.35);
  display: none;
  flex-direction: column;
  overflow: hidden;
  z-index: 99998;
}

/* header */
.chat-header {
  background: linear-gradient(90deg,var(--accent),var(--accent-dark));
  padding: 12px;
  color: white;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.header-left{ display:flex; align-items:center; gap:10px; }
.avatar-header{
  width:42px;height:42px;border-radius:50%;object-fit:cover;background:rgba(255,255,255,0.12);padding:3px;
}
.header-title b{ display:block; font-size:15px; }
.header-title small{ opacity:.9; font-size:12px; }

/* body */
.chat-body{
  flex:1;
  padding:14px;
  overflow-y:auto;
  background: var(--bg);
}
.msg{
  background: #fff;
  padding:10px 14px;
  border-radius:14px;
  margin-bottom:10px;
  max-width:78%;
  display:inline-block;
  color:var(--text);
  box-shadow: 0 2px 6px rgba(12,30,40,0.04);
  line-height:1.25;
  word-break:break-word;
}
.msg.user{ background:#c0eb5e; margin-left:auto; }
.msg.system{ background:transparent; font-style:italic; color:#4b5560; max-width:100%; }

/* input */
.chat-input{
  display:flex;
  gap:8px;
  padding:10px;
  background:#fff;
  border-top:1px solid #eee;
}
.chat-input input{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
  outline:none;
}
.chat-input button{
  background:var(--accent-dark);
  color:#fff;
  border:none;
  padding:8px 12px;
  border-radius:10px;
  cursor:pointer;
}

/* –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–≥–æ–¥—ã */
.weather-card{
  background: linear-gradient(180deg,#fff,#fbfeff);
  border-radius:12px;
  padding:12px;
  margin-bottom:10px;
  box-shadow:0 6px 18px rgba(14,40,78,0.06);
  max-width:78%;
  color:var(--text);
  font-size:14px;
}
.weather-top{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.weather-left{ display:flex; align-items:center; gap:10px; }
.weather-icon{ width:56px; height:56px; }
.weather-temp{ font-size:26px; font-weight:700; line-height:1; }
.weather-desc{ font-size:13px; color:#3b5666; }
.weather-meta{ margin-top:8px; display:flex; gap:10px; font-size:12px; color:#556b75; }

/* responsive */
@media (max-width:420px){
  #chat-window{ right:12px; left:12px; width:auto; height:56vh; bottom:80px; }
  .chat-button{ right:12px; bottom:18px; }
}
</style>
</head>
<body>

<!-- –ö–Ω–æ–ø–∫–∞ -->
<div id="chat-button" class="chat-button" title="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç">
  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10z" fill="#fff"/>
  </svg>
</div>

<!-- –û–∫–Ω–æ -->
<div id="chat-window" role="dialog" aria-label="–ß–∞—Ç —Å S7avelii SynAir">
  <div class="chat-header">
    <div class="header-left">
      <img src="" alt="avatar" class="avatar-header" id="widget-avatar">
      <div class="header-title">
        <b>S7avelii SynAir</b>
        <small id="header-status">–û–Ω–ª–∞–π–Ω</small>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
      <button id="open-full" title="–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ" style="background:transparent;border:none;color:white;cursor:pointer;font-size:16px">‚§¢</button>
      <button id="close-chat" title="–ó–∞–∫—Ä—ã—Ç—å" style="background:transparent;border:none;color:white;font-size:20px;cursor:pointer">‚úï</button>
    </div>
  </div>

  <div id="chat-body" class="chat-body" aria-live="polite"></div>

  <div class="chat-input">
    <input id="chat-text" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ü–æ–≥–æ–¥–∞ –≤ –ú–æ—Å–∫–≤–µ¬ª)" aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ">
    <button id="send-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
    <button id="voice-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
  </div>
</div>

<script>
/* ==================== –ü–æ–ª–Ω—ã–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –≤–∏–¥–∂–µ—Ç ====================
   - miniGPT-like –ª–æ–∫–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
   - —Å–∞–º–æ–æ–±—É—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ localStorage
   - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞–¥–µ–∂–µ–π –≥–æ—Ä–æ–¥–æ–≤ + —Å–ª–æ–≤–∞—Ä—å —Ñ–æ—Ä–º
   - OpenWeather –∑–∞–ø—Ä–æ—Å—ã (–∫–ª—é—á –≤—Å—Ç–∞–≤–ª–µ–Ω)
   - –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–≥–æ–¥—ã
   - –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥/–≤—ã–≤–æ–¥
==================================================================== */

/* ---------- UI behavior ---------- */
const chatButton = document.getElementById('chat-button');
const chatWindow = document.getElementById('chat-window');
const closeBtn = document.getElementById('close-chat');
const sendBtn = document.getElementById('send-btn');
const inputEl = document.getElementById('chat-text');
const chatBody = document.getElementById('chat-body');
const voiceBtn = document.getElementById('voice-btn');
const openFullBtn = document.getElementById('open-full');
const avatarImg = document.getElementById('widget-avatar');

avatarImg.src = ''; // –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ –∞–≤–∞—Ç–∞—Ä—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

chatButton.onclick = () => { chatWindow.style.display = 'flex'; inputEl.focus(); };
closeBtn.onclick = () => { chatWindow.style.display = 'none'; };
openFullBtn.onclick = () => {
  // –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ –æ–∫–Ω–æ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π, –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å URL
  window.open(window.location.href, '_blank');
};

/* ---------- render helpers ---------- */
function addUser(text){
  const d = document.createElement('div'); d.className='msg user'; d.innerText = text;
  chatBody.appendChild(d); chatBody.scrollTop = chatBody.scrollHeight;
}
function addAI(html, speak=true){
  const d = document.createElement('div'); d.className='msg'; d.innerHTML = html;
  chatBody.appendChild(d); chatBody.scrollTop = chatBody.scrollHeight;
  if (speak) speakText(stripHtml(html));
}
function addSystem(text){
  const d = document.createElement('div'); d.className='msg system'; d.innerText = text;
  chatBody.appendChild(d); chatBody.scrollTop = chatBody.scrollHeight;
}
function stripHtml(html){ const tmp=document.createElement('DIV'); tmp.innerHTML=html; return tmp.textContent||tmp.innerText||''; }

/* ---------- knowledge & learning ---------- */
const knowledge = [
    { key: ["–∫—É–ø–∏—Ç—å","–±–∏–ª–µ—Ç"], answer: "–ö—É–ø–∏—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π –±–∏–ª–µ—Ç –ø–æ–∫–∞ –Ω–µ–ª—å–∑—è ‚Äî –º—ã –º–∏–Ω–∏–∞—Ç—é—Ä–Ω–∞—è –∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è. –ù–æ –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É ¬´–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç¬ª." },
    { key: ["–∫–∞—Ä—Ç–∞","priority"], answer: "–ß—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∫–∞—Ä—Ç—É S7avelii Priority ‚Äî –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª, –ø—Ä–æ–ª–∏—Å—Ç–∞–π—Ç–µ –≤–Ω–∏–∑ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É." },
    { key: ["–º–∞–≥–∞–∑–∏–Ω","—Ç–æ–≤–∞—Ä","–∫—É–ø–∏—Ç—å"], answer: "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª S7avelii Shop, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä, –Ω–∞–∂–º–∏—Ç–µ ¬´–ö—É–ø–∏—Ç—å¬ª ‚Äî –∏ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä." },
    { key: ["–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è","–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"], answer: "–ù–∞–∂–º–∏—Ç–µ ¬´–í—Ö–æ–¥¬ª ‚Üí ¬´–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è¬ª. –ù—É–∂–Ω–æ —Å–æ—Å—Ç–æ—è—Ç—å –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ S7avelii Priority." },
    { key: ["—Å–∫–æ–ª—å–∫–æ","—Å–∞–º–æ–ª–µ—Ç","—Ñ–ª–æ—Ç"], answer: "–§–ª–æ—Ç S7avelii Airlines –Ω–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç 12 –º–∏–Ω–∏–∞—Ç—é—Ä–Ω—ã—Ö —Å–∞–º–æ–ª–µ—Ç–æ–≤. –ë–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—à —Ñ–ª–æ—Ç –≤—ã –º–æ–∂–µ—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª–µ –ù–ê–® –§–õ–û–¢" },
    { key: ["—Å–∞–π—Ç","–∑–∞–∫–∞–∑–∞—Ç—å","—Ç–∞—Ä–∏—Ñ","–±–∏–∑–Ω–µ—Å"], answer: "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª ¬´–î–ª—è –±–∏–∑–Ω–µ—Å–∞¬ª, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏." },
    { key: ["–ø–∏—Ç–∞–Ω–∏–µ","–µ–¥–∞","–∫—É—à–∞—Ç—å"], answer: "–ü–∏—Ç–∞–Ω–∏–µ –Ω–∞ –±–æ—Ä—Ç –º–æ–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å –∑–∞—Ä–∞–Ω–µ–µ, –∑–∞ 48 —á–∞—Å–æ–≤ –¥–æ —Ä–µ–π—Å–∞." },
    { key: ["–º–∏–ª–∏","–º–∏–ª–∏ –∑–∞ —Ä—É–±–ª–∏","–∑–∞—á–µ–º","–Ω—É–∂–Ω—ã"], answer: "–ú–∏–ª–∏ —ç—Ç–æ –≤–∞–ª—é—Ç–∞ –Ω–∞—à–µ–π –∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏–∏, –∏—Ö –≤—ã –º–æ–∂–µ—Ç–µ –∫–æ–ø–∏—Ç—å –∏ –≤—ã–∏–≥—Ä—ã–≤–∞—Ç—å –Ω–∞ —Ä–∞—Å–ø—Ä–æ–¥–∞–∂–∞—Ö –∏–ª–∏ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –Ω–∞—à–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤. –¢–∞–∫–∂–µ –≤—ã –º–æ–∂–µ—Ç–µ –∫—É–ø–∏—Ç—å –º–∏–ª–∏ –∏–ª–∏ –æ–±–º–µ–Ω—è—Ç—å –∏—Ö –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏. –ö–æ–ø–∏—Ç–µ –º–∏–ª–∏, –¥–ª—è –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π" },
    { key: ["–∫–ª–∞—Å—Å","–±–∏–∑–Ω–µ—Å","–≤—ã–±–æ—Ä –∫–ª–∞—Å—Å–∞","—ç–∫–æ–Ω–æ–º"], answer: "–í—ã–±–æ—Ä –∫–ª–∞—Å—Å–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —Å –Ω–∞—á–∞–ª–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –≤–∞–∂–Ω–æ –ª–∏—à—å —É—Å–ø–µ—Ç—å. !–ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï: –ê–í–ò–ê–ö–û–ú–ü–ê–ù–ò–Ø –ú–ò–ù–ò–ê–¢–Æ–†–ù–ê–Ø!" },
    { key: ["–ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ","–æ—Ñ–∏—Å","–≥–¥–µ –æ—Ñ–∏—Å"], answer: "–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ S7avelii Airlines –¥–µ–ª–∏—Ç—Å—è –Ω–∞ –¥–≤–∞ –≤–∏–¥–∞: –†–µ–∞–ª—å–Ω—ã–π –æ—Ñ–∏—Å, –Ω–∞—Ö–æ–¥—è—â–∏–π—Å—è –≤ –≥. –°–∞—Ä–∞—Ç–æ–≤, –°–∞—Ä–∞—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ö–∏–µ–≤—Å–∫–∏–π –ø—Ä–æ–µ–∑–¥ –¥.1 . –≠—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ñ–ª–∞–≥–º–∞–Ω—Å–∫–∏–π –æ—Ñ–∏—Å. –í—Ç–æ—Ä–æ–µ - –º–∏–Ω–∏–∞—Ç—é—Ä–Ω–æ–µ, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤–æ –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–∞—Ö, –≤ –∫–æ—Ç–æ—Ä—ã–µ –º—ã –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ–º —Ä–µ–π—Å—ã." },
    { key: ["–æ –Ω–∞—Å","–æ –≤–∞—Å","–∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è", "–∫—Ç–æ –≤—ã?"], answer: "–ê–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è S7avelii Airlines —è–≤–ª—è–µ—Ç—Å—è –º–æ–ª–æ–¥–æ–π –∏ —Ä–∞–∑–≤–∏–≤–∞—é—â–µ–π—Å—è –∫–æ–º–ø–∞–Ω–∏–µ–π –Ω–∞ —Ä–æ—Å—Å–∏–π—Å–∫–æ–º —Ä—ã–Ω–∫–µ —Å 2019 –≥–æ–¥–∞. –í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç, –ø–æ–º–∏–º–æ –º–∏–Ω–∏–∞—Ç—é—Ä–Ω—ã—Ö –∞–≤–∏–∞–ø–µ—Ä–µ–≤–æ–∑–æ–∫, –º—ã —Å–æ–∑–¥–∞–µ–º –Ω–∞—Å—Ç–æ—è—â–∏–µ —Å–∞–π—Ç—ã –∏ –¥—Ä—É–≥–∏–µ —Ü–∏—Ñ—Ä–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã, –∞ —Ç–∞–∫–∂–µ –ø—Ä–æ–¥–∞—ë–º –Ω–∞—à —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π –º–µ—Ä—á.–ë–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ –æ–∑–Ω–∞–∫–æ–º–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ –û –ù–ê–°" },
    { key: ["–ø–æ–ª—ë—Ç","–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ","—Å–µ—Ç—å", "–º–∞—Ä—à—Ä—É—Ç—ã", "—Å–∫–æ–ª—å–∫–æ —Ä–µ–π—Å–æ–≤", "—Å–∫–æ–ª—å–∫–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π"], answer: "–ù–∞—à–∞ –∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –≤–∞–º —Ö–æ—Ç—å –∏ –º–∏–Ω–∏–∞—Ç—é—Ä–Ω—É—é, –Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—É—é –º–∞—Ä—à—Ä—É—Ç–Ω—É—é —Å–µ—Ç—å —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ –≤ –ï–≤—Ä–æ–ø—É, –ê–∑–∏—é, –∞ —Ç–∞–∫–∂–µ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –≥–æ—Ä–æ–¥–æ–≤. –ü–æ–¥—Ä–æ–±–Ω–µ–µ –º–æ–∂–µ—Ç–µ –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø" },
    { key: ["–ø–æ–¥–¥–µ—Ä–∂–∫–∞","—Å–ª—É–∂–±–∞","–ø–æ–º–æ—â—å"], answer: "–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –Ω–æ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–º–æ—á—å –≤–∞–º –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å, —á—Ç–æ —É –≤–∞—Å —Å–ª—É—á–∏–ª–æ—Å—å?" },
    { key: ["–ø–∞—Ä—Ç–Ω—ë—Ä—ã","–ø–∞—Ä—Ç–Ω–µ—Ä—ã","—Å –∫–µ–º –¥—Ä—É–∂–∏—Ç–µ", "–∫—Ç–æ —É –≤–∞—Å –ø–∞—Ä—Ç–Ω–µ—Ä"], answer: "–í—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—à–∏—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤, –ø—Ä–æ–ª–∏—Å—Ç–∞–≤ –≤ –Ω–∏–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –æ—Ç–∫—Ä—ã—Ç—å —Ä–∞–∑–¥–µ–ª –ü–ê–†–¢–ù–Å–†–´, –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å—Ç–∞—Ç—å –Ω–∞—à–∏–º –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º, —Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ü–û–î–ê–¢–¨ –ó–ê–Ø–í–õ–ï–ù–ò–ï –ù–ê –ü–ê–†–¢–ù–Å–†–°–¢–í–û." },
    { key: ["—Ä–∞–±–æ—Ç–∞","—Ö–æ—á—É —Ä–∞–±–æ—Ç–∞—Ç—å","–≤—ã –∫—Ä—É—Ç—ã–µ", "–Ω—É–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞", "–≤–∞–∫–∞–Ω—Å–∏–∏",], answer: "–ú—ã —Ä–∞–¥—ã, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å—Ç–∞—Ç—å —á–∞—Å—Ç—å—é –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã –∏–ª–∏ —Ç–æ–ª—å–∫–æ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ, –≤ —Ä–∞–∑–¥–µ–ª–µ –í–ê–ö–ê–ù–°–ò–ò –≤—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –ø–æ–¥–æ–±—Ä–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç, —Å–∫–∞–∂—É –ø–æ —Å–µ–∫—Ä–µ—Ç—É, —Ä–∞–±–æ—Ç–∞—Ç—å –∑–¥–µ—Å—å —Å–∞–º—ã–π –Ω–∞—Å—Ç–æ—è—â–∏–π –±–∞–ª–¥—ë–∂. –ï—Å–ª–∏ –≤–∞—Å –ø–æ–∑–≤–∞–ª–∏ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –≤—ã –≤—ã–±—Ä–∞–ª–∏ –∂–µ–ª–∞–µ–º—É—é –¥–æ–ª–∂–Ω–æ—Å—Ç—å, –Ω–æ –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –ø–æ—á—Ç—É: s7avelii_airlines@mail.ru" },
    { key: ["—Å—Ç–∞—Ç—å–∏","7PLANE7","–ø—Ä–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ"], answer: "7PLANE7 –º–µ—Å—Ç–æ –≥–¥–µ –≤—ã —Å–º–æ–∂–µ—Ç–µ —É–∑–Ω–∞—Ç—å –æ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö, –∏ –¥–∞–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å, —É –≤–∞—Å –ø–æ—è–≤–∏—Ç—Å—è –∂–µ–ª–∞–Ω–∏–µ —Ç—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è." },
    { key: ["–Ω–æ–≤–æ—Å—Ç–∏","–∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å","—á—Ç–æ –∫–∞–∫ —É –≤–∞—Å —Ç—É—Ç?"], answer: "–ù–æ–≤–æ—Å—Ç–∏ –µ—Å—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, —Ç–∞–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è —Å–∞–º—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –∫–æ–º–ø–∞–Ω–∏–∏" },
    { key: ["—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è","–∞—ç—Ä–æ–ø–æ—Ä—Ç","–∑–∞ —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏"], answer: "–û–Ω–ª–∞–π–Ω-—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∑–∞ 40 —á–∞—Å–æ–≤ –¥–æ –≤—ã–ª–µ—Ç–∞, –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç –ª—É—á—à–µ –ø—Ä–∏–µ–∑–∂–∞—Ç—å –∑–∞ 2,5 —á–∞—Å–∞. –õ—É—á—à–µ –≤—Å–µ–≥–æ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —É–ø–∞–∫–æ–≤–∫–æ–π –±–∞–≥–∞–∂–∞, —á—Ç–æ–±—ã –æ–±–µ–∑–æ–ø–∞—Å–∏—Ç—å –µ–≥–æ –æ—Ç –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤" },
    { key: ["–±–∞–≥–∞–∂","—Ä—É—á–Ω–∞—è –∫–ª–∞–¥—å","—Ä–∞–∑–º–µ—Ä—ã?"], answer: "–†–∞–∑–º–µ—Ä—ã —Ä—É—á–Ω–æ–π –∫–ª–∞–¥–∏ —É –Ω–∞—Å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ 55x40x20 —Å–º —Å –≤–µ—Å–æ–º 7-10 –∫–≥, —Å –±–∞–≥–∞–∂–æ–º —Ç—Ä–∏ —Ç–∞—Ä–∏—Ñ–∞: S –¥–æ 23 M –¥–æ 25 L –¥–æ 28" },
    { key: ["–æ—Ç–µ–ª–∏","–≥–æ—Å—Ç–∏–Ω–∏—Ü–∞"], answer: "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª ¬´–û–¢–ï–õ–ò¬ª. –°–µ–π—á–∞—Å –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π –æ—Ç–µ–ª—å –Ω–µ–ª—å–∑—è, –º—ã –º–∏–Ω–∏–∞—Ç—é—Ä–Ω–∞—è –∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è." }
];
  
let learnedDB = JSON.parse(localStorage.getItem('chat_widget_memory_v1') || '{}');
function saveLearning(q, a){ learnedDB[q.toLowerCase()] = a; localStorage.setItem('chat_widget_memory_v1', JSON.stringify(learnedDB)); }
function searchLearning(q){ const Q = q.toLowerCase(); for (const k in learnedDB) { if (similarity(Q,k) > 0.6) return learnedDB[k]; } return null; }

/* ---------- CITY FORMS (—á–∞—Å—Ç–∏—á–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å) ---------- */
/* –î–æ–±–∞–≤–ª—è–π —Ñ–æ—Ä–º—ã –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî —Å–ª–æ–≤–∞—Ä—å –ø–æ–≤—ã—à–∞–µ—Ç —Ç–æ—á–Ω–æ—Å—Ç—å */
const CITY_FORMS = {
  "–º–æ—Å–∫–≤–∞":"–ú–æ—Å–∫–≤–∞","–º–æ—Å–∫–≤–µ":"–ú–æ—Å–∫–≤–∞","–º–æ—Å–∫–≤—ã":"–ú–æ—Å–∫–≤–∞","–º–æ—Å–∫–≤–æ–π":"–ú–æ—Å–∫–≤–∞",
  "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥":"–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥","—Å–∞–Ω–∫—Ç –ø–µ—Ç–µ—Ä–±—É—Ä–≥":"–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥","–ø–∏—Ç–µ—Ä":"–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥","–ø–∏—Ç–µ—Ä–µ":"–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥","—Å–ø–±":"–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
  "–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥":"–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥","–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–µ":"–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥",
  "–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫":"–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫","–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–µ":"–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫",
  "–∫–∞–∑–∞–Ω—å":"–ö–∞–∑–∞–Ω—å","–∫–∞–∑–∞–Ω–∏":"–ö–∞–∑–∞–Ω—å",
  "–º–∏–Ω—Å–∫":"–ú–∏–Ω—Å–∫","–º–∏–Ω—Å–∫–µ":"–ú–∏–Ω—Å–∫",
  "–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä":"–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä","–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ":"–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä",
  "—Å–æ—á–∏":"–°–æ—á–∏",
  "–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥":"–ùizhny Novgorod","–Ω–∏–∂–Ω–µ–º –Ω–æ–≤–≥–æ—Ä–æ–¥–µ":"Nizhny Novgorod",
  "—Å–∞–º–∞—Ä–∞":"–°–∞–º–∞—Ä–∞","—Å–∞–º–∞—Ä–µ":"–°–∞–º–∞—Ä–∞",
  "—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É":"–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É","—Ä–æ—Å—Ç–æ–≤–µ":"–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É",
  "—É—Ñ–∞":"–£—Ñ–∞","—É—Ñ–µ":"–£—Ñ–∞",
  "–≤–æ—Ä–æ–Ω–µ–∂":"–í–æ—Ä–æ–Ω–µ–∂","–≤–æ—Ä–æ–Ω–µ–∂–µ":"–í–æ—Ä–æ–Ω–µ–∂",
  "–Ω—å—é-–π–æ—Ä–∫":"New York","–Ω—å—é –π–æ—Ä–∫":"New York","–≤ –Ω—å—é-–π–æ—Ä–∫–µ":"New York",
  "–ª–æ–Ω–¥–æ–Ω":"London","–≤ –ª–æ–Ω–¥–æ–Ω–µ":"London",
  "–±—Ä—é—Å—Å–µ–ª—å":"Brussels","–≤ –±—Ä—é—Å—Å–µ–ª–µ":"Brussels",
  "–∫–∏–µ–≤":"Kyiv","–≤ –∫–∏–µ–≤–µ":"Kyiv","–∫–∏–µ–≤–µ":"Kyiv"
};

/* ---------- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ –¥–µ—Ç–µ–∫—Ç –≥–æ—Ä–æ–¥–∞ ---------- */
function cleanToken(t){
  if(!t) return "";
  return t.replace(/^[^–∞-—èa-z0-9]+|[^–∞-—èa-z0-9]+$/gi,"").replace(/\s+/g," ").toLowerCase();
}

function stripRussianCaseEndings(word){
  if(!word) return word;
  // –ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞–¥–µ–∂–Ω—ã—Ö –æ–∫–æ–Ω—á–∞–Ω–∏–π
  const endings = ["–∞–º–∏","—è–º–∏","–∞–º–∏","–∞—Ö","—è—Ö","–æ–º","–µ–º","–æ–π","–µ–π","—É","—é","–∞","—è","—ã","–∏","–æ–≤","–µ–≤","–∏–Ω","–Ω–∞","–Ω–æ–≥–æ","–æ–≥–æ"];
  for (const end of endings){
    if(word.endsWith(end) && word.length - end.length >= 3) return word.slice(0, -end.length);
  }
  return word;
}

function detectCity(text){
  if(!text) return "";
  const s = text.toLowerCase().replace(/[?!.(),;:¬´¬ª"‚Äú‚Äù]/g," ");
  const tokens = s.split(/\s+/).map(cleanToken).filter(Boolean);
  // longest match multiword (4..1)
  for (let len=4; len>=1; len--){
    for (let i=0;i+len<=tokens.length;i++){
      const slice = tokens.slice(i,i+len).join(' ').trim();
      if(!slice) continue;
      if(CITY_FORMS[slice]) return CITY_FORMS[slice];
      if(slice.startsWith('–≤ ')){
        const cut = slice.replace(/^–≤\s+/,'');
        if(CITY_FORMS[cut]) return CITY_FORMS[cut];
      }
    }
  }
  // single token direct
  for (const t of tokens){
    if(CITY_FORMS[t]) return CITY_FORMS[t];
  }
  // try stripped endings
  for (const t of tokens){
    const stripped = stripRussianCaseEndings(t);
    if(stripped !== t && CITY_FORMS[stripped]) return CITY_FORMS[stripped];
  }
  // fallback: choose first long token and capitalize
  for (const t of tokens){
    if(t.length>=3) return t.charAt(0).toUpperCase() + t.slice(1);
  }
  return "";
}

/* ---------- OpenWeather (–∫–ª—é—á —É–∂–µ –≤—Å—Ç–∞–≤–ª–µ–Ω) ---------- */
const WEATHER_KEY = "579eff04697ae897da8e50ee33ee1645";

async function fetchWeather(city){
  if(!WEATHER_KEY || WEATHER_KEY.trim()==="") return {ok:false, message:"API-–∫–ª—é—á –Ω–µ –∑–∞–¥–∞–Ω."};
  if(!city) return {ok:false, message:"–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω."};
  const q = encodeURIComponent(city.trim());
  const url = `https://api.openweathermap.org/data/2.5/weather?q=${q}&appid=${WEATHER_KEY}&units=metric&lang=ru`;
  try{
    const res = await fetch(url);
    if(!res.ok){
      if(res.status===401) return {ok:false, message:"401 Unauthorized ‚Äî –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π API-–∫–ª—é—á."};
      if(res.status===404) return {ok:false, message:`–ì–æ—Ä–æ–¥ ¬´${city}¬ª –Ω–µ –Ω–∞–π–¥–µ–Ω (404). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ñ–æ—Ä–º—É.`};
      return {ok:false, message:`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status}`};
    }
    const d = await res.json();
    return {ok:true, data:d};
  }catch(e){
    return {ok:false, message:"–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–≥–æ–¥—ã."};
  }
}

function buildWeatherCard(d){
  const icon = d.weather && d.weather[0] && d.weather[0].icon ? d.weather[0].icon : null;
  const desc = d.weather && d.weather[0] && d.weather[0].description ? capitalize(d.weather[0].description) : "";
  const temp = d.main && typeof d.main.temp === "number" ? Math.round(d.main.temp) : "‚Äî";
  const feels = d.main && typeof d.main.feels_like === "number" ? Math.round(d.main.feels_like) : "‚Äî";
  const humidity = d.main && d.main.humidity != null ? d.main.humidity : "‚Äî";
  const wind = d.wind && d.wind.speed != null ? `${d.wind.speed} –º/—Å` : "‚Äî";
  const name = d.name || "";
  const country = d.sys && d.sys.country ? `, ${d.sys.country}` : "";
  const iconUrl = icon ? `https://openweathermap.org/img/wn/${icon}@2x.png` : "";

  return `
  <div class="weather-card" role="region" aria-label="–ü–æ–≥–æ–¥–∞ –≤ ${escapeHtml(name)}">
    <div class="weather-top">
      <div class="weather-left">
        ${iconUrl?`<img class="weather-icon" src="${iconUrl}" alt="${escapeHtml(desc)}">`:""}
        <div>
          <div style="font-size:14px;font-weight:600;">–ü–æ–≥–æ–¥–∞ –≤ ${escapeHtml(name)}${escapeHtml(country)}</div>
          <div class="weather-desc">${escapeHtml(desc)}</div>
        </div>
      </div>
      <div style="text-align:right">
        <div class="weather-temp">${temp}¬∞C</div>
        <div style="font-size:12px;color:#5b6f78">–æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ ${feels}¬∞C</div>
      </div>
    </div>
    <div class="weather-meta">
      <div>–í–ª–∞–∂–Ω–æ—Å—Ç—å: ${humidity}%</div>
      <div>–í–µ—Ç–µ—Ä: ${escapeHtml(wind)}</div>
    </div>
  </div>
  `;
}

/* ---------- miniGPT core ---------- */
let memory = [];
function similarity(a,b){
  const wa = String(a).toLowerCase().split(/\s+/).filter(Boolean);
  const wb = String(b).toLowerCase().split(/\s+/).filter(Boolean);
  const setB = new Set(wb); let match=0;
  for(const w of wa) if(setB.has(w)) match++;
  return match / Math.max(1, Math.max(wa.length, wb.length));
}
function generateContextAnswer(q){ return "–ü—Ä–æ–¥–æ–ª–∂–∞—é –ø–æ –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É: ¬´" + escapeHtml(q) + "¬ª. –ú–æ–≥—É —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ."; }

/* –≥–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ */
async function miniGPT(question){
  const qRaw = question || "";
  const q = String(qRaw).toLowerCase().trim();
  memory.push(q); if(memory.length>20) memory.shift();

  // 0. trained answers
  const learned = searchLearning(q);
  if(learned) return learned;

  // 1. weather intent
  if(q.includes("–ø–æ–≥–æ–¥–∞") || q.includes("—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞") || q.includes("weather")){
    const city = detectCity(qRaw);
    if(!city) return "–£—Ç–æ—á–Ω–∏—Ç–µ –≥–æ—Ä–æ–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ü–æ–≥–æ–¥–∞ –≤ –ú–æ—Å–∫–≤–µ¬ª –∏–ª–∏ ¬´–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ¬ª.";
    addSystem("–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –ø–æ–≥–æ–¥—É –¥–ª—è: " + city + " ‚Ä¶");
    const res = await fetchWeather(city);
    if(!res.ok) return `–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–≥–æ–¥—É: ${res.message}`;
    const card = buildWeatherCard(res.data);
    saveLearning(q, card);
    return card;
  }

  // 2. exact knowledge
  for(const item of knowledge){
    let ok=true;
    for(const k of item.key){ if(!q.includes(k)){ ok=false; break; } }
    if(ok){ saveLearning(q,item.answer); return item.answer; }
  }

  // 3. partial match
  for(const item of knowledge){
    let count=0;
    for(const k of item.key) if(q.includes(k)) count++;
    if(count>=1){ saveLearning(q,item.answer); return item.answer; }
  }

  // 4. context continuation
  if(memory.length>=2){
    const last = memory[memory.length-2];
    if(similarity(q,last) > 0.55){ const ans = generateContextAnswer(question); saveLearning(q,ans); return ans; }
  }

  // fallback
  const fallback = "–Ø –º–æ–≥—É —É—Ç–æ—á–Ω–∏—Ç—å: —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –ø–æ —Ç–µ–º–µ ¬´" + escapeHtml(question) + "¬ª?";
  saveLearning(q,fallback);
  return fallback;
}

/* ---------- send message ---------- */
async function sendMessage(){
  const text = inputEl.value.trim();
  if(!text) return;
  addUser(text);
  inputEl.value = "";
  try{
    const ai = await miniGPT(text);
    setTimeout(()=> addAI(ai), 120);
  }catch(e){
    console.error("Error in miniGPT:", e);
    addAI("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.");
  }
}
sendBtn.onclick = sendMessage;
inputEl.onkeydown = e => { if(e.key === "Enter") sendMessage(); };

/* ---------- voice TTS ---------- */
let voice=null;
function loadVoices(){
  const voices = speechSynthesis.getVoices();
  voice = voices.find(v=>v.lang==="ru-RU" && v.name && v.name.toLowerCase().includes("google")) ||
          voices.find(v=>v.lang==="ru-RU") || voices[0];
}
speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();
function speakText(text){
  if(!text) return;
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.voice = voice;
    u.rate = 1;
    u.pitch = 1.02;
    speechSynthesis.speak(u);
  }catch(e){
    console.warn("TTS error:", e);
  }
}

/* ---------- voice input ---------- */
voiceBtn.onclick = () => {
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!Rec) return alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥.");
  try{
    const r = new Rec();
    r.lang = "ru-RU";
    r.interimResults = false;
    r.maxAlternatives = 1;
    r.onresult = e => {
      const text = e.results[0][0].transcript;
      inputEl.value = text;
      sendMessage();
    };
    r.onerror = e => { console.warn("SpeechRecognition error", e); alert("–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞: " + (e.error || "unknown")); };
    r.start();
  }catch(e){
    alert("–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞.");
  }
};

/* ---------- utilities ---------- */
function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase() + s.slice(1); }
function escapeHtml(u){ if(u==null) return ""; return String(u).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

/* ---------- dev utilities ---------- */
// localStorage.removeItem('chat_widget_memory_v1');

/* ================= done ================= */
</script>
</body>
</html>
