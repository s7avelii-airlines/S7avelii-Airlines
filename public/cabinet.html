<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>s7avelii | Профиль</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Точные мелкие правки для компактности */
    .card-radius { border-radius:14px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
    /* Уменьшаем вертикальные отступы для точного сходства */
    .tight > * { margin-top: 0.25rem; margin-bottom: 0.25rem; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-start justify-center py-6">
  <div class="w-full max-w-md px-4">

    <!-- header: avatar + name + edit -->
    <div class="relative flex flex-col items-center mb-2">
      <label for="avatarInput" class="cursor-pointer" title="Нажмите чтобы загрузить аватар">
        <div id="avatarWrap" class="w-20 h-20 rounded-full bg-white shadow-md border border-gray-100 overflow-hidden flex items-center justify-center">
          <img id="avatar" src="" alt="avatar" class="w-full h-full object-cover hidden">
          <div id="avatarInitial" class="text-2xl font-extrabold text-gray-900">А</div>
        </div>
      </label>
      <input id="avatarInput" type="file" accept="image/*" class="hidden">

      <div class="mt-2 text-center">
        <div id="fioHeader" class="text-2xl font-extrabold tracking-tight">ИМЯ Ф.</div>
      </div>

      <button id="editProfile" class="absolute right-0 top-0 -translate-y-1/4 bg-white p-2 rounded-full shadow border border-gray-100" title="Редактировать">
        ✎
      </button>
    </div>

    <!-- top grid -->
    <div class="grid grid-cols-2 gap-3">
      <div class="bg-white card-radius p-3 shadow-sm">
        <div class="text-xs text-gray-500">S7avelii Priority</div>
        <div id="card_field" class="mono text-sm font-semibold mt-1 text-gray-800">—</div>
      </div>

      <div class="bg-white card-radius p-3 shadow-sm">
        <div class="text-xs text-gray-500">Начисления / Списания</div>
        <div class="text-sm font-semibold mt-1 text-gray-800"></div>
      </div>

      <!-- compact balance -->
      <div class="bg-white card-radius p-4 shadow-sm col-span-2">
        <div class="text-center tight">
          <div class="text-xs text-gray-500">ваш баланс</div>
          <div id="bonusMiles" class="text-xl font-extrabold mt-1 text-gray-900">0</div>
          <div class="mx-auto mt-2 w-10 h-10 bg-lime-400 rounded-md flex items-center justify-center font-bold text-white">M</div>
        </div>
      </div>

      <div class="bg-white card-radius p-3 shadow-sm">
        <div class="text-xs text-gray-500">Управлять</div>
        <div class="text-sm font-semibold mt-1 text-gray-900">МИЛЯМИ</div>
      </div>

      <div class="bg-transparent"></div>
    </div>

    <!-- status -->
    <div class="bg-white card-radius p-4 mt-3 shadow-sm">
      <div class="flex justify-between items-center">
        <div class="text-sm text-gray-600">Статус</div>
        <div id="cardTypeField" class="text-sm text-gray-600">—</div>
      </div>
      <div class="w-full bg-gray-200 h-3 rounded-full mt-3 overflow-hidden">
        <div id="milesProgressBar" class="h-full bg-lime-400 w-0"></div>
      </div>
    </div>

    <!-- promo -->
    <button id="openPromo" class="mt-4 w-full bg-black text-white py-3 rounded-2xl font-bold">Добавить промокод</button>

    <!-- list items (icons are replaceable in /icons) -->
    <div class="mt-4 space-y-2">
      <button id="item-plus" class="w-full bg-white card-radius p-3 flex items-center gap-3 shadow-sm justify-start">
        <div class="w-10 h-10 bg-gray-100 rounded-md flex items-center justify-center overflow-hidden">
          <img id="icon-plus" src="/icons/plus.svg" alt="plus" class="w-8 h-8 object-contain">
        </div>
        <div class="text-sm text-gray-900">Яндекс Плюс x S7</div>
      </button>

      <button id="item-mystery" class="w-full bg-white card-radius p-3 flex items-center gap-3 shadow-sm justify-start">
        <div class="w-10 h-10 bg-gray-100 rounded-md flex items-center justify-center overflow-hidden">
          <img id="icon-mystery" src="/icons/mystery.svg" alt="mystery" class="w-8 h-8 object-contain">
        </div>
        <div class="text-sm text-gray-900">Тайный пассажир</div>
      </button>

      <button id="item-green" class="w-full bg-white card-radius p-3 flex items-center gap-3 shadow-sm justify-start">
        <div class="w-10 h-10 bg-gray-100 rounded-md flex items-center justify-center overflow-hidden">
          <img id="icon-green" src="/icons/green.svg" alt="green" class="w-8 h-8 object-contain">
        </div>
        <div class="text-sm text-gray-900">Green Steps</div>
      </button>
    </div>

  </div>

  <!-- Promo modal -->
  <div id="promoModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
    <div class="bg-white rounded-2xl p-4 w-11/12 max-w-sm">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-semibold">Добавить промокод</h3>
        <button id="promoClose" class="text-gray-500 font-bold">✕</button>
      </div>
      <p class="text-sm text-gray-500 mt-2">Вставьте промокод, чтобы добавить мили.</p>
      <div class="mt-3 flex gap-2">
        <input id="promoInput" class="flex-1 border border-gray-200 p-2 rounded-md" placeholder="PROMOCODE">
        <button id="promoActivateBtn" class="bg-lime-400 px-3 rounded-md font-semibold">Применить</button>
      </div>
      <div id="promoResult" class="text-sm text-gray-600 mt-2"></div>
    </div>
  </div>

  <!-- Info modal -->
  <div id="infoModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
    <div class="bg-white rounded-2xl p-4 w-11/12 max-w-sm">
      <div class="flex justify-between items-center">
        <h3 id="infoTitle" class="text-lg font-semibold">Заголовок</h3>
        <button id="infoClose" class="text-gray-500 font-bold">✕</button>
      </div>
      <div id="infoBody" class="text-sm text-gray-600 mt-2">Контент...</div>
      <div class="mt-4 flex justify-end">
        <button id="infoOk" class="px-4 py-2 bg-lime-400 rounded-md text-white font-semibold">ОК</button>
      </div>
    </div>
  </div>

<script>
/* ==========================
   apiFetch (твоё поведение)
   ========================== */
const API = "https://s7avelii-airlines-1.onrender.com"; // базовый хост
function getToken(){ return localStorage.getItem('token'); }

async function apiFetch(endpoint, options = {}) {
  const token = getToken();
  options.headers = { ...(options.headers || {}) };
  if (token) options.headers['Authorization'] = 'Bearer ' + token;
  if (options.body && !(options.body instanceof FormData) && typeof options.body !== 'string') {
    options.headers['Content-Type'] = 'application/json';
    options.body = JSON.stringify(options.body);
  }
  try {
    const res = await fetch(API + endpoint, options);
    if (!res) return null;
    if (res.status === 401) { logout(); return null; }
    const txt = await res.text();
    try { return JSON.parse(txt); } catch(e) { return { raw: txt, status: res.status }; }
  } catch (e) {
    console.error('fetch err', e);
    return null;
  }
}

/* ==========================
   State + element refs
   ========================== */
let currentUser = null;
const EL = {
  avatar: document.getElementById('avatar'),
  avatarInitial: document.getElementById('avatarInitial'),
  avatarInput: document.getElementById('avatarInput'),
  fioHeader: document.getElementById('fioHeader'),
  card_field: document.getElementById('card_field'),
  bonusMiles: document.getElementById('bonusMiles'),
  milesProgressBar: document.getElementById('milesProgressBar'),
  cardTypeField: document.getElementById('cardTypeField'),
  openPromo: document.getElementById('openPromo'),
  promoModal: document.getElementById('promoModal'),
  promoClose: document.getElementById('promoClose'),
  promoInput: document.getElementById('promoInput'),
  promoActivateBtn: document.getElementById('promoActivateBtn'),
  promoResult: document.getElementById('promoResult'),
  infoModal: document.getElementById('infoModal'),
  infoClose: document.getElementById('infoClose'),
  infoTitle: document.getElementById('infoTitle'),
  infoBody: document.getElementById('infoBody'),
  infoOk: document.getElementById('infoOk'),
  itemPlus: document.getElementById('item-plus'),
  itemMystery: document.getElementById('item-mystery'),
  itemGreen: document.getElementById('item-green'),
};

/* ==========================
   PROMOS fallback (твой ранее)
   ========================== */
const PROMOS = {
  'S717000': 17000,
  'WELCOME500': 500,
  'VIP2025': 2000,
  '2025': 4000,
  'S2025': 3000,
  'TAKE_OFFF500': 500,
  'LANDING500': 500,
};

/* ==========================
   Init
   ========================== */
document.addEventListener('DOMContentLoaded', () => {
  // avatar upload
  EL.avatarInput.addEventListener('change', onAvatarSelected);

  // promo modal
  document.getElementById('openPromo').addEventListener('click', () => show(EL.promoModal));
  EL.promoClose.addEventListener('click', () => hide(EL.promoModal));
  EL.promoActivateBtn.addEventListener('click', applyPromo);
  EL.promoInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') applyPromo(); });

  // info modals
  EL.itemPlus.addEventListener('click', ()=> openInfo('Яндекс Плюс x S7', '<p>Здесь можно вставить любой HTML / картинку — замени /icons/plus.svg</p>'));
  EL.itemMystery.addEventListener('click', ()=> openInfo('Тайный пассажир', '<p>Инфо о Тайном пассажире.</p>'));
  EL.itemGreen.addEventListener('click', ()=> openInfo('Green Steps', '<p>Инфо о Green Steps.</p>'));
  EL.infoClose.addEventListener('click', ()=> hide(EL.infoModal));
  EL.infoOk.addEventListener('click', ()=> hide(EL.infoModal));

  // load profile
  (async ()=>{
    const token = getToken();
    if(!token){ console.warn('Нет токена в localStorage; положи token в localStorage и перезагрузи: localStorage.setItem(\"token\",\"ВАШ_ТОКЕН\")'); return; }
    await loadProfile();
  })();
});

/* ==========================
   Load profile from API
   ========================== */
async function loadProfile(){
  const data = await apiFetch('/api/profile');
  if(!data){ console.warn('profile fetch failed'); return; }
  currentUser = data;
  renderProfile();
}

/* ==========================
   Render profile values
   ========================== */
function renderProfile(){
  if(!currentUser) return;
  const fioRaw = (currentUser.fio || '').trim();
  const parts = fioRaw.split(/\s+/);
  const name = parts[0] || '';
  const initial = parts[1] ? parts[1].slice(0,1) + '.' : '';
  EL.fioHeader.textContent = (name + (initial ? ' ' + initial : '')).trim();

  // avatar
  if(currentUser.avatar){
    const url = currentUser.avatar.startsWith('http') ? currentUser.avatar : (API + currentUser.avatar);
    EL.avatar.src = url; EL.avatar.classList.remove('hidden'); EL.avatarInitial.style.display = 'none';
  } else {
    EL.avatar.classList.add('hidden'); EL.avatarInitial.style.display = 'block';
    EL.avatarInitial.textContent = (name ? name[0].toUpperCase() : 'А');
  }

  // card number
  EL.card_field.textContent = currentUser.card_number || '—';

  // bonus miles
  EL.bonusMiles.textContent = Number(currentUser.bonus_miles || currentUser.bonus_miles === 0 ? currentUser.bonus_miles : (currentUser.bonus_miles || 0)).toLocaleString('ru-RU');

  // status + progress
  EL.cardTypeField.textContent = currentUser.card_type || currentUser.status || '—';
  const percent = Math.min(100, Math.round((Number(currentUser.status_miles || 0) / 1000) * 100));
  if (EL.milesProgressBar) EL.milesProgressBar.style.width = percent + '%';
}

/* ==========================
   Avatar upload -> PUT /api/profile or POST /api/profile/avatar
   ========================== */
async function onAvatarSelected(e){
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => { EL.avatar.src = reader.result; EL.avatar.classList.remove('hidden'); EL.avatarInitial.style.display = 'none'; };
  reader.readAsDataURL(f);

  const fd = new FormData();
  fd.append('avatar', f);
  const token = getToken();

  try {
    // try PUT /api/profile with FormData (some backends accept)
    const tryPut = await fetch(API + '/api/profile', {
      method: 'PUT',
      headers: token ? { 'Authorization': 'Bearer ' + token } : undefined,
      body: fd
    });
    if (tryPut && (tryPut.status === 200 || tryPut.status === 204)) { await loadProfile(); return; }

    // fallback POST /api/profile/avatar
    const tryPost = await fetch(API + '/api/profile/avatar', {
      method: 'POST',
      headers: token ? { 'Authorization': 'Bearer ' + token } : undefined,
      body: fd
    });
    if (tryPost && (tryPost.status === 200 || tryPost.status === 201 || tryPost.status === 204)) { await loadProfile(); return; }

    alert('Ошибка загрузки аватара (сервер вернул ошибку).');
    await loadProfile();
  } catch (err) {
    console.error('avatar upload', err);
    alert('Ошибка сети при загрузке аватара');
    await loadProfile();
  }
}

/* ==========================
   Apply promo: try server POST /api/promo, else fallback to PUT /api/profile
   ========================== */
async function applyPromo(){
  const code = (EL.promoInput.value || '').trim().toUpperCase();
  EL.promoResult.textContent = '';
  if(!code){ EL.promoResult.textContent = 'Введите промокод'; return; }

  EL.promoActivateBtn.disabled = true;
  EL.promoResult.textContent = 'Отправка...';

  try {
    // try server endpoint first
    const res = await apiFetch('/api/promo', { method: 'POST', body: { code } });
    if (res && (res.success === true || res.ok === true || res.user)) {
      await loadProfile();
      EL.promoResult.textContent = (res.message) ? res.message : 'Промокод применён';
      setTimeout(()=>{ hide(EL.promoModal); EL.promoResult.textContent = ''; EL.promoInput.value = ''; }, 900);
      return;
    }

    // fallback: local PROMOS mapping and PUT /api/profile (as in твой скрипт)
    if (PROMOS[code]) {
      const add = Number(PROMOS[code]);
      const used = Array.isArray(currentUser?.used_promos) ? currentUser.used_promos : [];
      if (used.includes(code)) { EL.promoResult.textContent = 'Промокод уже использован'; EL.promoActivateBtn.disabled = false; return; }

      const payload = {
        bonus_miles: (Number(currentUser.bonus_miles || 0) + add),
        status_miles: (Number(currentUser.status_miles || 0) + add),
        used_promos: [...used, code]
      };
      const putRes = await apiFetch('/api/profile', { method: 'PUT', body: payload });
      if (putRes) {
        await loadProfile();
        EL.promoResult.textContent = `Промокод применён, +${add} миль`;
        setTimeout(()=>{ hide(EL.promoModal); EL.promoResult.textContent=''; EL.promoInput.value=''; }, 900);
      } else EL.promoResult.textContent = 'Ошибка сервера при применении';
    } else {
      EL.promoResult.textContent = (res && res.message) ? res.message : 'Неверный промокод';
    }
  } catch (err) {
    console.error('promo err', err);
    EL.promoResult.textContent = 'Ошибка сети';
  } finally {
    EL.promoActivateBtn.disabled = false;
  }
}

/* ==========================
   Modal helpers & info
   ========================== */
function openInfo(title, html){
  EL.infoTitle.textContent = title;
  EL.infoBody.innerHTML = html;
  show(EL.infoModal);
}
function show(node){ if(!node) return; node.classList.remove('hidden'); node.style.display = 'flex'; }
function hide(node){ if(!node) return; node.classList.add('hidden'); node.style.display = 'none'; }

/* ==========================
   Logout helper
   ========================== */
function logout(){ localStorage.removeItem('token'); location.reload(); }
</script>
</body>
</html>
