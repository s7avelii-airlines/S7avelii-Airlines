<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äî Miles</title>
<style>
:root{
  --bg:#f5f7fa; --card:#fff; --accent:#d9f65f; --accent-2:#c6e44e; --muted:#8b94a3; --btn:#2b2f36;
  font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
}
html,body{height:100%;margin:0;background:var(--bg);color:#111}
.wrap{max-width:420px;margin:0 auto;padding:18px}
.header{display:flex;align-items:center;gap:12px;margin-top:18px;margin-bottom:8px}
.avatar{width:76px;height:76px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;margin:0 auto;box-shadow:0 8px 24px rgba(18,22,32,0.06)}
.avatar img{width:100%;height:100%;object-fit:cover}
.name-big{font-size:40px;font-weight:800;text-align:center;margin-top:8px;letter-spacing:1px}
.top-right-edit{position:fixed;right:18px;top:18px;width:36px;height:36px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:18px}
.card{background:var(--card);padding:14px;border-radius:14px;box-shadow:0 6px 18px rgba(12,18,36,0.03);min-height:72px}
.small{font-size:13px;color:var(--muted);margin-bottom:8px}
.mono{font-family:monospace}
.balance-wide{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;padding:16px}
.balance-amount{font-size:20px;font-weight:700}
.balance-icon{width:52px;height:52px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 8px 26px rgba(200,220,80,0.12)}
.status-card{margin-top:14px;background:var(--card);padding:14px;border-radius:14px;box-shadow:0 6px 18px rgba(12,18,36,0.03)}
.status-line{height:12px;background:#eef2f5;border-radius:999px;overflow:hidden;margin-top:10px}
.status-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:10%}
.big-button{margin-top:18px;background:var(--btn);color:#fff;border:none;padding:16px;border-radius:12px;width:100%;font-size:20px;font-weight:800;cursor:pointer;box-shadow:0 8px 22px rgba(15,18,20,0.12)}
.telegram{margin-top:14px;background:linear-gradient(180deg,#2e3a52,#33425b);color:white;padding:14px;border-radius:12px;display:flex;gap:12px;align-items:center}
.telegram .circle{width:64px;height:64px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;color:#111}
.list{margin-top:12px;border-radius:12px;overflow:hidden}
.list .item{background:var(--card);padding:14px;border-bottom:1px solid #f1f3f6;display:flex;align-items:center;gap:12px}
.list .item:last-child{border-bottom:none}
.icon-box{width:44px;height:44px;border-radius:8px;background:#f3f6f8;display:flex;align-items:center;justify-content:center}
.center{text-align:center}
.muted{color:var(--muted)}
/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:100}
.modal{background:var(--card);padding:18px;border-radius:12px;width:92%;max-width:420px}
.input-row{display:flex;gap:8px;margin-top:12px}
.input-row input{flex:1;padding:12px;border-radius:10px;border:1px solid #eef2f5}
.input-row button{padding:12px 14px;border-radius:10px;border:none;background:#2b6df6;color:#fff;cursor:pointer}
.close-x{position:absolute;top:14px;right:18px;cursor:pointer;color:#888}
/* responsive */
@media (max-width:420px){ .name-big{font-size:36px} .avatar{width:64px;height:64px} .balance-icon{width:44px;height:44px} }
</style>
</head>
<body>
  <div class="top-right-edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</div>

  <div class="wrap">
    <div class="center">
      <div class="avatar" id="avatarWrap">
        <img id="avatarImg" src="" alt="avatar" style="display:none" />
        <div id="avatarInitial" style="font-size:28px;font-weight:800">–ê</div>
      </div>
      <div class="name-big" id="fioName">–ò–ú–Ø</div>
    </div>

    <div class="grid" style="margin-top:18px">
      <div class="card">
        <div class="small">S7 Priority</div>
        <div class="mono" id="card_number">‚Äî</div>
      </div>

      <div class="card">
        <div class="small">–ù–∞—á–∏—Å–ª–µ–Ω–∏—è<br>–°–ø–∏—Å–∞–Ω–∏—è</div>
      </div>

      <div class="card balance-wide" style="grid-column:1/-1">
        <div>
          <div class="small">–≤–∞—à –±–∞–ª–∞–Ω—Å</div>
          <div class="balance-amount" id="bonus_miles">0</div>
        </div>
        <div class="balance-icon">M</div>
      </div>

      <div class="card">
        <div class="small">–£–ø—Ä–∞–≤–ª—è—Ç—å</div>
        <div class="small">–º–∏–ª—è–º–∏</div>
      </div>
    </div>

    <div class="status-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="muted">–°—Ç–∞—Ç—É—Å</div>
        <div id="status_text" class="muted">–û —Å—Ç–∞—Ç—É—Å–µ</div>
      </div>
      <div class="status-line"><div id="status_fill" class="status-fill" style="width:20%"></div></div>
    </div>

    <button class="big-button" id="openPromoBtn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>

    <div class="telegram">
      <div class="circle">‚úà</div>
      <div>
        <div style="font-weight:700">–ù–∞—à –±–æ—Ç –≤ –¢–µ–ª–µ–≥—Ä–∞–º–µ</div>
        <div style="font-size:13px;opacity:0.95">–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å –æ —Å—Ç–∞—Ç—É—Å–µ —Ä–µ–π—Å–∞</div>
      </div>
    </div>

    <div class="list">
      <div class="item"><div class="icon-box">–Ø</div><div>–Ø–Ω–¥–µ–∫—Å –ü–ª—é—Å x S7</div></div>
      <div class="item"><div class="icon-box">–ü</div><div>–¢–∞–π–Ω—ã–π –ø–∞—Å—Å–∞–∂–∏—Ä</div></div>
      <div class="item"><div class="icon-box">üçÉ</div><div>Green Steps</div></div>
    </div>
  </div>

  <!-- modal –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
  <div class="modal-backdrop" id="modal">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="position:relative">
        <div class="close-x" id="closeModal">‚úï</div>
        <h3>–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥</h3>
        <div class="muted">–ü—Ä–æ–º–æ–∫–æ–¥ –¥–æ–±–∞–≤–∏—Ç –º–∏–ª–∏ –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å.</div>
        <div class="input-row">
          <input id="promoInput" placeholder="–ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞" />
          <button id="promoActivateBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div id="promoResult" class="muted" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

<script>
/* ----- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API (—Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä) ----- */
const API = "https://s7avelii-airlines-1.onrender.com";
function getToken(){ return localStorage.getItem('token'); }

/* ========== apiFetch (–∫–∞–∫ –≤ —Ç–≤–æ—ë–º —Å–∫—Ä–∏–ø—Ç–µ) ========== */
async function apiFetch(endpoint, options = {}) {
  const token = getToken();
  options.headers = { ...(options.headers || {}) };
  if (token) options.headers['Authorization'] = 'Bearer ' + token;
  if (options.body && !(options.body instanceof FormData) && typeof options.body !== 'string') {
    options.headers['Content-Type'] = 'application/json';
    options.body = JSON.stringify(options.body);
  }
  try {
    const res = await fetch(API + endpoint, options);
    if (!res) return null;
    if (res.status === 401) { logout(); return null; }
    const txt = await res.text();
    try { return JSON.parse(txt); } catch(e) { return { raw: txt, status: res.status }; }
  } catch (e) {
    console.error('fetch err', e);
    return null;
  }
}

/* ====== STATE ====== */
let currentUser = null;

/* ====== UI elements ====== */
const sel = {
  fioName: document.getElementById('fioName'),
  avatarImg: document.getElementById('avatarImg'),
  avatarInitial: document.getElementById('avatarInitial'),
  card_number: document.getElementById('card_number'),
  bonus_miles: document.getElementById('bonus_miles'),
  status_text: document.getElementById('status_text'),
  status_fill: document.getElementById('status_fill'),
  openPromoBtn: document.getElementById('openPromoBtn'),
  modal: document.getElementById('modal'),
  closeModal: document.getElementById('closeModal'),
  promoInput: document.getElementById('promoInput'),
  promoActivateBtn: document.getElementById('promoActivateBtn'),
  promoResult: document.getElementById('promoResult')
};

/* ====== PROMOS (–∫–∞–∫ –≤ —Ç–≤–æ—ë–º –∫–æ–¥–µ) ====== */
const PROMOS = {
  'S717000': 17000,
  'WELCOME500': 500,
  'VIP2025': 2000,
  '2025': 4000,
  'S2025': 3000,
  'TAKE_OFFf500': 500,
  'LANDING500': 500,
};

/* ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ====== */
document.addEventListener('DOMContentLoaded', () => {
  // handlers
  sel.openPromoBtn.addEventListener('click', ()=> sel.modal.style.display='flex');
  sel.closeModal.addEventListener('click', closeModal);
  sel.promoActivateBtn.addEventListener('click', handleActivatePromo);
  sel.promoInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleActivatePromo(); });
  sel.modal.addEventListener('click', (e)=>{ if(e.target === sel.modal) closeModal(); });

  (async ()=>{
    const token = getToken();
    if(!token){ alert('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –≤ localStorage. –í—ã–ø–æ–ª–Ω–∏ login –∏ –ø–æ–ª–æ–∂–∏ token.'); return; }
    await loadProfile();
  })();
});

/* ====== –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è ====== */
async function loadProfile(){
  const user = await apiFetch('/api/profile');
  if(!user){ console.warn('profile fetch failed'); return; }
  currentUser = user;
  renderProfile();
}

/* ====== –û—Ç—Ä–∏—Å–æ–≤–∫–∞ ====== */
function renderProfile(){
  if(!currentUser) return;
  // –§–ò–û: –∏–º—è + –ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞ —Ñ–∞–º–∏–ª–∏–∏
  let fio = currentUser.fio || currentUser.name || '';
  let first = fio.split(' ')[0] || fio;
  let initial = (fio.split(' ')[1] || '').slice(0,1) || '';
  sel.fioName.textContent = (first + (initial ? ' ' + initial + '.' : '')).toUpperCase();

  // avatar
  if(currentUser.avatar){
    const u = currentUser.avatar.startsWith('http') ? currentUser.avatar : (API + currentUser.avatar);
    sel.avatarImg.src = u; sel.avatarImg.style.display='block'; sel.avatarInitial.style.display='none';
  } else {
    sel.avatarImg.style.display='none'; sel.avatarInitial.style.display='block';
    sel.avatarInitial.textContent = (first ? first[0].toUpperCase() : '–ê');
  }

  // card number
  sel.card_number.textContent = currentUser.card_number || '‚Äî';

  // miles
  sel.bonus_miles.textContent = (currentUser.bonus_miles || 0).toLocaleString('ru-RU');

  // status
  const statusText = currentUser.card_type || currentUser.status || '–û —Å—Ç–∞—Ç—É—Å–µ';
  sel.status_text.textContent = statusText;
  const percent = Number(currentUser.status_miles || 0) / 1000 * 100;
  sel.status_fill.style.width = Math.min(100, Math.max(0, percent)) + '%';
}

/* ====== –ü—Ä–æ–º–æ–∫–æ–¥: –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–∫ –≤ —Ç–≤–æ—ë–º —Å–∫—Ä–∏–ø—Ç–µ (PUT /api/profile) ====== */
async function handleActivatePromo(){
  const code = (sel.promoInput.value||'').trim().toUpperCase();
  if(!code){ sel.promoResult.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥'; return; }
  if(!PROMOS[code]){ sel.promoResult.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥'; return; }
  // –ø—Ä–æ–≤–µ—Ä–∏–º used_promos –≤ currentUser
  const used = Array.isArray(currentUser?.used_promos) ? currentUser.used_promos : [];
  if(used.includes(code)){ sel.promoResult.textContent = '–ü—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω'; return; }

  const add = Number(PROMOS[code] || 0);
  const payload = {
    bonus_miles: (Number(currentUser.bonus_miles || 0) + add),
    status_miles: (Number(currentUser.status_miles || 0) + add),
    used_promos: [...used, code]
  };

  sel.promoActivateBtn.disabled = true;
  sel.promoResult.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

  const res = await apiFetch('/api/profile', { method: 'PUT', body: payload });
  sel.promoActivateBtn.disabled = false;

  if(!res){ sel.promoResult.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'; return; }
  // –æ–±–Ω–æ–≤–∏–º currentUser: –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª –ø—Ä–æ—Ñ–∏–ª—å
  const updated = await apiFetch('/api/profile');
  if(updated && (updated.fio || updated.id || updated.email)) currentUser = updated;
  else {
    // –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª, –ø—Ä–∏–º–µ–Ω–∏–º –ª–æ–∫–∞–ª—å–Ω–æ
    currentUser.bonus_miles = payload.bonus_miles;
    currentUser.status_miles = payload.status_miles;
    currentUser.used_promos = payload.used_promos;
  }
  renderProfile();
  sel.promoResult.textContent = `–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω, +${add} –º–∏–ª—å`;
  setTimeout(()=>{ closeModal(); sel.promoResult.textContent=''; sel.promoInput.value=''; }, 1000);
}

/* ====== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ====== */
function closeModal(){
  if(sel.modal) sel.modal.style.display = 'none';
}

/* ====== logout ====== */
function logout(){ localStorage.removeItem('token'); location.reload(); }
</script>
</body>
</html>
