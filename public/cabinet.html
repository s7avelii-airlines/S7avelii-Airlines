<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Кабинет — S7avelii</title>
  <style>
    :root { --bg:#f5f7fa;--card:#fff;--accent:#9cc42f;--muted:#8b97a6;--container:1180px }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#1f2937}
    .page{max-width:var(--container);margin:28px auto;padding:0 20px}
    .full-header{width:100%;background:var(--card);display:flex;align-items:center;gap:24px;padding:28px 36px;border-radius:12px;box-shadow:0 6px 20px rgba(16,24,40,0.06);flex-wrap:wrap}
    .avatar{width:118px;height:118px;border-radius:999px;object-fit:cover;border:4px solid #fff}
    .card-badge{width:60px;display:none}
    .tabs{display:flex;gap:14px;margin-top:18px;padding:12px 0;border-bottom:1px solid rgba(0,0,0,0.04);overflow-x:auto}
    .tabs a{padding:10px 14px;text-decoration:none;color:#495057;border-radius:8px}
    .tabs a.active{color:var(--accent);background:rgba(156,196,47,0.06)}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:22px;margin-top:18px}
    .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(16,24,40,0.04)}
    .field{display:flex;justify-content:space-between;padding:12px 0;border-top:1px solid rgba(0,0,0,0.03)}
    .small-muted{color:var(--muted);font-size:13px}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    /* cart table */
    .cart-table{width:100%;border-collapse:collapse}
    .cart-table th,.cart-table td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .cart-empty{color:#777;padding:12px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="page">
  <div class="full-header">
    <div style="display:flex;align-items:center;gap:16px">
      <label for="avatarInput"><img id="avatar" class="avatar" src="https://via.placeholder.com/150" alt="avatar"></label>
      <input id="avatarInput" type="file" accept="image/*" style="display:none">
      <div>
        <h1 id="fioHeader">Загрузка...</h1>
        <div class="small-muted" id="phoneHeader">—</div>
      </div>
    </div>
    <div style="margin-left:auto" class="small-muted">Бонусные мили: <strong id="bonusMiles">—</strong></div>
  </div>

  <div class="tabs" role="tablist">
    <a href="#" class="active" data-tab="profileTab" onclick="showTab(event)">Профиль</a>
    <a href="#" data-tab="milesTab" onclick="showTab(event)">Мои мили</a>
    <a href="#" data-tab="shopTab" onclick="showTab(event)">S7avelii Shop</a>
    <a href="#" data-tab="settingsTab" onclick="showTab(event)">Настройки</a>
  </div>

  <div class="grid">
    <div>
      <div id="profileTab" class="card">
        <h3>Персональные данные</h3>
        <div class="field"><div><div class="small-muted">ФИО</div><div id="fioField">—</div></div><button class="btn" onclick="enableEdit('fio')">Изменить</button></div>
        <div class="field"><div><div class="small-muted">Дата рождения</div><div id="dobField">—</div></div><button class="btn" onclick="enableEdit('dob')">Изменить</button></div>
        <div class="field"><div><div class="small-muted">Пол</div><div id="genderField">—</div></div><button class="btn" onclick="enableEdit('gender')">Изменить</button></div>

        <h3 style="margin-top:16px">Контакты</h3>
        <div class="field"><div><div class="small-muted">Email</div><div id="emailField">—</div></div><button class="btn" onclick="enableEdit('email')">Изменить</button></div>
        <div class="field"><div><div class="small-muted">Телефон</div><div id="phoneField">—</div></div><button class="btn" onclick="enableEdit('phone')">Изменить</button></div>

        <h3 style="margin-top:16px">Карта</h3>
        <div class="field"><div><div class="small-muted">Номер карты</div><div id="cardField">—</div></div><button class="btn" onclick="enableEdit('cardNumber')">Изменить</button></div>
        <div class="field"><div><div class="small-muted">Тип карты</div><div id="cardTypeField">—</div></div></div>
      </div>

      <!-- Shop tab content -->
      <div id="shopTab" class="card" style="display:none">
        <h3>Корзина</h3>
        <div id="cartContainer">
          <div class="cart-empty">Загрузка корзины...</div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="checkoutBtn" onclick="checkout()" disabled>Оформить заказ</button>
          <button class="btn" id="clearCartBtn" onclick="clearCart()" style="background:#999">Очистить корзину</button>
        </div>
        <div id="cartMsg" class="small-muted" style="margin-top:8px"></div>
      </div>

    </div>

    <div>
      <div class="card">
        <h3>Быстрые действия</h3>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn" onclick="goTo('profileTab')">Редактировать профиль</button>
          <button class="btn" onclick="goTo('shopTab')">Открыть корзину</button>
          <button class="btn" onclick="logout()" style="background:#e66">Выйти</button>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Заказы</h3>
        <div id="ordersContainer" class="small-muted" style="margin-top:8px">Загрузка...</div>
      </div>
    </div>
  </div>
</div>

<script>
function el(id){return document.getElementById(id)}

function showTab(evt){
  evt && evt.preventDefault();
  const tabId = evt ? evt.currentTarget.getAttribute('data-tab') : 'profileTab';
  document.querySelectorAll('.tabs a').forEach(a=>a.classList.remove('active'));
  if(evt) evt.currentTarget.classList.add('active');
  ['profileTab','milesTab','shopTab','settingsTab'].forEach(id=>{
    const elc = el(id);
    if(elc) elc.style.display = (id===tabId ? 'block' : 'none');
  });
  // if opened shop tab - refresh cart
  if(tabId === 'shopTab') loadCart();
}

async function loadProfile(){
  try {
    const res = await fetch('/api/profile', { credentials: 'include' });
    if(!res.ok){
      // not logged in -> go to auth
      window.location.href = '/auth.html';
      return;
    }
    const j = await res.json();
    applyProfile(j.user || j);
  } catch (err) {
    console.error('loadProfile err', err);
    window.location.href = '/auth.html';
  }
}

function applyProfile(p){
  el('fioField').innerText = p.fio || '—';
  el('dobField').innerText = p.dob || '—';
  el('genderField').innerText = p.gender || '—';
  el('emailField').innerText = p.email || '—';
  el('phoneField').innerText = p.phone || '—';
  el('cardField').innerText = p.cardNumber || '—';
  el('cardTypeField').innerText = p.cardType || '—';
  el('fioHeader').innerText = p.fio || 'Пользователь';
  el('bonusMiles').innerText = p.bonusMiles || '—';
  if(p.avatar) el('avatar').src = p.avatar;
  // orders
  renderOrders(p.orders || []);
}

function renderOrders(orders){
  const o = el('ordersContainer');
  if(!orders || !orders.length) { o.innerText = 'Заказы отсутствуют'; return; }
  o.innerHTML = '';
  orders.slice().reverse().forEach(ord=>{
    const div = document.createElement('div');
    div.style.marginBottom='10px';
    div.innerHTML = `<strong>Заказ ${ord.id}</strong> — ${new Date(ord.createdAt).toLocaleString()} — ${ord.status}<br>
      Товаров: ${ord.items.length} — Сумма: ${formatTotal(ord.total)}`;
    o.appendChild(div);
  });
}

function formatTotal(t){ return (isNaN(t) ? t : t + ' ₽'); }

/* inline edit (same as before) */
function enableEdit(field){
  const map = { fio:['fioField','fioHeader'], dob:['dobField'], gender:['genderField'], email:['emailField'], phone:['phoneField','phoneHeader'], cardNumber:['cardField'] };
  const ids = map[field]; if(!ids) return;
  const cur = el(ids[0]).innerText==='—'?'':el(ids[0]).innerText;
  const input = document.createElement('input'); input.value = cur; input.style.width='220px';
  const ok = document.createElement('button'); ok.innerText='OK'; ok.className='btn'; ok.style.marginLeft='8px';
  const wrapper = document.createElement('div'); wrapper.appendChild(input); wrapper.appendChild(ok);
  const container = el(ids[0]); container.innerHTML=''; container.appendChild(wrapper); input.focus();
  ok.onclick = async () => {
    const val = input.value.trim() || '';
    // update UI
    ids.forEach(id=>{ if(el(id)) el(id).innerText = val || '—'; });
    if(field === 'fio' && el('fioHeader')) el('fioHeader').innerText = val || 'Пользователь';
    // send to server
    try {
      const body = {};
      body[field] = val;
      const r = await fetch('/api/profile/update', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(body) });
      if(!r.ok) console.warn('update failed');
      else {
        const j = await r.json();
        if(j.user) applyProfile(j.user);
      }
    } catch(e){ console.error(e); }
  };
}

/* avatar upload */
el('avatarInput').addEventListener('change', function(){
  const f = this.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = async (e) => {
    const dataUrl = e.target.result;
    el('avatar').src = dataUrl;
    try {
      await fetch('/api/profile/update', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ avatar: dataUrl })});
    } catch(e){ console.error('avatar upload', e); }
  };
  r.readAsDataURL(f);
});

/* CART functions */
async function loadCart(){
  const container = el('cartContainer');
  container.innerHTML = '<div class="cart-empty">Загрузка корзины...</div>';
  try {
    const res = await fetch('/api/cart', { credentials: 'include' });
    if (!res.ok) {
      container.innerHTML = `<div class="cart-empty">Для работы корзины нужно войти — <a href="/auth.html">войти / зарегистрироваться</a></div>`;
      el('checkoutBtn').disabled = true;
      return;
    }
    const j = await res.json();
    const cart = j.cart || [];
    renderCart(cart);
  } catch (e) {
    container.innerHTML = `<div class="cart-empty">Ошибка сети</div>`;
    el('checkoutBtn').disabled = true;
  }
}

function renderCart(cart){
  const container = el('cartContainer');
  if(!cart || !cart.length){
    container.innerHTML = '<div class="cart-empty">Корзина пуста</div>';
    el('checkoutBtn').disabled = true;
    return;
  }
  const table = document.createElement('table');
  table.className = 'cart-table';
  table.innerHTML = `<thead><tr><th>Товар</th><th>Цена</th><th>Кол-во</th><th>Действие</th></tr></thead>`;
  const tbody = document.createElement('tbody');
  let total = 0;
  cart.forEach(item=>{
    const tr = document.createElement('tr');
    const priceNum = parseFloat((item.price||'').replace(/[^\d,.-]/g,'').replace(',','.')) || 0;
    total += priceNum * (item.qty || 1);
    tr.innerHTML = `<td><img src="${item.image||''}" style="width:48px;height:48px;object-fit:cover;margin-right:8px;vertical-align:middle"> ${item.title}</td>
      <td>${item.price}</td>
      <td>${item.qty || 1}</td>
      <td><button class="btn" data-id="${item.id}" onclick="removeFromCart('${item.id}')">Удалить</button></td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  const footer = document.createElement('div'); footer.style.marginTop='12px';
  footer.innerHTML = `<strong>Итого: ${formatTotal(total)}</strong>`;
  container.innerHTML = '';
  container.appendChild(table);
  container.appendChild(footer);
  el('checkoutBtn').disabled = false;
}

async function addToCartBackend(product){
  try {
    const res = await fetch('/api/cart/add', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(product) });
    if (!res.ok) {
      const d = await res.json();
      alert(d.error || 'Ошибка добавления в корзину');
      if (res.status === 401) window.location.href = '/auth.html';
      return;
    }
    const j = await res.json();
    // optional: show message
    alert('Товар добавлен в корзину');
    // if current tab is shopTab, refresh
    if (document.querySelector('.tabs a.active').getAttribute('data-tab') === 'shopTab') loadCart();
  } catch (e) {
    alert('Ошибка сети');
  }
}

async function removeFromCart(id){
  try {
    const res = await fetch('/api/cart/remove', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ id })});
    if (!res.ok) {
      const d = await res.json();
      alert(d.error || 'Ошибка удаления');
      return;
    }
    loadCart();
  } catch (e) {
    alert('Ошибка сети');
  }
}

async function clearCart(){
  if(!confirm('Очистить всю корзину?')) return;
  try {
    const res = await fetch('/api/cart/clear', { method:'POST', credentials:'include' });
    if (res.ok) {
      loadCart();
      el('cartMsg').innerText = 'Корзина очищена';
      setTimeout(()=> el('cartMsg').innerText = '', 2000);
    } else alert('Ошибка очистки');
  } catch(e){ alert('Ошибка сети'); }
}

async function checkout(){
  if(!confirm('Перейти к оформлению заказа?')) return;
  try {
    const res = await fetch('/api/cart/checkout', { method:'POST', credentials:'include' });
    const j = await res.json();
    if (!res.ok) {
      alert(j.error || 'Ошибка оформления');
      return;
    }
    loadCart();
    el('cartMsg').innerText = 'Заказ принят, спасибо!';
    // reload profile/orders
    setTimeout(()=> loadProfile(), 500);
  } catch(e){ alert('Ошибка сети'); }
}

/* redirect helpers */
function goTo(tab){ document.querySelectorAll('.tabs a').forEach(a=>a.classList.remove('active')); const a = [...document.querySelectorAll('.tabs a')].find(x=>x.getAttribute('data-tab')===tab); if(a) a.classList.add('active'); showTab({ currentTarget: a, preventDefault: ()=>{} }); }

/* logout */
async function logout(){
  try { await fetch('/api/logout', { method:'POST', credentials:'include' }); } catch(e){}
  window.location.href = '/auth.html';
}

/* INIT */
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadProfile();
  showTab({ currentTarget: document.querySelector('.tabs a.active'), preventDefault: ()=>{} });
  // expose addToCart for other pages (shop)
  window.addToCartBackend = addToCartBackend;
});
</script>
</body>
</html>
