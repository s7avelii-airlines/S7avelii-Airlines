<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>S7avelii | Профиль</title>
  <link rel="icon" href="images/favicon.png" type="image/png">

  <!-- Запасной шрифт Inter; при наличии S7 Sans подключи через @font-face -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ------------------------------
       Тема: S7-like (S7avelii)
       - Один файл: HTML + CSS + JS
       - Дизайн близкий к S7 (цвета, отступы, карточки, прогресс)
       - Адаптивность + мобильный гамбургер
       ------------------------------ */
    :root{
      --s7-green: #b7d12a;       /* фирменный акцент, ближе к S7 */
      --s7-green-2: #9cc42f;
      --muted: #6b7280;
      --bg: #f3f5f7;
      --card-bg: #ffffff;
      --shadow-strong: 0 8px 30px rgba(16,24,40,0.08);
      --shadow-soft: 0 6px 20px rgba(16,24,40,0.04);
      --radius: 14px;
      --max-width: 1180px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:"S7 Sans",Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:var(--bg);color:#0f1724;-webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Header */
    header{
      position:fixed;top:0;left:0;right:0;height:72px;display:flex;align-items:center;
      padding:0 18px;border-bottom:1px solid rgba(16,24,40,0.03);background:#fff;z-index:1200;
    }
    .header-left{display:flex;align-items:center;gap:14px}
    .logo-img{height:36px}
    .brand{font-weight:700;font-size:16px;color:#111}
    nav.header-nav{margin-left:18px}
    nav.header-nav ul{display:flex;gap:18px;margin:0;padding:0;list-style:none;align-items:center}
    nav.header-nav a{font-weight:600;color:#111;text-decoration:none;font-size:14px;opacity:0.95}
    .header-right{margin-left:auto;display:flex;align-items:center;gap:10px}

    /* home/profile small circle */
    .homeBtn{
      height:40px;padding:6px;border-radius:999px;border:1px solid rgba(16,24,40,0.06);
      background:#fff;display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:700;
    }

    /* mobile hamburger */
    .hamburger{display:none;background:transparent;border:0;padding:8px;border-radius:8px;cursor:pointer}
    .hamburger span{display:block;width:22px;height:2px;background:#111;margin:4px 0;border-radius:2px}

    /* Page container */
    .page{max-width:var(--max-width);margin:110px auto 60px;padding:0 18px}

    /* Top big card */
    .full-header{
      display:flex;align-items:center;gap:22px;padding:20px;border-radius:16px;
      background:var(--card-bg);box-shadow:var(--shadow-soft);border:1px solid rgba(16,24,40,0.03);
      flex-wrap:wrap;
    }
    .avatar{width:110px;height:110px;border-radius:999px;object-fit:cover;border:4px solid #fff;box-shadow:0 6px 18px rgba(16,24,40,0.06);cursor:pointer}
    .user-info{display:flex;flex-direction:column;gap:6px}
    .user-info h1{margin:0;font-size:22px;font-weight:800;color:#0b1720}
    .user-info .phone{color:var(--muted);font-size:14px}

    .chip{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(183,209,42,0.08);
      color:var(--s7-green);font-weight:700;font-size:13px;border:1px solid rgba(183,209,42,0.08)
    }

    /* right stats */
    .stats{margin-left:auto;min-width:320px;display:flex;flex-direction:column;gap:12px}
    .stat-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .stat-label{color:var(--muted);font-size:13px}
    .stat-value{font-weight:800;font-size:20px}

    .progress-wrap{width:100%}
    .progress-bg{width:100%;height:14px;background:#eef2f3;border-radius:999px;overflow:hidden}
    .progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--s7-green) 0%, var(--s7-green-2) 100%);transition:width .6s ease}
    .progress-meta{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:8px}

    /* Tabs */
    .tabs{display:flex;gap:12px;margin-top:18px;padding:8px 6px;align-items:center}
    .tabs a{padding:10px 14px;border-radius:10px;text-decoration:none;color:var(--muted);font-weight:700;cursor:pointer;font-size:14px}
    .tabs a.active{color:var(--s7-green);background:rgba(183,209,42,0.06)}

    /* Grid layout */
    .grid{display:grid;grid-template-columns:1fr 360px;gap:22px;margin-top:18px;align-items:start}
    .card{background:var(--card-bg);border-radius:12px;padding:18px;border:1px solid rgba(16,24,40,0.03);box-shadow:var(--shadow-soft)}
    h3{margin:0 0 10px 0;font-size:18px}

    .small-muted{color:var(--muted);font-size:13px}
    .muted{color:var(--muted);font-size:14px}

    .field{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-top:1px solid rgba(16,24,40,0.03)}
    .field:first-of-type{border-top:0;padding-top:6px}
    .label{font-size:13px;color:var(--muted)}
    .value{font-weight:700;color:#0f1724}

    .btn{
      background:linear-gradient(180deg,var(--s7-green) 0%, var(--s7-green-2) 100%);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:800;
      box-shadow:0 6px 18px rgba(167,197,49,0.12)
    }
    .btn.secondary{background:transparent;border:1px solid rgba(16,24,40,0.06);color:#111;padding:8px 12px;font-weight:700}
    .btn.red{background:#ef4453;color:#fff}

    /* shop items */
    .product-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .product-card{background:#fff;border-radius:10px;border:1px solid rgba(16,24,40,0.04);padding:12px;display:flex;flex-direction:column;gap:8px;height:100%}
    .product-card img{width:100%;height:140px;object-fit:cover;border-radius:8px}

    /* right column small cards */
    aside .card + .card{margin-top:16px}

    /* orders */
    .orders-list div{padding:8px 0;border-bottom:1px solid rgba(16,24,40,0.04);font-size:14px}

    /* utility */
    .muted-link{color:var(--s7-green);text-decoration:none;font-weight:700}

    /* responsive */
    @media (max-width:1100px){
      .page{margin:120px 16px}
      .stats{min-width:240px}
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;gap:14px}
      .stats{min-width:unset;margin-left:0;width:100%}
      nav.header-nav{display:none}
      .hamburger{display:inline-flex}
      .full-header{padding:16px}
      .avatar{width:92px;height:92px}
      .page{margin:100px 12px}
    }
    @media (max-width:520px){
      header{height:64px;padding:0 12px}
      .brand{display:none}
      .user-info h1{font-size:18px}
      .chip{padding:6px 8px;font-size:12px}
      .stats{min-width:unset}
      .product-card img{height:120px}
    }

    /* mobile slide menu */
    .mobile-menu{
      display:none;position:fixed;top:72px;left:0;right:0;background:#fff;border-bottom:1px solid rgba(16,24,40,0.03);
      box-shadow:0 8px 30px rgba(16,24,40,0.06);padding:12px;z-index:1199;
    }
    .mobile-menu.open{display:block}
    .mobile-menu a{display:block;padding:10px 12px;border-radius:8px;color:#111;text-decoration:none;font-weight:700}

    /* small helper for inputs created by enableEdit */
    input[type="text"], input[type="email"], input[type="tel"], input[type="password"]{
      font-size:14px;padding:8px;border-radius:8px;border:1px solid #e6e6e6;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <a href="index.html" style="display:flex;align-items:center;gap:10px;text-decoration:none">
        <img src="images/1757683264306.avif" alt="S7avelii" class="logo-img" />
        <div class="brand">S7avelii Airlines</div>
      </a>
      <nav class="header-nav" aria-label="main navigation">
        <ul>
          <li><a href="bilet.html">Купить билет</a></li>
          <li><a href="priority.html">S7avelii Priority</a></li>
          <li><a href="body.html">Информация</a></li>
        </ul>
      </nav>
    </div>

    <div class="header-right">
      <button class="hamburger" id="hamburgerBtn" aria-label="Меню">
        <span></span><span></span><span></span>
      </button>
      <button class="homeBtn" id="homeUserBtn">Вход</button>
    </div>
  </header>

  <!-- mobile menu -->
  <div class="mobile-menu" id="mobileMenu" aria-hidden="true">
    <a href="bilet.html">Купить билет</a>
    <a href="priority.html">S7avelii Priority</a>
    <a href="body.html">Информация</a>
    <div style="margin-top:8px"><a href="/auth.html" class="muted-link">Войти</a></div>
  </div>

  <main class="page">
    <div class="full-header" role="banner" aria-labelledby="fioHeader">
      <div style="display:flex;align-items:center;gap:16px">
        <label for="avatarInput" title="Нажмите чтобы загрузить фото" style="cursor:pointer;display:flex;align-items:center;gap:12px">
          <img id="avatar" class="avatar" src="https://via.placeholder.com/150" alt="avatar" />
        </label>
        <input id="avatarInput" type="file" accept="image/*" style="display:none">

        <div class="user-info">
          <h1 id="fioHeader">Загрузка...</h1>
          <div class="phone" id="phoneHeader">—</div>
          <div style="display:flex;gap:10px;margin-top:8px;align-items:center">
            <div class="chip" id="cardTypeBadge">Classic</div>
            <div class="small-muted">ID: <span id="cardField">—</span></div>
          </div>
        </div>
      </div>

      <div class="stats" aria-hidden="false">
        <div class="stat-row">
          <div>
            <div class="stat-label">Бонусные мили</div>
            <div class="stat-value" id="bonusMiles">—</div>
          </div>
          <div style="text-align:right">
            <div class="small-muted">Статусные мили</div>
            <div style="font-weight:800;font-size:18px" id="milesStatusStat">—</div>
          </div>
        </div>

        <div class="progress-wrap">
          <div class="progress-bg" aria-hidden="true"><div id="milesProgressBar" class="progress-fill" style="width:0%"></div></div>
          <div class="progress-meta">
            <div id="milesLabelLeft">0 миль</div>
            <div id="milesLabelRight">— для уровня</div>
          </div>
        </div>
      </div>
    </div>

    <nav class="tabs" role="tablist" aria-label="tabs">
      <a class="active" data-tab="profileTab" onclick="showTab(event)">Профиль</a>
      <a data-tab="milesTab" onclick="showTab(event)">Мои мили</a>
      <a data-tab="shopTab" onclick="showTab(event)">S7avelii Shop</a>
      <a data-tab="settingsTab" onclick="showTab(event)">Настройки</a>
    </nav>

    <div class="grid" role="main">
      <div>
        <!-- Profile -->
        <section id="profileTab" class="card" aria-label="profile">
          <h3>Персональные данные</h3>

          <div class="field">
            <div>
              <div class="label">ФИО</div>
              <div id="fioField" class="value">—</div>
            </div>
            <button class="btn" onclick="enableEdit('fio')">Изменить</button>
          </div>

          <div class="field">
            <div>
              <div class="label">Дата рождения</div>
              <div id="dobField" class="value">—</div>
            </div>
            <button class="btn" onclick="enableEdit('dob')">Изменить</button>
          </div>

          <div class="field">
            <div>
              <div class="label">Пол</div>
              <div id="genderField" class="value">—</div>
            </div>
            <button class="btn" onclick="enableEdit('gender')">Изменить</button>
          </div>

          <h3 style="margin-top:16px">Контакты</h3>
          <div class="field">
            <div>
              <div class="label">E-mail</div>
              <div id="emailField" class="value">—</div>
            </div>
            <button class="btn" onclick="enableEdit('email')">Изменить</button>
          </div>

          <div class="field">
            <div>
              <div class="label">Телефон</div>
              <div id="phoneField" class="value">—</div>
            </div>
            <button class="btn" onclick="enableEdit('phone')">Изменить</button>
          </div>

          <h3 style="margin-top:16px">Карта</h3>
          <div class="field">
            <div>
              <div class="label">Номер карты</div>
              <div id="cardField" class="value">—</div>
            </div>
            <button class="btn" onclick="enableEdit('cardNumber')">Изменить</button>
          </div>
          <div class="field">
            <div>
              <div class="label">Тип карты</div>
              <div id="cardTypeField" class="value">—</div>
            </div>
          </div>
        </section>

        <!-- Miles -->
        <section id="milesTab" class="card" style="margin-top:16px;display:none">
          <h3>Мои мили</h3>
          <div class="muted">Состояние бонусов и прогресс статуса</div>

          <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
            <div class="card" style="flex:1;min-width:200px;padding:12px">
              <div class="small-muted">Бонусные мили</div>
              <div style="font-weight:800;font-size:20px" id="milesBonusStat">—</div>
            </div>
            <div class="card" style="flex:1;min-width:200px;padding:12px">
              <div class="small-muted">Статусные мили</div>
              <div style="font-weight:800;font-size:20px" id="milesStatusStat2">—</div>
            </div>
          </div>

          <div style="margin-top:14px">
            <div class="small-muted">Прогресс до следующего уровня</div>
            <div class="progress-bg" style="margin-top:8px"><div id="milesProgressBar2" class="progress-fill" style="width:0%"></div></div>
            <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--muted);margin-top:6px">
              <div id="nextLevelLeft">0 / 0</div>
              <div id="nextLevelRight">—</div>
            </div>
          </div>

          <div style="margin-top:12px" id="privilegesList"></div>
        </section>

        <!-- Shop -->
        <section id="shopTab" class="card" style="margin-top:16px;display:none">
          <h3>S7avelii Shop</h3>
          <div class="muted">Товары, доступные к покупке</div>
          <div id="productGrid" class="product-grid" style="margin-top:12px"></div>

          <h3 style="margin-top:16px">В корзине</h3>
          <div id="cartList" style="min-height:40px"></div>
          <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
            <div id="cartTotal" class="muted">Итого: 0 ₽</div>
            <div style="margin-left:auto">
              <button id="checkoutBtn" class="btn" onclick="checkout()">Оформить</button>
            </div>
          </div>
        </section>

        <!-- Settings -->
        <section id="settingsTab" class="card" style="margin-top:16px;display:none">
          <h3>Настройки</h3>

          <div class="field" style="align-items:flex-start">
            <div>
              <div class="small-muted">Сменить пароль</div>
              <input id="newPassword" type="password" placeholder="Новый пароль" style="margin-top:6px">
            </div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn" onclick="changePassword()">Сменить</button>
              <div id="pwdMsg" class="muted"></div>
            </div>
          </div>

          <div class="field" style="align-items:flex-start">
            <div>
              <div class="small-muted">Привязка VK</div>
              <input id="vkHandle" placeholder="vk_id или ссылка" style="margin-top:6px">
            </div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn" onclick="bindVK()">Привязать VK</button>
              <div id="vkMsg" class="muted"></div>
            </div>
          </div>

          <div class="field" style="align-items:flex-start">
            <div>
              <div class="small-muted">Привязка Telegram</div>
              <input id="tgHandle" placeholder="@username" style="margin-top:6px">
            </div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn" onclick="bindTelegram()">Привязать Telegram</button>
              <div id="tgMsg" class="muted"></div>
            </div>
          </div>

          <div style="margin-top:12px"><button class="btn red" onclick="logout()">Выйти</button></div>
        </section>
      </div>

      <!-- Right column -->
      <aside>
        <div class="card">
          <h3>Быстрые действия</h3>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">
            <button class="btn" onclick="goTo('profileTab')">Редактировать профиль</button>
            <button class="btn" onclick="goTo('milesTab')">Посмотреть мили</button>
            <button class="btn" onclick="goTo('shopTab')">Открыть Shop</button>
          </div>
        </div>

        <div class="card">
          <h3>Заказы</h3>
          <div id="ordersContainer" class="muted orders-list" style="margin-top:8px">Загрузка...</div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Скрипт — функционал сохранён (почти полностью взят из твоего оригинала) -->
  <script>
    /* ================ CONFIG ================ */
    const API = ''; // same origin
    const el = id => document.getElementById(id);
    let currentUser = null;

    /* ================ Utilities ================ */
    function fmtPrice(n){ return (typeof n==='number' ? n.toLocaleString('ru-RU') : n) + ' ₽' }
    function safeJson(res){ return res.json().catch(()=>({})); }

    /* ================ Init ================ */
    document.addEventListener('DOMContentLoaded', async () => {
      attachHandlers();
      renderProducts();
      await loadProfile();       // attempt load profile but do NOT redirect to auth on 401
      await loadCart();
    });

    /* ================ Handlers & UI ================ */
    function attachHandlers(){
      // avatar input
      el('avatarInput').addEventListener('change', function(){
        const f = this.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = async (ev) => {
          const dataUrl = ev.target.result;
          el('avatar').src = dataUrl;
          // optimistic update
          try {
            await fetch(API + '/api/profile/update', {
              method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
              body: JSON.stringify({ avatar: dataUrl })
            });
            await loadProfile();
          } catch(e){ console.warn('avatar update failed', e); }
        };
        r.readAsDataURL(f);
      });

      // home user button (top-right) toggles to cabinet or auth
      const homeBtn = document.getElementById('homeUserBtn');
      homeBtn.addEventListener('click', () => {
        if (currentUser) window.location.href = '/cabinet.html';
        else window.location.href = '/auth.html';
      });

      // hamburger for mobile menu
      const ham = document.getElementById('hamburgerBtn');
      const mMenu = document.getElementById('mobileMenu');
      ham.addEventListener('click', () => {
        const open = mMenu.classList.toggle('open');
        mMenu.setAttribute('aria-hidden', !open);
      });
    }

    // show/hide tab
    function showTab(evt){
      evt && evt.preventDefault();
      const tabId = evt ? evt.currentTarget.getAttribute('data-tab') : 'profileTab';
      document.querySelectorAll('.tabs a').forEach(a=>a.classList.remove('active'));
      if (evt) evt.currentTarget.classList.add('active');
      ['profileTab','milesTab','shopTab','settingsTab'].forEach(id=>{
        const node = el(id);
        if(!node) return;
        node.style.display = (id === tabId ? 'block' : 'none');
      });
      if (tabId === 'shopTab') loadCart();
    }

    /* ================ Profile load / apply ================ */
    async function loadProfile(){
      try {
        const res = await fetch(API + '/api/profile', { credentials: 'include' });
        if (!res.ok) {
          // not logged in or server error -> show guest state but don't redirect
          showGuestState();
          return;
        }
        const j = await res.json().catch(()=>({}));
        currentUser = j.user || null;
        applyProfile(currentUser);
      } catch (e) {
        console.warn('loadProfile failed', e);
        showGuestState();
      }
    }

    function showGuestState(){
      currentUser = null;
      el('fioHeader').textContent = 'Гость';
      el('fioField').textContent = '—';
      el('dobField').textContent = '—';
      el('genderField').textContent = '—';
      el('emailField').textContent = '—';
      el('phoneField').textContent = '—';
      el('cardField').textContent = '—';
      el('cardTypeField').textContent = '—';
      el('avatar').src = 'https://via.placeholder.com/150';
      el('bonusMiles').textContent = '—';
      el('milesProgressBar').style.width = '0%';
      el('milesProgressBar2').style.width = '0%';
      el('homeUserBtn').textContent = 'Вход';
      renderOrders([]);
    }

    // apply profile data into UI
    function applyProfile(u){
      if(!u) return showGuestState();
      currentUser = u;
      el('fioHeader').textContent = u.fio || 'Пользователь';
      el('phoneHeader').textContent = u.phone || '';
      el('fioField').textContent = u.fio || '—';
      el('dobField').textContent = u.dob || '—';
      el('genderField').textContent = u.gender || '—';
      el('emailField').textContent = u.email || '—';
      el('phoneField').textContent = u.phone || '—';
      el('cardField').textContent = u.cardNumber || '—';
      el('cardTypeField').textContent = u.cardType || '—';
      el('cardTypeBadge').textContent = u.cardType || 'Classic';
      el('bonusMiles').textContent = (u.bonusMiles ?? 0);
      if (u.avatar) el('avatar').src = u.avatar;
      el('homeUserBtn').textContent = u.avatar ? '' : (u.fio ? u.fio.split(' ')[0] : 'Профиль');
      if (u.avatar) {
        // show small image inside home button
        el('homeUserBtn').innerHTML = `<img src="${u.avatar}" alt="avatar" style="width:36px;height:36px;border-radius:999px;object-fit:cover">`;
      }
      // progress bars
      const bonus = Number(u.bonusMiles || 0);
      const status = Number(u.statusMiles || 0);
      // define thresholds (example) — you can adapt thresholds per cardType
      const nextLevelTarget = determineNextLevelTarget(u.cardType || 'Classic');
      const percent = Math.min(100, Math.round((bonus/nextLevelTarget)*100));
      el('milesProgressBar').style.width = percent + '%';
      el('milesLabelLeft').textContent = bonus + ' миль';
      el('milesLabelRight').textContent = nextLevelTarget + ' для уровня';
      el('milesBonusStat').textContent = bonus;
      el('milesStatusStat').textContent = status;
      // second miles progress (status miles)
      const statusTarget = Math.max(1, nextLevelTarget); // reuse
      const percent2 = Math.min(100, Math.round((status / statusTarget) * 100));
      el('milesProgressBar2').style.width = percent2 + '%';
      el('nextLevelLeft').textContent = `${status} / ${statusTarget}`;
      el('nextLevelRight').textContent = `${u.cardType || 'Classic'}`;
      // privileges example
      renderPrivileges(u.cardType || 'Classic');
      // orders
      renderOrders(u.orders || []);
    }

    /* determine target miles for next level (simple rules, can be adjusted) */
    function determineNextLevelTarget(cardType){
      if (cardType === 'VIP') return 50000;
      if (cardType === 'Classic') return 5000;
      return 5000;
    }

    function renderPrivileges(cardType){
      const map = {
        Classic: ['Накопление бонусных миль', 'Акции и спецпредложения'],
        VIP: ['Приоритетная регистрация', 'Доступ в бизнес-зал', 'Дополнительные бонусы']
      };
      const list = el('privilegesList');
      list.innerHTML = '<h4>Привилегии:</h4>';
      const ul = document.createElement('ul');
      (map[cardType] || map['Classic']).forEach(p => {
        const li = document.createElement('li');
        li.textContent = '• ' + p;
        ul.appendChild(li);
      });
      list.appendChild(ul);
    }

    /* ================ Inline edit ================ */
    function enableEdit(field){
      const map = {
        fio: 'fioField', dob: 'dobField', gender: 'genderField',
        email: 'emailField', phone: 'phoneField', cardNumber: 'cardField'
      };
      const id = map[field];
      if(!id) return;
      const container = el(id);
      const current = container.textContent === '—' ? '' : container.textContent;
      container.innerHTML = '';
      const input = document.createElement('input');
      input.value = current;
      input.style.width = '220px';
      input.type = (field === 'email') ? 'email' : (field === 'phone') ? 'tel' : 'text';
      const ok = document.createElement('button');
      ok.className = 'btn';
      ok.textContent = 'OK';
      ok.style.marginLeft = '8px';
      ok.onclick = async () => {
        const value = input.value.trim();
        container.textContent = value || '—';
        if (field === 'fio') el('fioHeader').textContent = value || 'Пользователь';
        // send update
        try {
          const body = {};
          body[field] = value || '';
          const res = await fetch(API + '/api/profile/update', {
            method: 'POST', headers: {'Content-Type':'application/json'}, credentials: 'include',
            body: JSON.stringify(body)
          });
          if (res.ok) {
            const j = await safeJson(res);
            if (j.user) applyProfile(j.user);
            else await loadProfile();
          } else {
            await loadProfile();
          }
        } catch (e) {
          console.warn('update failed', e);
          await loadProfile();
        }
      };
      container.appendChild(input);
      container.appendChild(ok);
      input.focus();
    }

    /* ================ Products (simple static list) ================ */
    const PRODUCTS = [
      { id:'p1', title:'Блокнот S7avelii', price:550, image:'images/photo_5330078908990750485_y.avif' },
      { id:'p2', title:'Комбо Блокнот + Футболка', price:2350, image:'images/photo_5330078908990750484_y.avif' },
      { id:'p3', title:'Фирменная футболка', price:1900, image:'images/photo_5332515869139530693_y.avif' },
      { id:'p4', title:'Комбо Путешественник', price:4500, image:'images/photo_5330078908990750483_y.avif' }
    ];

    function renderProducts(){
      const grid = el('productGrid');
      grid.innerHTML = '';
      PRODUCTS.forEach(p => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          <img src="${p.image}" alt="${p.title}">
          <div style="font-weight:700">${p.title}</div>
          <div style="font-weight:800">${fmtPrice(p.price)}</div>
          <div style="margin-top:auto;display:flex;gap:8px">
            <button class="btn" data-buy="${p.id}">Купить</button>
            <button class="btn secondary" data-add="${p.id}">В корзину</button>
          </div>
        `;
        grid.appendChild(card);
      });
      // attach handlers
      grid.querySelectorAll('[data-add]').forEach(btn=>{
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-add');
          const product = PRODUCTS.find(x=>x.id===id);
          if (!product) return alert('Товар не найден');
          try {
            const res = await fetch(API + '/api/cart/add', {
              method: 'POST', headers: {'Content-Type':'application/json'}, credentials:'include',
              body: JSON.stringify({ title: product.title, price: product.price, image: product.image, qty: 1 })
            });
            if (!res.ok) {
              const j = await safeJson(res);
              if (res.status === 401) return window.location.href = '/auth.html';
              return alert(j.error || 'Ошибка добавления в корзину');
            }
            alert('Добавлено в корзину');
            if (document.querySelector('.tabs a.active')?.getAttribute('data-tab') === 'shopTab') loadCart();
          } catch (e) { alert('Ошибка сети'); }
        });
      });
      grid.querySelectorAll('[data-buy]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-buy');
          const product = PRODUCTS.find(x=>x.id===id);
          if (!product) return;
          try {
            const addRes = await fetch(API + '/api/cart/add', {
              method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
              body: JSON.stringify({ title: product.title, price: product.price, image: product.image, qty: 1 })
            });
            if (!addRes.ok) {
              const j = await safeJson(addRes);
              if (addRes.status === 401) return window.location.href = '/auth.html';
              return alert(j.error || 'Ошибка добавления');
            }
            goTo('shopTab');
            loadCart();
          } catch (e) { alert('Ошибка сети'); }
        });
      });
    }

    /* ================ Cart ================ */
    async function loadCart(){
      const list = el('cartList');
      list.innerHTML = '<div class="muted">Загрузка...</div>';
      try {
        const res = await fetch(API + '/api/cart', { credentials: 'include' });
        if (!res.ok) {
          const j = await safeJson(res);
          if (res.status === 401) {
            list.innerHTML = `<div class="muted">Корзина доступна после входа — <a href="/auth.html">войти</a></div>`;
            el('checkoutBtn').disabled = true;
            return;
          }
          list.innerHTML = `<div class="muted">Ошибка загрузки корзины</div>`;
          el('checkoutBtn').disabled = true;
          return;
        }
        const j = await res.json();
        renderCart(j.cart || []);
      } catch (e) {
        list.innerHTML = `<div class="muted">Ошибка сети</div>`;
        el('checkoutBtn').disabled = true;
      }
    }

    function renderCart(items){
      const list = el('cartList');
      if (!items || items.length === 0) {
        list.innerHTML = '<div class="muted">Корзина пуста</div>';
        el('cartTotal').textContent = 'Итого: 0 ₽';
        el('checkoutBtn').disabled = true;
        return;
      }
      let total = 0;
      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.flexDirection = 'column';
      container.style.gap = '10px';
      items.forEach(it=>{
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.justifyContent = 'space-between';
        div.style.borderBottom = '1px dashed rgba(0,0,0,0.06)';
        div.style.padding = '8px 0';
        const priceNum = Number(it.price) || 0;
        total += priceNum * (it.qty || 1);
        div.innerHTML = `
          <div style="display:flex;gap:10px;align-items:center;flex:1">
            <img src="${it.image||'https://via.placeholder.com/64'}" style="width:64px;height:64px;object-fit:cover;border-radius:8px">
            <div>
              <div style="font-weight:700">${it.title}</div>
              <div class="muted">${fmtPrice(it.price)} × ${it.qty || 1}</div>
            </div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800">${fmtPrice(priceNum*(it.qty||1))}</div>
            <div style="margin-top:8px"><button class="btn secondary" data-remove="${it.id}">Удалить</button></div>
          </div>
        `;
        container.appendChild(div);
      });
      list.innerHTML = '';
      list.appendChild(container);
      el('cartTotal').textContent = 'Итого: ' + fmtPrice(total);
      el('checkoutBtn').disabled = false;
      // attach remove handlers
      list.querySelectorAll('[data-remove]').forEach(btn=>{
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-remove');
          if (!confirm('Удалить товар из корзины?')) return;
          try {
            const res = await fetch(API + '/api/cart/' + encodeURIComponent(id), { method: 'DELETE', credentials: 'include' });
            if (!res.ok) { const j = await safeJson(res); return alert(j.error || 'Ошибка удаления'); }
            await loadCart();
          } catch (e) { alert('Ошибка сети'); }
        });
      });
    }

    async function checkout(){
      if(!confirm('Оформить заказ?')) return;
      try {
        const res = await fetch(API + '/api/cart/checkout', { method: 'POST', credentials: 'include' });
        const j = await safeJson(res);
        if (!res.ok) return alert(j.error || 'Ошибка оформления');
        // on success, refresh cart and profile (orders)
        await loadCart();
        await loadProfile();
        el('cartMsg') && (el('cartMsg').textContent = 'Заказ принят');
        setTimeout(()=> el('cartMsg') && (el('cartMsg').textContent = ''), 3000);
      } catch (e) { alert('Ошибка сети'); }
    }

    /* ================ Orders rendering ================ */
    function renderOrders(orders){
      const dest = el('ordersContainer');
      dest.innerHTML = '';
      if (!orders || !orders.length) { dest.textContent = 'Заказы отсутствуют'; return; }
      orders.slice().reverse().forEach(o=>{
        const d = document.createElement('div');
        d.style.padding = '8px 0';
        d.style.borderBottom = '1px solid rgba(0,0,0,0.04)';
        d.innerHTML = `<strong>Заказ ${o.id}</strong> — ${new Date(o.createdAt).toLocaleString()} — ${o.status}<br>Товаров: ${o.items.length} — Сумма: ${fmtPrice(o.total)}`;
        dest.appendChild(d);
      });
    }

    /* ================ Settings actions ================ */
    async function changePassword(){
      const v = el('newPassword').value.trim();
      if (!v) return alert('Введите новый пароль');
      try {
        const res = await fetch(API + '/api/profile/update', {
          method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify({ password: v })
        });
        const j = await safeJson(res);
        if (!res.ok) return alert(j.error || 'Ошибка');
        el('pwdMsg').textContent = 'Пароль обновлён';
        el('newPassword').value = '';
        setTimeout(()=> el('pwdMsg').textContent = '', 3000);
      } catch (e) { alert('Ошибка сети'); }
    }

    async function bindVK(){
      const v = el('vkHandle').value.trim();
      if (!v) return el('vkMsg').textContent = 'Введите VK id';
      try {
        const res = await fetch(API + '/api/profile/update', {
          method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify({ vk: v })
        });
        const j = await safeJson(res);
        if (!res.ok) return el('vkMsg').textContent = j.error || 'Ошибка';
        el('vkMsg').textContent = 'VK привязан';
        setTimeout(()=> el('vkMsg').textContent = '', 3000);
      } catch (e) { el('vkMsg').textContent = 'Ошибка сети'; }
    }

    async function bindTelegram(){
      const v = el('tgHandle').value.trim();
      if (!v) return el('tgMsg').textContent = 'Введите telegram handle';
      try {
        const res = await fetch(API + '/api/profile/update', {
          method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify({ telegram: v })
        });
        const j = await safeJson(res);
        if (!res.ok) return el('tgMsg').textContent = j.error || 'Ошибка';
        el('tgMsg').textContent = 'Telegram привязан';
        setTimeout(()=> el('tgMsg').textContent = '', 3000);
      } catch (e) { el('tgMsg').textContent = 'Ошибка сети'; }
    }

    /* ================ Logout ================ */
    async function logout(){
      try {
        await fetch(API + '/api/logout', { method: 'POST', credentials: 'include' });
      } catch (e) { console.warn('logout failed', e); }
      // show guest state and redirect to auth page
      showGuestState();
      window.location.href = '/auth.html';
    }

    /* ================ Helpers ================ */
    function goTo(tab){
      const a = [...document.querySelectorAll('.tabs a')].find(x=>x.getAttribute('data-tab')===tab);
      if(a) { a.click(); a.classList.add('active'); showTab({ currentTarget: a, preventDefault: ()=>{} }); }
    }
  </script>
</body>
</html>
