<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>S7avelii | Профиль</title>

<!-- Montserrat -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --s7-green: #B7CD00;
    --muted: #8b97a6;
    --card-bg: #ffffff;
    --page-bg: #f5f7fa;
    --panel: #f4f5f7;
    --line: #e9eef2;
    --text:#1f2937;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: 'Montserrat', system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    background:var(--page-bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Header (white bar with logo left and user right) */
  header{
    position:fixed;
    top:0;left:0;right:0;
    height:84px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:18px 28px;
    background:#fff;
    border-bottom:1px solid var(--line);
    z-index:1200;
  }
  .brand{
    display:flex;
    align-items:center;
    gap:12px;
  }
  .brand .logo-circle{
    width:44px;height:44px;border-radius:50%;
    background:linear-gradient(135deg,var(--s7-green),#9cc42f);
    display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px;
  }
  .brand .txt{font-size:18px;font-weight:600;color:var(--text)}
  #userArea{display:flex;align-items:center;gap:12px;min-width:160px;justify-content:flex-end}
  #userArea img{width:36px;height:36px;border-radius:50%;object-fit:cover;cursor:pointer;border:2px solid #fff;box-shadow:0 3px 8px rgba(0,0,0,0.06)}

  /* Page container */
  .page{max-width:1180px;margin:120px auto;padding:0 20px 60px}

  /* Top profile block */
  .full-header{
    background:var(--card-bg);
    display:flex;
    align-items:flex-start;
    gap:24px;
    padding:22px 26px;
    border-radius:12px;
    box-shadow:0 6px 20px rgba(16,24,40,0.06);
    border:1px solid var(--line);
    flex-wrap:wrap;
  }
  .avatar{width:110px;height:110px;border-radius:999px;object-fit:cover;border:4px solid #fff;cursor:pointer;box-shadow:0 8px 26px rgba(12,20,24,0.06)}
  .profile-meta h2{margin:0;font-size:24px;font-weight:600}
  .profile-meta .sub{color:var(--s7-green);font-weight:600;margin-top:6px;font-size:14px;display:flex;gap:8px;align-items:center}

  .badges{display:flex;gap:8px;margin-top:10px;align-items:center}
  .badge{background:#fff;border-radius:999px;padding:8px;border:1px solid #f1f3f4;display:flex;align-items:center;gap:8px;box-shadow:0 2px 8px rgba(0,0,0,0.03)}
  .badge .dot{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--s7-green);background:rgba(183,205,0,0.08)}

  .counters{display:flex;gap:28px;margin-left:24px;align-items:center}
  .counter{min-width:110px;text-align:center;padding:0 6px;border-left:1px solid #f1f4f6}
  .counter:first-child{border-left:0}
  .counter .num{font-weight:700;font-size:20px}
  .counter .label{color:var(--muted);font-size:13px;margin-top:6px}

  /* Tabs */
  .tabs{display:flex;gap:18px;margin-top:20px;border-bottom:1px solid #eef2f4;padding-bottom:8px}
  .tabs a{padding:10px 8px;text-decoration:none;color:#444;border-radius:6px;font-weight:400;cursor:pointer}
  .tabs a.active{color:var(--s7-green);border-bottom:3px solid var(--s7-green);background:transparent}

  /* telegram block (the one between tabs and personal data) */
  .telegram-block {
    background:#fff;
    border-radius:12px;
    display:flex;
    gap:14px;
    align-items:flex-start;
    padding:18px 20px;
    border:1px solid #eef2f6;
    box-shadow:0 1px 2px rgba(0,0,0,0.03);
    margin-top:20px;
  }
  .telegram-block .icon {
    margin-top:4px;
    flex-shrink:0;
  }
  .telegram-block .title { font-weight:600; color:#111; margin-bottom:6px; }
  .telegram-block .text { color:#4b5563; font-size:14px; line-height:1.45; margin-bottom:10px }
  .telegram-block .btn {
    background:#f3f5f7;
    border:1px solid #e0e6ea;
    color:#111;
    padding:8px 14px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
  }
  .telegram-block .close {
    position:absolute; right:16px; top:12px;
    background:none;border:0;font-size:18px;color:#6b7280;cursor:pointer;
  }

  /* grid main */
  .grid{display:grid;grid-template-columns:1fr 380px;gap:22px;margin-top:18px}
  .card{background:var(--card-bg);border-radius:12px;padding:18px;box-shadow:0 4px 12px rgba(16,24,40,0.04);border:1px solid var(--line)}
  .field{display:flex;justify-content:space-between;padding:12px 0;border-top:1px solid rgba(0,0,0,0.03)}
  .small-muted{color:var(--muted);font-size:13px}
  .btn{background:var(--s7-green);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
  .btn.secondary{background:#eef2f7;color:#111}
  .btn.red{background:#e66}
  .progress-wrap{width:100%;margin-top:8px}
  .progress-bg{width:100%;height:14px;background:#eee;border-radius:999px;overflow:hidden}
  .progress-fill{height:100%;width:0%;background:var(--s7-green);transition:width .6s ease}
  .cart-table{width:100%;border-collapse:collapse}
  .cart-table th,.cart-table td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .muted{color:var(--muted)}
  .input-inline{width:70%;padding:6px;border-radius:6px;border:1px solid #d6d8db}

  /* footer */
  footer.footer{margin-top:26px;}

  /* responsive */
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  @media(max-width:680px){
    .profile-meta h2{font-size:20px}
    .avatar{width:90px;height:90px}
  }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="brand" aria-hidden="true">
    <div class="logo-circle">S7</div>
    <div class="txt">S7 Airlines</div>
  </div>
  <div id="userArea"><a href="auth.html">Вход</a></div>
</header>

<!-- PAGE -->
<div class="page">

  <!-- TOP PROFILE -->
  <div class="full-header" role="region" aria-label="profile header">
    <div style="display:flex;align-items:center;gap:16px">
      <label for="avatarInput" title="Нажмите чтобы загрузить фото">
        <img id="avatar" class="avatar" src="https://via.placeholder.com/150" alt="avatar">
      </label>
      <input id="avatarInput" type="file" accept="image/*" style="display:none">
      <div class="profile-meta">
        <h2 id="fioHeader">Загрузка...</h2>
        <div class="sub" id="phoneHeader">—</div>

        <div style="display:flex;align-items:center;gap:12px;margin-top:12px">
          <div class="badges" aria-hidden="true">
            <div class="badge"><div class="dot">T</div><div class="small-muted">Тип</div></div>
            <div class="badge"><div class="dot">+</div><div class="small-muted">Плюс</div></div>
          </div>

          <div class="counters" aria-hidden="true">
            <div class="counter"><div class="num" id="bonusMiles">—</div><div class="label">бонусных миль</div></div>
            <div class="counter"><div class="num" id="milesBonusStat">—</div><div class="label">статусная миля</div></div>
            <div class="counter"><div class="num" id="milesStatusStat">—</div><div class="label">статусных полётов</div></div>
          </div>
        </div>

        <div class="tabs" role="tablist" aria-label="tabs" style="margin-top:16px">
          <a class="active" data-tab="profileTab" onclick="showTab(event)">Профиль</a>
          <a data-tab="milesTab" onclick="showTab(event)">Мои мили</a>
          <a data-tab="travelTab" onclick="showTab(event)">Путешествия</a>
          <a data-tab="plusTab" onclick="showTab(event)">Яндекс Плюс x S7</a>
          <a data-tab="gateTab" onclick="showTab(event)">Gate 7</a>
          <a data-tab="statsTab" onclick="showTab(event)">Статистика</a>
          <a data-tab="bonusesTab" onclick="showTab(event)">Бонусы</a>
          <a data-tab="shopTab" onclick="showTab(event)">S7 Shop</a>
          <a data-tab="settingsTab" onclick="showTab(event)">Настройки</a>
        </div>
      </div>
    </div>

    <div style="margin-left:auto;min-width:240px;text-align:right">
      <div class="small-muted">Бонусные мили</div>
      <div style="font-weight:700;font-size:20px" id="bonusMiles">—</div>
      <div class="progress-wrap" style="margin-top:10px">
        <div class="progress-bg" aria-hidden="true"><div id="milesProgressBar" class="progress-fill" style="width:0%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:12px;color:#777;margin-top:6px">
          <div id="milesLabelLeft">0 миль</div>
          <div id="milesLabelRight">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- TELEGRAM block (between tabs and personal data) -->
  <div style="max-width:1080px;margin:18px auto 0;padding:0 10px;">
    <div class="telegram-block" id="telegram-block" role="alert">
      <button class="close" aria-label="закрыть" onclick="document.getElementById('telegram-block').style.display='none'">×</button>
      <div class="icon" aria-hidden="true">
        <!-- small paper plane like icon (keeps visual cue) -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="12" fill="#eef6ff"/>
          <path d="M4 12L20 4L14 20L11 13L4 12Z" fill="#2b7de9"/>
        </svg>
      </div>
      <div style="flex:1">
        <div class="title">Уведомления в Телеграме</div>
        <div class="text">Получайте важную информацию о полете прямо в мессенджере. Полезно, если вдруг пропустите письмо или пуш</div>
        <div><button class="btn" style="background:#f3f5f7;color:#111;border:1px solid #e0e6ea;padding:8px 12px;border-radius:8px;font-weight:600" onclick="alert('Подписка (демо)')">Подписаться</button></div>
      </div>
    </div>
  </div>

  <!-- MAIN GRID -->
  <div class="grid">
    <div>
      <!-- Profile section -->
      <section id="profileTab" class="card" style="display:block" aria-label="profile">
        <h3 style="margin-top:0">Персональные данные</h3>

        <div class="field">
          <div><div class="small-muted">ФИО</div><div id="fioField">—</div></div>
          <button class="btn secondary" onclick="editInline('fio')">Изменить</button>
        </div>

        <div class="field">
          <div><div class="small-muted">Дата рождения</div><div id="dobField">—</div></div>
          <button class="btn secondary" onclick="editInline('dob')">Изменить</button>
        </div>

        <div class="field">
          <div><div class="small-muted">Пол</div><div id="genderField">—</div></div>
          <button class="btn secondary" onclick="editInline('gender')">Изменить</button>
        </div>

        <h3 style="margin-top:16px">Контакты</h3>

        <div class="field">
          <div><div class="small-muted">E-mail</div><div id="emailField">—</div></div>
          <button class="btn secondary" onclick="editInline('email')">Изменить</button>
        </div>

        <div class="field">
          <div><div class="small-muted">Телефон</div><div id="phoneField">—</div></div>
          <button class="btn secondary" onclick="editInline('phone')">Изменить</button>
        </div>

        <h3 style="margin-top:16px">Карта</h3>

        <div class="field">
          <div><div class="small-muted">Номер карты</div><div id="card_field">—</div></div>
          <button class="btn secondary" onclick="editInline('card_number')">Изменить</button>
        </div>

        <div class="field">
          <div><div class="small-muted">Тип карты</div><div id="cardTypeField">—</div></div>
        </div>
      </section>

      <!-- Miles section (hidden by default) -->
      <section id="milesTab" class="card" style="margin-top:16px;display:none">
        <h3>Мои мили</h3>
        <div class="muted">Состояние бонусов и прогресс статуса</div>
        <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
          <div class="card" style="flex:1;min-width:200px">
            <div class="small-muted">Бонусные мили</div>
            <div style="font-weight:700;font-size:20px" id="milesBonusStat">—</div>
          </div>
          <div class="card" style="flex:1;min-width:200px">
            <div class="small-muted">Статусные мили</div>
            <div style="font-weight:700;font-size:20px" id="milesStatusStat">—</div>
          </div>
        </div>

        <div style="margin-top:14px">
          <div class="small-muted">Прогресс до следующего уровня</div>
          <div class="progress-bg" style="margin-top:8px"><div id="milesProgressBar2" class="progress-fill" style="width:0%"></div></div>
          <div style="display:flex;justify-content:space-between;font-size:13px;color:#666;margin-top:6px">
            <div id="nextLevelLeft">0 / 0</div>
            <div id="nextLevelRight">—</div>
          </div>
        </div>
      </section>

      <!-- Shop -->
      <section id="shopTab" class="card" style="margin-top:16px;display:none">
        <h3>S7avelii Shop</h3>
        <div class="muted">Товары, доступные к покупке</div>
        <div id="productGrid" class="product-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px"></div>
      </section>

      <!-- Settings -->
      <section id="settingsTab" class="card" style="margin-top:16px;display:none">
        <h3>Настройки</h3>
        <button class="btn red" onclick="logout()">Выйти</button>
      </section>
    </div>

    <!-- SIDEBAR -->
    <aside>
      <section class="card">
        <h3>Корзина</h3>
        <table class="cart-table" id="cartTable">
          <thead><tr><th>Товар</th><th>Цена</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:12px;display:flex;justify-content:space-between;font-weight:600">
          <span>Итого:</span>
          <span id="cartTotal">0 ₽</span>
        </div>
        <button class="btn" style="width:100%;margin-top:12px" onclick="checkout()">Оформить</button>
      </section>
    </aside>
  </div>

   <footer class="footer">
  <div class="footer-inner">
    <!-- Верхнее меню -->
    <div class="footer-menu fade-in">
      <div class="footer-column">
        <h3>S7avelii Airlines</h3>
        <ul>
          <li><a href="body.html">О компании</a></li>
          <li><a href="https://t.me/s7aveliihelper">Партнеры</a></li>
          <li><a href="https://t.me/s7aveliihelper">Контакты</a></li>
          <li><a href="#">Вакансии</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <ul>
          <li><a href="office.html">Офисы продаж и представительства</a></li>
          <li><a href="https://t.me/S7saveliiairlines">Новости</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h3>Информация</h3>
        <ul>
          <li><a href="arrivel.html">Направления</a></li>
          <li><a href="bilet.html">Рейсы</a></li>
          <li><a href="https://t.me/s7aveliihelper">Справочный центр</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <ul>
          <li><a href="https://t.me/s7aveliihelper">Перевозка грузов</a></li>
          <li><a href="plane.html">Наш флот</a></li>
          <li><a href="mailto:s7avelii_airlines@mail.ru">Подать заявление на партнёрство</a></li>
        </ul>
      </div>
    </div>

    <hr>

    <!-- Верх футера -->
    <div class="footer-top fade-in">
      <div class="footer-actions">
        <a href="https://t.me/s7aveliihelper" class="action"><img src="icons/chat.svg" alt=""> Чат</a>
      </div>
      <div class="footer-phone">
        <div class="label">тел: Бесплатно по России</div>
        <div class="number">8 962 629–81–05</div>
      </div>
    </div>

    <!-- Подписка -->
    <div class="footer-subscribe fade-in">
      <h3>Подпишитесь на рассылку S7avelii</h3>
      <p>Будьте в курсе акций, открывайте новые маршруты</p>
      <form class="subscribe-form">
        <input type="email" placeholder="Ваша почта" required>
        <button type="submit">→</button>
      </form>
      <label class="checkbox">
        <input type="checkbox" required>
        Хочу узнавать про скидки и идеи путешествий по почте и соглашаюсь на 
        <a href="#">обработку персональных данных</a>
      </label>
    </div>

    <!-- Низ футера -->
    <div class="footer-bottom fade-in">
      <div class="copy">© 2025. S7avelii Airlines — Все права защищены</div>
      <div class="socials">
        <a href="https://vk.com/s7avelii"><img src="images/icons8-vk-logo-30.avif" alt="VK"></a>
        <a href="https://www.tiktok.com/@s7avelii?_t=ZT-8yviZwu6jAT&_r=1"><img src="images/icons8-tiktok-logo-50 (1).avif" alt="TikTok"></a>
        <a href="https://youtu.be/Dy31uUCFaWw?si=2gyqNYaT3ZVO8WJa"><img src="images/icons8-youtube-logo-50.avif" alt="YouTube"></a>
        <a href="https://t.me/S7saveliiairlines"><img src="images/icons8-telegram-logo-50 (1).avif" alt="Telegram"></a>
      </div>
    </div>
  </div>
</footer>

<style>
/* === Убираем горизонтальный скролл и белые полосы === */
html, body {
  overflow-x: hidden;
  margin: 0;
  padding: 0;
}

/* ==== FOOTER ==== */
.footer {
  width: 100%;
  background: #f1f5f9;
  padding: 40px 60px;
  font-family: "Inter", sans-serif;
  color: #111;
  box-sizing: border-box;
}

/* Верхнее меню */
.footer-menu {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 40px;
  margin-bottom: 30px;
}

.footer-column h3 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
}

.footer-column ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.footer-column ul li {
  margin-bottom: 8px;
}

.footer-column ul li a {
  color: #111;
  text-decoration: none;
  font-size: 14px;
  transition: all 0.2s ease;
}

.footer-column ul li a:hover {
  text-decoration: underline;
}

hr {
  border: none;
  border-top: 1px solid #e2e8f0;
  margin: 30px 0;
  width: 100%;
}

/* Верх футера */
.footer-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 30px;
}

.footer-actions {
  display: flex;
  gap: 30px;
}

.footer-actions .action {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
  cursor: pointer;
  text-decoration: none;
  color: #111;
}

.footer-actions img {
  width: 20px;
}

.footer-phone {
  text-align: right;
}

.footer-phone .label {
  font-size: 14px;
  color: #555;
}

.footer-phone .number {
  font-size: 18px;
  font-weight: 600;
}

/* Подписка */
.footer-subscribe {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 30px;
  border: 1px solid #d1d5db;
}

.footer-subscribe h3 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 6px;
}

.footer-subscribe p {
  color: #555;
  margin-bottom: 16px;
}

.subscribe-form {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.subscribe-form input {
  flex: 1;
  padding: 12px 14px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
}

.subscribe-form button {
  background: #9ac208;
  border: none;
  border-radius: 8px;
  padding: 0 20px;
  font-size: 20px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.subscribe-form button:hover {
  background: #8db807;
}

.checkbox {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
  font-size: 13px;
  color: #333;
}

.checkbox a {
  color: #abc70f;
  text-decoration: underline;
}

/* Низ футера */
.footer-bottom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  font-size: 14px;
  color: #555;
}

.socials {
  display: flex;
  gap: 12px;
}

.socials a img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #fff;
  padding: 6px;
  transition: transform 0.2s ease;
}

.socials a img:hover {
  transform: scale(1.1);
}

/* === АНИМАЦИЯ ПОЯВЛЕНИЯ === */
.fade-in {
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.6s ease, transform 0.6s ease;
}

.fade-in.visible {
  opacity: 1;
  transform: translateY(0);
}

/* === АДАПТАЦИЯ === */
@media (max-width: 1024px) {
  .footer {
    padding: 30px 40px;
  }
  .footer-top {
    flex-direction: column;
    align-items: flex-start;
    gap: 20px;
  }
  .footer-phone {
    text-align: left;
  }
}

@media (max-width: 768px) {
  .footer {
    padding: 30px 20px;
  }
  .footer-menu {
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  .footer-column h3 {
    font-size: 16px;
  }
  .footer-column ul li a {
    font-size: 13px;
  }
  .footer-subscribe {
    padding: 16px;
  }
  .subscribe-form {
    flex-direction: column;
  }
  .subscribe-form button {
    width: 100%;
    padding: 10px;
  }
  .footer-bottom {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  .socials {
    justify-content: flex-start;
  }
}

@media (max-width: 480px) {
  .footer-menu {
    grid-template-columns: 1fr;
  }
  .footer-subscribe h3 {
    font-size: 16px;
  }
  .footer-subscribe p {
    font-size: 13px;
  }
  .footer-phone .number {
    font-size: 16px;
  }
  .footer-phone .label {
    font-size: 12px;
  }
  .footer-actions .action {
    font-size: 14px;
  }
  .socials a img {
    width: 28px;
    height: 28px;
  }
}
</style>

<script>
/* === Плавное появление футера при прокрутке === */
document.addEventListener("DOMContentLoaded", () => {
  const fadeElements = document.querySelectorAll('.fade-in');
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.2 });
  fadeElements.forEach(el => observer.observe(el));
});
</script>
</div>

<!-- ====== JS: твоя логика (оставлена без изменений) ====== -->
<script>
/*
  Final cabinet.js integrated in this file.
  - Autologin via localStorage token
  - Inline editing (input/select/date) with onchange -> PUT /api/profile
  - Avatar upload -> POST /api/profile/avatar (multipart)
  - Shop / cart and checkout
  - userArea (avatar or name) in header
*/

const API = "https://s7avelii-airlines-1.onrender.com"; // <- заменяй, если у тебя другой бекенд
function getToken(){ return localStorage.getItem('token'); }

let currentUser = null;
let products = [];
let cart = [];

// apiFetch reads token dynamically
async function apiFetch(endpoint, options = {}) {
  const token = getToken();
  options.headers = { ...(options.headers || {}) };
  if (token) options.headers['Authorization'] = 'Bearer ' + token;
  // do not set Content-Type for FormData
  if (options.body && !(options.body instanceof FormData) && typeof options.body !== 'string') {
    options.headers['Content-Type'] = 'application/json';
    options.body = JSON.stringify(options.body);
  }
  const res = await fetch(API + endpoint, options).catch(e => { console.error('fetch err', e); return null; });
  if (!res) return null;
  if (res.status === 401) { logout(); return null; }
  const json = await res.json().catch(()=> ({}));
  return json;
}

// Update header user area (avatar or name)
async function updateUserArea() {
  const userArea = document.getElementById('userArea');
  const token = getToken();
  if (!token) {
    userArea.innerHTML = `<a href="auth.html">Вход</a>`;
    return;
  }
  try {
    const user = await apiFetch('/api/profile');
    if (!user || !user.fio) { userArea.innerHTML = `<a href="auth.html">Вход</a>`; return; }
    currentUser = user;
    // avatar path from server usually like /avatars/xxx
    if (user.avatar) {
      const avatarUrl = (user.avatar.startsWith('http') ? user.avatar : API + user.avatar);
      userArea.innerHTML = `<img src="${avatarUrl}" alt="avatar" style="width:36px;height:36px;border-radius:50%;cursor:pointer;object-fit:cover" onclick="window.location.href='cabinet.html'">`;
      document.getElementById('avatar').src = avatarUrl;
    } else {
      const short = (user.fio && user.fio.split(' ')[0]) || user.email || 'Профиль';
      userArea.innerHTML = `<span style="cursor:pointer;color:#2196f3;font-weight:500;" onclick="window.location.href='cabinet.html'">${escapeHtml(short)}</span>`;
    }
    loadProfile(); // render details
  } catch (e) {
    console.error('updateUserArea err', e);
    userArea.innerHTML = `<a href="auth.html">Вход</a>`;
  }
}

// simple escape
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// Tabs
function showTab(evt){
  const tab = evt.currentTarget.dataset.tab;
  document.querySelectorAll('.tabs a').forEach(a=>a.classList.remove('active'));
  evt.currentTarget.classList.add('active');
  document.querySelectorAll('.grid section').forEach(s=>s.style.display='none');
  document.getElementById(tab).style.display = 'block';
}

// Render profile fields
function loadProfile(){
  if(!currentUser) return;
  document.getElementById('fioHeader').textContent = currentUser.fio || '—';
  document.getElementById('phoneHeader').textContent = currentUser.phone || '—';
  document.getElementById('fioField').textContent = currentUser.fio || '—';
  document.getElementById('dobField').textContent = currentUser.dob || '—';
  document.getElementById('genderField').textContent = currentUser.gender || '—';
  document.getElementById('emailField').textContent = currentUser.email || '—';
  document.getElementById('phoneField').textContent = currentUser.phone || '—';
  document.getElementById('card_field').textContent = currentUser.card_number || '—';
  document.getElementById('cardTypeField').textContent = currentUser.card_type || '—';

  document.getElementById('bonusMiles').textContent = currentUser.bonus_miles || 0;
  const perc = Math.min(100, (currentUser.bonus_miles || 0) / 1000 * 100);
  document.getElementById('milesProgressBar').style.width = perc + '%';
  document.getElementById('milesLabelRight').textContent = (currentUser.bonus_miles || 0) + ' миль';
  document.getElementById('milesBonusStat').textContent = currentUser.bonus_miles || 0;
  document.getElementById('milesStatusStat').textContent = currentUser.status_miles || 0;
  document.getElementById('milesProgressBar2').style.width = Math.min(100, (currentUser.status_miles || 0) / 1000 * 100) + '%';
  document.getElementById('nextLevelLeft').textContent = (currentUser.status_miles || 0) + '/1000';
}

// Inline editing: creates input/select/date, sends PUT /api/profile on change
async function editInline(field) {
  if(!currentUser) return;
  // map DOM ids and server field names
  const domMap = {
    fio: 'fioField',
    dob: 'dobField',
    gender: 'genderField',
    email: 'emailField',
    phone: 'phoneField',
    card_number: 'card_field'
  };
  const domId = domMap[field] || field + 'Field';
  const container = document.getElementById(domId);
  if(!container) return;

  // current value
  const cur = (field === 'card_number' ? currentUser.card_number : currentUser[field]) || '';

  // create input element depending on field
  let input;
  if (field === 'dob') {
    input = document.createElement('input');
    input.type = 'date';
    input.value = cur;
  } else if (field === 'gender') {
    input = document.createElement('select');
    ['','Мужской','Женский','Другое'].forEach(val=>{
      const o = document.createElement('option'); o.value = val; o.textContent = val || 'Не указан';
      if(val === cur) o.selected = true;
      input.appendChild(o);
    });
  } else if (field === 'phone') {
    input = document.createElement('input'); input.type = 'tel'; input.value = cur;
  } else {
    input = document.createElement('input'); input.type = 'text'; input.value = cur;
  }

  input.className = 'input-inline';
  // Save on change or on blur
  let saved = false;
  input.addEventListener('change', async () => {
    await saveField(field, input.value);
    saved = true;
  });
  input.addEventListener('blur', async () => {
    if(!saved) await saveField(field, input.value);
  });

  // replace content
  container.innerHTML = '';
  container.appendChild(input);
  input.focus();
}

// Save single field to server
async function saveField(field, value) {
  const payload = {};
  // server columns: fio, dob, gender, email, phone, card_number, card_type
  payload[field] = value;
  const res = await apiFetch('/api/profile', { method: 'PUT', body: payload });
  if (res && res.ok) {
    // refresh user data
    const updated = await apiFetch('/api/profile');
    if (updated) { currentUser = updated; loadProfile(); updateUserArea(); }
  } else {
    alert('Ошибка при сохранении');
    // reload profile to original
    const re = await apiFetch('/api/profile'); if(re){ currentUser = re; loadProfile(); }
  }
}

// Avatar upload
document.getElementById('avatarInput').addEventListener('change', async function(){
  if(!this.files[0]) return;
  const fd = new FormData();
  fd.append('avatar', this.files[0]);
  const token = getToken();
  try{
    const res = await fetch(API + '/api/profile/avatar', {
      method: 'POST',
      headers: token ? { 'Authorization': 'Bearer ' + token } : {},
      body: fd
    });
    const data = await res.json();
    if (data && data.avatar) {
      const avatarUrl = data.avatar.startsWith('http') ? data.avatar : API + data.avatar;
      document.getElementById('avatar').src = avatarUrl;
      await updateUserArea();
    } else {
      alert('Ошибка загрузки аватара');
    }
  }catch(err){ console.error('avatar upload', err); alert('Ошибка сети при загрузке'); }
});

// Shop & cart
async function loadShop(){
  const data = await apiFetch('/api/shop');
  products = (data && data.products) ? data.products : [];
  renderProducts();
}

function renderProducts(){
  const grid = document.getElementById('productGrid');
  grid.innerHTML = '';
  products.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<div style="font-weight:600">${escapeHtml(p.name)}</div>
                     <div class="small-muted">${p.price} ₽</div>
                     <button class="btn" onclick="addToCart(${p.id})">В корзину</button>`;
    grid.appendChild(div);
  });
}

function addToCart(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  cart.push(p);
  renderCart();
}

function removeFromCart(i){
  cart.splice(i,1);
  renderCart();
}

function renderCart(){
  const tbody = document.getElementById('cartTable').querySelector('tbody');
  tbody.innerHTML = '';
  let total = 0;
  cart.forEach((p,i)=>{
    total += p.price;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(p.name)}</td><td>${p.price} ₽</td><td><button class="btn secondary" onclick="removeFromCart(${i})">×</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('cartTotal').textContent = total + ' ₽';
}

async function checkout(){
  if(cart.length === 0) { alert('Корзина пуста'); return; }
  const res = await apiFetch('/api/checkout', { method: 'POST', body: { items: cart } });
  if(res && res.ok) { cart = []; renderCart(); alert('Заказ оформлен!'); }
  else alert('Ошибка при оформлении заказа');
}

// Logout
function logout(){
  localStorage.removeItem('token');
  window.location.href = 'auth.html';
}

// init
window.addEventListener('DOMContentLoaded', async () => {
  const token = getToken();
  if(!token){ window.location.href = 'auth.html'; return; }
  await updateUserArea();
  await loadShop();
});

// helper: escape HTML for text nodes
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>

