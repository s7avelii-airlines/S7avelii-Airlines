<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S7avelii | Профиль </title>
  <style>
    body {
      font-family: "Inter", sans-serif;
      margin: 0;
      background: #f6f7fb;
      color: #222;
    }
    .page { max-width: 1100px; margin: 0 auto; padding: 20px; }

    /* Верхушка */
    .full-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      border-radius: 16px;
      padding: 20px 28px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .avatar {
      width: 80px; height: 80px; border-radius: 50%; object-fit: cover; cursor: pointer;
    }
    .small-muted { font-size: 14px; color: #777; }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 24px;
      border-bottom: 1px solid #ddd;
      margin-top: 28px;
    }
    .tabs a {
      text-decoration: none;
      color: #555;
      padding: 12px 8px;
      font-weight: 500;
      position: relative;
    }
    .tabs a.active {
      color: #1e9f5a;
    }
    .tabs a.active::after {
      content: "";
      position: absolute;
      bottom: -1px;
      left: 0; right: 0;
      height: 2px;
      background: #1e9f5a;
      border-radius: 2px;
    }

    /* Разделы */
    section { display: none; margin-top: 24px; }
    section.active { display: block; }

    /* МОИ МИЛИ */
    .miles-card {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .miles-top {
      display: flex; justify-content: space-between; align-items: center;
    }
    .miles-level {
      font-size: 20px;
      font-weight: 600;
      text-transform: uppercase;
      border-radius: 8px;
      padding: 4px 12px;
    }
    .miles-level.classic { background: #e0e0e0; color: #333; }
    .miles-level.master { background: #ffd84d; color: #333; }
    .miles-level.pro { background: #1e9f5a; color: #fff; }

    .progress-bg {
      background: #eee;
      border-radius: 8px;
      height: 8px;
      width: 100%;
      margin-top: 16px;
      position: relative;
    }
    .progress-fill {
      height: 8px;
      border-radius: 8px;
      transition: width 0.6s ease;
    }
    .progress-fill.classic { background: #ccc; }
    .progress-fill.master { background: #ffd84d; }
    .progress-fill.pro { background: #1e9f5a; }

    .miles-stats {
      display: flex;
      gap: 40px;
      margin-top: 20px;
    }
    .miles-stat {
      flex: 1;
      background: #f8f9fb;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .miles-stat strong { display: block; font-size: 20px; }

    .promo {
      margin-top: 24px;
      display: flex;
      gap: 12px;
    }
    .promo input {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .promo button {
      padding: 12px 20px;
      background: #1e9f5a;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    .promo button:hover { background: #19864c; }

    /* Магазин */
    #productGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .btn {
      background: #1e9f5a;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .btn.secondary { background: #ddd; color: #222; }

    /* Корзина */
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }

  </style>
</head>
<body>

<div class="page">

  <!-- Верхушка профиля -->
  <div class="full-header">
    <div style="display:flex;align-items:center;gap:16px">
      <label for="avatarInput" title="Загрузить фото">
        <img id="avatar" class="avatar" src="https://via.placeholder.com/150" alt="avatar">
      </label>
      <input id="avatarInput" type="file" accept="image/*" style="display:none">
      <div>
        <h1 id="fioHeader">Загрузка...</h1>
        <div class="small-muted" id="phoneHeader">—</div>
      </div>
    </div>

    <div style="text-align:right;min-width:260px">
      <div class="small-muted">Ваш уровень:</div>
      <div id="levelBadge" class="miles-level classic" style="display:inline-flex">Classic</div>
    </div>
  </div>

  <!-- Вкладки -->
  <div class="tabs">
    <a href="#" class="active" data-tab="profileTab" onclick="showTab(event)">Профиль</a>
    <a href="#" data-tab="milesTab" onclick="showTab(event)">Мои мили</a>
    <a href="#" data-tab="shopTab" onclick="showTab(event)">Магазин</a>
  </div>

  <!-- Разделы -->
  <section id="profileTab" class="active">
    <h2>Профиль</h2>
    <div class="small-muted">Имя: <span id="fioField"></span></div>
    <div class="small-muted">Email: <span id="emailField"></span></div>
    <div class="small-muted">Телефон: <span id="phoneField"></span></div>
    <div class="small-muted">Номер карты: <span id="card_field"></span></div>
  </section>

  <section id="myMiles">
    <h2>Мои мили</h2>
    <div class="miles-card">
      <div class="miles-top">
        <div>
          <div class="small-muted">Уровень программы:</div>
          <div id="milesLevel" class="miles-level classic">Classic</div>
        </div>
        <div id="milesProgressLabel" class="small-muted">0 / 1000</div>
      </div>
      <div class="progress-bg">
        <div id="milesProgressFill" class="progress-fill classic" style="width:0%"></div>
      </div>
      <div class="miles-stats">
        <div class="miles-stat"><strong id="milesBonus">0</strong>Бонусные мили</div>
        <div class="miles-stat"><strong id="milesStatus">0</strong>Статусные мили</div>
        <div class="miles-stat"><strong id="milesFlights">0</strong>Перелётов</div>
      </div>
      <div class="promo">
        <input id="promoInput" placeholder="Введите промокод">
        <button onclick="applyPromo()">Активировать</button>
      </div>
    </div>
  </section>

  <section id="shopTab">
    <h2>Магазин</h2>
    <div id="productGrid"></div>

    <h3>Корзина</h3>
    <table id="cartTable">
      <thead><tr><th>Товар</th><th>Цена</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:12px;">Итого: <strong id="cartTotal">0 ₽</strong></div>
    <button class="btn" style="margin-top:8px;" onclick="checkout()">Оформить заказ</button>
  </section>

</div>

<!-- Скрипт -->
<script>
const API = "https://s7avelii-airlines-1.onrender.com";
function getToken(){return localStorage.getItem("token");}
let currentUser=null; let products=[]; let cart=[];

async function apiFetch(endpoint,opt={}){
 const t=getToken(); opt.headers={...(opt.headers||{})};
 if(t)opt.headers.Authorization="Bearer "+t;
 if(opt.body && !(opt.body instanceof FormData) && typeof opt.body!=="string"){
  opt.headers["Content-Type"]="application/json"; opt.body=JSON.stringify(opt.body);
 }
 const r=await fetch(API+endpoint,opt); return r.ok?await r.json():null;
}

// === Профиль ===
async function loadProfile(){
 if(!currentUser)return;
 document.getElementById("fioHeader").textContent=currentUser.fio||"—";
 document.getElementById("fioField").textContent=currentUser.fio||"—";
 document.getElementById("emailField").textContent=currentUser.email||"—";
 document.getElementById("phoneField").textContent=currentUser.phone||"—";
 document.getElementById("card_field").textContent=currentUser.card_number||"—";

 document.getElementById("milesBonus").textContent=(currentUser.bonus_miles||0).toLocaleString();
 document.getElementById("milesStatus").textContent=(currentUser.status_miles||0).toLocaleString();
 document.getElementById("milesFlights").textContent=currentUser.flights||0;
 updateMilesUI();
}

function getLevel(m){if(m<1000)return"Classic";if(m<7000)return"Master";return"Pro";}
function getTarget(l){if(l==="Classic")return 1000;if(l==="Master")return 7000;return 100000;}

function updateMilesUI(){
 const s=currentUser.status_miles||0; const l=getLevel(s); const t=getTarget(l);
 const p=Math.min(100,(s/t)*100);
 const levelEl=document.getElementById("milesLevel");
 const fill=document.getElementById("milesProgressFill");
 levelEl.textContent=l; levelEl.className="miles-level "+l.toLowerCase();
 fill.className="progress-fill "+l.toLowerCase(); fill.style.width=p+"%";
 document.getElementById("milesProgressLabel").textContent=`${s.toLocaleString()} / ${t.toLocaleString()}`;
 document.getElementById("levelBadge").textContent=l;
 document.getElementById("levelBadge").className="miles-level "+l.toLowerCase();
}

async function applyPromo(){
 const code=document.getElementById("promoInput").value.trim();
 if(!code)return alert("Введите промокод");
 const res=await apiFetch("/api/promo",{method:"POST",body:{code}});
 if(res&&res.added){alert(`+${res.added} миль`);const upd=await apiFetch("/api/profile");
 if(upd){currentUser=upd;loadProfile();}} else alert(res?.error||"Ошибка");
 document.getElementById("promoInput").value="";
}

// === Магазин ===
async function loadShop(){
 const d=await apiFetch("/api/shop"); products=(d&&d.products)?d.products:[]; renderProducts();
}
function renderProducts(){
 const grid=document.getElementById("productGrid"); grid.innerHTML="";
 products.forEach(p=>{
  const div=document.createElement("div");
  div.className="card";
  div.innerHTML=`<div style='font-weight:600'>${p.name}</div>
                 <div class='small-muted'>${p.price} ₽</div>
                 <button class='btn' onclick='addToCart(${p.id})'>В корзину</button>`;
  grid.appendChild(div);
 });
}
function addToCart(id){const p=products.find(x=>x.id===id);if(!p)return;cart.push(p);renderCart();}
function removeFromCart(i){cart.splice(i,1);renderCart();}
function renderCart(){
 const tbody=document.querySelector("#cartTable tbody"); tbody.innerHTML="";
 let total=0; cart.forEach((p,i)=>{total+=p.price;
 const tr=document.createElement("tr");
 tr.innerHTML=`<td>${p.name}</td><td>${p.price} ₽</td><td><button class='btn secondary' onclick='removeFromCart(${i})'>×</button></td>`;
 tbody.appendChild(tr);
 });
 document.getElementById("cartTotal").textContent=total+" ₽";
}
async function checkout(){
 if(!cart.length)return alert("Корзина пуста");
 const res=await apiFetch("/api/checkout",{method:"POST",body:{items:cart}});
 if(res&&res.ok){cart=[];renderCart();alert("Заказ оформлен!");}
 else alert("Ошибка при заказе");
}

// === Переключение вкладок ===
function showTab(e){
 const tab=e.currentTarget.dataset.tab;
 document.querySelectorAll(".tabs a").forEach(a=>a.classList.remove("active"));
 e.currentTarget.classList.add("active");
 document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
 document.getElementById(tab).classList.add("active");
}

// === init ===
window.addEventListener("DOMContentLoaded",async()=>{
 if(!getToken()){window.location.href="auth.html";return;}
 const prof=await apiFetch("/api/profile");
 if(prof){currentUser=prof;loadProfile();}
 await loadShop();
});
</script>

</body>
</html>
