<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Кабинет — S7avelii</title>
  <link rel="icon" href="images/favicon.png" type="image/png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #f5f7fa;
      --card: #ffffff;
      --accent: #9cc42f;
      --muted: #8b97a6;
      --container: 1180px;
    }
    body { margin:0; font-family:Inter,Arial,sans-serif; background:var(--bg); color:#1f2937; }
    .page { max-width:var(--container); margin:28px auto; padding:0 20px; }
    .full-header { width:100%; background:var(--card); display:flex; align-items:center; gap:24px; padding:28px 36px; border-radius:12px; box-shadow:0 6px 20px rgba(16,24,40,0.06); flex-wrap:wrap; }
    .avatar-wrap { display:flex; align-items:center; gap:18px; flex-wrap:wrap; }
    .avatar { width:118px; height:118px; border-radius:999px; object-fit:cover; border:4px solid #fff; box-shadow:0 6px 18px rgba(16,24,40,0.06); cursor:pointer; }
    .user-info h1 { margin:0; font-size:26px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .edit-icon { font-size:14px; background:#eef9d6; border-radius:999px; padding:6px 8px; cursor:pointer; color:#1f3a07; }
    .card-badge { width:60px; border-radius:8px; display:none; }
    .sub { color:var(--muted); margin-top:6px; }
    .stats { margin-left:auto; display:flex; gap:18px; align-items:center; flex-wrap:wrap; }
    .stat { background:linear-gradient(180deg,#fff,#fcfff0); padding:14px 18px; border-radius:12px; min-width:110px; text-align:center; border:1px solid rgba(0,0,0,0.04); }
    .num { font-weight:700; font-size:20px; color:#111827; }
    .label { font-size:12px; color:var(--muted); margin-top:6px; }
    .tabs { display:flex; gap:14px; margin-top:18px; padding:12px 0; border-bottom:1px solid rgba(0,0,0,0.04); overflow-x:auto; }
    .tabs a { padding:10px 14px; text-decoration:none; color:#495057; border-radius:8px; white-space:nowrap; }
    .tabs a.active { color:var(--accent); background:rgba(156,196,47,0.06); }
    .grid { display:grid; grid-template-columns:1fr 380px; gap:22px; margin-top:18px; }
    .card { background:var(--card); border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(16,24,40,0.04); border:1px solid rgba(0,0,0,0.03); }
    .card h3 { margin:0 0 12px; font-size:18px; }
    .field { display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-top:1px solid rgba(0,0,0,0.03); }
    .field:first-of-type { border-top:0; }
    .label { color:var(--muted); font-size:14px; }
    .value { font-size:15px; max-width:60%; word-wrap:break-word; }
    .edit-btn { background:transparent; border:none; color:var(--accent); cursor:pointer; font-weight:600; }
    .small-muted { color:var(--muted); font-size:13px; margin-top:8px; }
    .btn { display:inline-block; background:var(--accent); color:#fff; padding:9px 14px; border-radius:10px; border:none; cursor:pointer; }
    .save-notice { color:var(--muted); font-size:13px; margin-left:8px; }
    @media (max-width:980px){ .grid{grid-template-columns:1fr;} .stats{margin-left:0;margin-top:16px;} .full-header{flex-direction:column;align-items:flex-start;gap:16px;} }
  </style>
</head>
<body>
<div class="page">
  <div class="full-header">
    <div class="avatar-wrap">
      <label for="avatarInput"><img id="avatar" class="avatar" src="https://via.placeholder.com/150" alt="avatar"></label>
      <input id="avatarInput" type="file" accept="image/*" style="display:none">
      <div class="user-info">
        <h1 id="fioHeader">Пользователь
          <img id="cardTypeImg" class="card-badge" alt="Card">
          <span class="edit-icon" id="editNameBtn" title="Изменить">✏</span>
        </h1>
        <div class="sub" id="phoneHeader">—</div>
      </div>
    </div>

    <div class="stats" aria-hidden="false">
      <div class="stat">
        <div class="num" id="bonusMiles">—</div>
        <div class="label">бонусные мили</div>
      </div>
    </div>
  </div>

  <div class="tabs" role="tablist">
    <a href="#" class="active" data-tab="profileTab" onclick="showTab(event)">Профиль</a>
    <a href="#" data-tab="milesTab" onclick="showTab(event)">Мои мили</a>
    <a href="#" data-tab="shopTab" onclick="showTab(event)">S7avelii Shop</a>
    <a href="#" data-tab="settingsTab" onclick="showTab(event)">Настройки</a>
  </div>

  <div class="grid">
    <!-- Left column -->
    <div>
      <div id="profileTab" class="card">
        <h3>Персональные данные</h3>
        <div class="field"><div><div class="label">ФИО</div><div class="value" id="fioField">—</div></div><button class="edit-btn" onclick="enableEdit('fio')">Изменить</button></div>
        <div class="field"><div><div class="label">Дата рождения</div><div class="value" id="dobField">—</div></div><button class="edit-btn" onclick="enableEdit('dob')">Изменить</button></div>
        <div class="field"><div><div class="label">Пол</div><div class="value" id="genderField">—</div></div><button class="edit-btn" onclick="enableEdit('gender')">Изменить</button></div>
        <h3 style="margin-top:18px">Контакты</h3>
        <div class="field"><div><div class="label">Email</div><div class="value" id="emailField">—</div></div><button class="edit-btn" onclick="enableEdit('email')">Изменить</button></div>
        <div class="field"><div><div class="label">Телефон</div><div class="value" id="phoneField">—</div></div><button class="edit-btn" onclick="enableEdit('phone')">Изменить</button></div>
        <div class="field"><div><div class="label">Номер карты</div><div class="value" id="cardField">—</div></div><button class="edit-btn" onclick="enableEdit('cardNumber')">Изменить</button></div>
        <div class="field"><div><div class="label">Тип карты</div><div class="value" id="cardTypeField">—</div></div></div>
      </div>
    </div>

    <!-- Right column -->
    <div>
      <div class="card">
        <h3>Краткая информация</h3>
        <div style="margin-top:12px" class="small-muted">Здесь отображаются основные данные и быстрые действия.</div>
        <div style="margin-top:18px;display:flex;flex-direction:column;gap:12px">
          <button onclick="goTo('profileTab')" class="edit-btn">Редактировать профиль</button>
          <button onclick="goTo('milesTab')" class="edit-btn">Посмотреть мили</button>
          <div style="display:flex;align-items:center;gap:12px">
            <button onclick="logout()" class="edit-btn">Выйти</button>
            <div id="saveInfo" class="save-notice"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Подсказка</h3>
        <div class="small-muted" style="margin-top:8px">Изменённые данные сохраняются в личном профиле и отправляются на сервер (если он есть).</div>
      </div>
    </div>
  </div>
</div>

<script>
/* Utility */
function el(id){ return document.getElementById(id); }
function showMsg(msg, time=2500){ const s = el('saveInfo'); s.innerText = msg; setTimeout(()=>{ if(s.innerText===msg) s.innerText=''; }, time); }

/* Tabs */
function showTab(evt){
  evt && evt.preventDefault();
  const tabId = evt ? evt.currentTarget.getAttribute('data-tab') : 'profileTab';
  document.querySelectorAll('.tabs a').forEach(a=>a.classList.remove('active'));
  if(evt) evt.currentTarget.classList.add('active');
  ['profileTab','milesTab','shopTab','settingsTab'].forEach(id=>{
    const elc = document.getElementById(id);
    if(elc) elc.style.display = (id===tabId ? 'block' : 'none');
  });
}

/* Robust profile loading:
   Accepts server returning either:
     1) { ok: true, user: {...} }
     2) {...profile...}
*/
async function loadProfile(){
  try{
    const res = await fetch('/api/profile', { credentials:'include' });
    if(!res.ok){
      // not logged in -> redirect to auth
      window.location.href = 'auth.html';
      return;
    }
    const payload = await res.json().catch(()=>null);
    if(!payload){ throw new Error('invalid json'); }

    // normalize
    let profile = null;
    if(payload.user) profile = payload.user;
    else if(payload.ok && payload.user) profile = payload.user;
    else profile = payload;

    applyProfile(profile);
  }catch(err){
    console.error('Ошибка загрузки профиля', err);
    // best effort: if we have localStorage fallback, use it; otherwise force login
    const fallback = {
      fio: localStorage.getItem('fio') || '',
      phone: localStorage.getItem('phone') || '',
      email: localStorage.getItem('email') || '',
      cardNumber: localStorage.getItem('cardNumber') || '',
      dob: localStorage.getItem('dob') || '',
      gender: localStorage.getItem('gender') || '',
      avatar: localStorage.getItem('avatar') || '',
      bonusMiles: localStorage.getItem('bonusMiles') || ''
    };
    // if there's anything — apply, otherwise redirect
    if(fallback.fio || fallback.phone || fallback.email || fallback.cardNumber){
      applyProfile(fallback);
      showMsg('Отображаются локальные данные');
    } else {
      window.location.href = 'auth.html';
    }
  }
}

/* Apply profile to UI (supports both cardNumber/card) */
function applyProfile(p){
  p = p || {};
  const cardNumber = p.cardNumber || p.card || '';
  el('fioField').innerText = p.fio || '—';
  el('dobField').innerText = p.dob || '—';
  el('genderField').innerText = p.gender || '—';
  el('emailField').innerText = p.email || '—';
  el('phoneField').innerText = p.phone || '—';
  el('cardField').innerText = cardNumber || '—';
  // header name (keep any existing edit icon)
  const fioHeader = el('fioHeader');
  // set only text node, preserve edit icon element
  if(fioHeader){
    // remove existing text nodes then insert new text node at start
    // safer way: set firstChild textContent if exists and is text node
    const first = fioHeader.childNodes[0];
    if(first && first.nodeType === Node.TEXT_NODE){
      first.textContent = p.fio || 'Пользователь';
    } else {
      fioHeader.insertBefore(document.createTextNode(p.fio || 'Пользователь'), fioHeader.firstChild);
    }
  }
  el('phoneHeader').innerText = p.phone || '';
  el('bonusMiles').innerText = (p.bonusMiles !== undefined && p.bonusMiles !== null) ? p.bonusMiles : '—';
  if(p.avatar) el('avatar').src = p.avatar;

  el('cardTypeField').innerText = p.cardType || '—';
  const img = el('cardTypeImg');
  if(p.cardType === 'VIP'){ img.src = 'images/vip.png'; img.style.display = 'inline-block'; }
  else if(p.cardType === 'Classic'){ img.src = 'images/classic.png'; img.style.display = 'inline-block'; }
  else { img.style.display = 'none'; }

  // persist locally as backup
  try{
    localStorage.setItem('fio', p.fio || '');
    localStorage.setItem('phone', p.phone || '');
    localStorage.setItem('email', p.email || '');
    localStorage.setItem('cardNumber', cardNumber || '');
    if(p.avatar) localStorage.setItem('avatar', p.avatar);
    if(p.dob) localStorage.setItem('dob', p.dob);
    if(p.gender) localStorage.setItem('gender', p.gender);
    if(p.bonusMiles !== undefined) localStorage.setItem('bonusMiles', String(p.bonusMiles));
  }catch(e){}
}

/* Inline edit for fields */
function enableEdit(field){
  const fieldMap = {
    fio: ['fioField','fioHeader'],
    dob: ['dobField'],
    gender: ['genderField'],
    email: ['emailField'],
    phone: ['phoneField','phoneHeader'],
    cardNumber: ['cardField']
  };
  const ids = fieldMap[field];
  if(!ids) return;
  const containerId = ids[0];
  const container = el(containerId);
  const current = container.innerText === '—' ? '' : container.innerText;
  const input = document.createElement('input');
  input.type = (field === 'email') ? 'email' : (field === 'phone') ? 'tel' : 'text';
  input.value = current;
  input.style.width = '220px';
  const ok = document.createElement('button'); ok.innerText = 'OK'; ok.className = 'btn'; ok.style.marginLeft = '8px';
  const cancel = document.createElement('button'); cancel.innerText = 'Отмена'; cancel.className = 'edit-btn'; cancel.style.marginLeft='8px';
  const wrapper = document.createElement('div');
  wrapper.appendChild(input); wrapper.appendChild(ok); wrapper.appendChild(cancel);
  container.innerHTML = '';
  container.appendChild(wrapper);
  input.focus();

  cancel.onclick = function(e){ e.preventDefault(); // restore original display
    ids.forEach(id => { if(el(id)) el(id).innerText = current || '—'; });
  };

  ok.onclick = async function(e){
    e.preventDefault();
    const val = input.value.trim();
    const saveVal = val || '';
    // update UI immediately
    ids.forEach(id => { if(el(id)) el(id).innerText = saveVal || '—'; });
    if(field === 'fio' && el('fioHeader')){
      const fh = el('fioHeader');
      const first = fh.childNodes[0];
      if(first && first.nodeType === Node.TEXT_NODE) first.textContent = saveVal || 'Пользователь';
      else fh.insertBefore(document.createTextNode(saveVal || 'Пользователь'), fh.firstChild);
    }
    // local fallback
    try{ localStorage.setItem(field === 'cardNumber' ? 'cardNumber' : field, saveVal); }catch(e){}
    showMsg('Сохраняю...');
    // prepare payload: server uses cardNumber key
    const payloadKey = field === 'cardNumber' ? 'cardNumber' : field;
    const payload = {};
    payload[payloadKey] = saveVal;
    // try primary endpoint, fallback if necessary
    try{
      const ok1 = await postProfileUpdate(payload);
      if(ok1){
        showMsg('Сохранено');
      } else {
        showMsg('Локально сохранено (сервер недоступен)');
      }
    }catch(e){
      console.error('Ошибка при обновлении', e);
      showMsg('Ошибка обновления');
    }
  };
}

/* Avatar upload: read as dataURL, update local UI and sync */
el('avatarInput').addEventListener('change', function(){
  const f = this.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = async function(e){
    const dataUrl = e.target.result;
    el('avatar').src = dataUrl;
    try{ localStorage.setItem('avatar', dataUrl); }catch(e){}
    showMsg('Загружаю аватар...');
    try{
      const ok = await postProfileUpdate({ avatar: dataUrl });
      if(ok) showMsg('Аватар сохранён');
      else showMsg('Аватар сохранён локально');
    }catch(e){ console.error('avatar upload err', e); showMsg('Ошибка сохранения аватара'); }
  };
  r.readAsDataURL(f);
});

/* postProfileUpdate: tries /api/profile/update, falls back to /api/update-profile */
async function postProfileUpdate(obj){
  try{
    // first try expected endpoint
    let res = await fetch('/api/profile/update', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(obj)
    });
    if(res.ok) return true;
    // try fallback
    res = await fetch('/api/update-profile', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(obj)
    });
    return res.ok;
  }catch(e){
    return false;
  }
}

/* Logout */
async function logout(){
  try{
    await fetch('/api/logout', { method:'POST', credentials:'include' });
  }catch(e){}
  // clear session markers (do not wipe profile completely)
  try{
    localStorage.removeItem('session');
  }catch(e){}
  window.location.href = 'auth.html';
}

/* goTo helper */
function goTo(tab){
  document.querySelectorAll('.tabs a').forEach(a => a.classList.remove('active'));
  const a = [...document.querySelectorAll('.tabs a')].find(x=> x.getAttribute('data-tab')===tab);
  if(a) a.classList.add('active');
  showTab({ currentTarget: a, preventDefault: ()=>{} });
}

/* init */
document.addEventListener('DOMContentLoaded', ()=>{
  loadProfile();
  showTab({ currentTarget: document.querySelector('.tabs a.active'), preventDefault: ()=>{} });
  el('editNameBtn').addEventListener('click', ()=> enableEdit('fio'));
});
</script>
</body>
</html>
