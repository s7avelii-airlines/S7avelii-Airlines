<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Кабинет — S7avelii</title>
<link rel="icon" href="images/favicon.png" type="image/png">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { margin:0; font-family: Arial, sans-serif; background:#f5f7fa; }
  header { display:flex; align-items:center; justify-content:space-between; padding:0 16px; height:60px; border-bottom:1px solid #ccc; position:fixed; top:0; width:100%; background:#fff; z-index:1000; }
  .logo-img { height:45px; cursor:pointer; }
  nav ul { display:flex; gap:20px; margin:0; padding:0; list-style:none; }
  nav a { text-decoration:none; color:#000; font-size:14px; }
  .right-menu { display:flex; align-items:center; gap:10px; font-size:14px; }
  .hamburger { display:none; flex-direction:column; gap:4px; cursor:pointer; }
  .hamburger span { width:22px; height:2px; background:#000; }
  .bottom-nav { display:none; position:fixed; bottom:0; left:0; width:100%; background:rgba(255,255,255,0.95); border-top:1px solid #ddd; justify-content:space-around; padding:6px 0; z-index:1000; }
  .bottom-nav a { text-decoration:none; color:#666; font-size:12px; display:flex; flex-direction:column; align-items:center; }
  .bottom-nav a.active { color:#6cd100; font-weight:bold; }
  .bottom-nav svg { width:22px; height:22px; margin-bottom:3px; }
  @media (max-width:768px) { nav{display:none;} .hamburger{display:flex;} .bottom-nav{display:flex;} header{height:60px;padding:0 12px;} .logo-img{height:40px;} }
  .page{max-width:1180px;margin:80px auto;padding:0 20px}
  .full-header{width:100%;background:#fff;display:flex;align-items:center;gap:24px;padding:28px 36px;border-radius:12px;box-shadow:0 6px 20px rgba(16,24,40,0.06);flex-wrap:wrap}
  .avatar{width:118px;height:118px;border-radius:999px;object-fit:cover;border:4px solid #fff}
  .tabs{display:flex;gap:14px;margin-top:18px;padding:12px 0;border-bottom:1px solid rgba(0,0,0,0.04);overflow-x:auto}
  .tabs a{padding:10px 14px;text-decoration:none;color:#495057;border-radius:8px;cursor:pointer}
  .tabs a.active{color:#9cc42f;background:rgba(156,196,47,0.06)}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:22px;margin-top:18px}
  .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(16,24,40,0.04)}
  .field{display:flex;justify-content:space-between;padding:12px 0;border-top:1px solid rgba(0,0,0,0.03)}
  .small-muted{color:#8b97a6;font-size:13px}
  .btn{background:#9cc42f;color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .btn-red{background:#e66}
  .progress-bar{width:100%;height:18px;background:#eee;border-radius:10px;overflow:hidden;margin-top:6px}
  .progress-fill{height:100%;width:0%;background:#9cc42f;text-align:center;color:#fff;line-height:18px;font-size:12px;transition:width 0.5s ease}
  .cart-table{width:100%;border-collapse:collapse}
  .cart-table th,.cart-table td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .cart-empty{color:#777;padding:12px}
</style>
</head>
<body>
<header>
  <div class="logo">
    <a href="index.html"><img src="images/1757683264306.avif" alt="S7avelii" class="logo-img"></a>
  </div>
  <nav>
    <ul>
      <li><a href="bilet.html">Купить билет</a></li>
      <li><a href="priority.html">S7avelii Priority</a></li>
      <li><a href="body.html">Информация</a></li>
    </ul>
  </nav>
  <div class="right-menu">
    <button>RUB</button>
  </div>
</header>

<div class="page">
  <div class="full-header">
    <div style="display:flex;align-items:center;gap:16px">
      <label for="avatarInput"><img id="avatar" class="avatar" src="https://via.placeholder.com/150" alt="avatar"></label>
      <input id="avatarInput" type="file" accept="image/*" style="display:none">
      <div>
        <h1 id="fioHeader">Загрузка...</h1>
        <div class="small-muted" id="phoneHeader">—</div>
      </div>
    </div>
    <div style="margin-left:auto" class="small-muted">Бонусные мили: <strong id="bonusMiles">—</strong>
      <div class="progress-bar"><div class="progress-fill" id="milesProgress">0%</div></div>
    </div>
  </div>

  <div class="tabs" role="tablist">
    <a class="active" data-tab="profileTab" onclick="showTab(event)">Профиль</a>
    <a data-tab="milesTab" onclick="showTab(event)">Мои мили</a>
    <a data-tab="shopTab" onclick="showTab(event)">S7avelii Shop</a>
    <a data-tab="settingsTab" onclick="showTab(event)">Настройки</a>
  </div>

  <div class="grid">
    <div>
      <div id="profileTab" class="card">
        <h3>Персональные данные</h3>
        <div class="field"><div><div class="small-muted">ФИО</div><div id="fioField">—</div></div><button class="btn" onclick="enableEdit('fio')">Изменить</button></div>
        <div class="field"><div><div class="small-muted">Дата рождения</div><div id="dobField">—</div></div><button class="btn" onclick="enableEdit('dob')">Изменить</button></div>
        <div class="field"><div><div class="small-muted">Пол</div><div id="genderField">—</div></div><button class="btn" onclick="enableEdit('gender')">Изменить</button></div>

        <h3 style="margin-top:16px">Контакты</h3>
        <div class="field"><div><div class="small-muted">Email</div><div id="emailField">—</div></div><button class="btn" onclick="enableEdit('email')">Изменить</button></div>
        <div class="field"><div><div class="small-muted">Телефон</div><div id="phoneField">—</div></div><button class="btn" onclick="enableEdit('phone')">Изменить</button></div>

        <h3 style="margin-top:16px">Карта</h3>
        <div class="field"><div><div class="small-muted">Номер карты</div><div id="cardField">—</div></div><button class="btn" onclick="enableEdit('cardNumber')">Изменить</button></div>
        <div class="field"><div><div class="small-muted">Тип карты</div><div id="cardTypeField">—</div></div></div>
      </div>

     <div style="max-width:600px; margin:20px auto; font-family:Arial, sans-serif; color:#333;">
  <div style="background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:20px;">
    
    <h2 style="font-size:18px; font-weight:600; margin-bottom:10px;">
      Статус в программе <a href="#" style="color:#1a73e8; text-decoration:none;">S7 Priority</a>
    </h2>

    <div style="margin-bottom:20px;">
      <div style="font-size:14px; color:#666;">Ваш статус:</div>
      <div id="statusName" style="font-size:20px; font-weight:bold;">Classic</div>
    </div>

    <div style="background:#f9fafb; border-radius:10px; padding:15px; margin-bottom:20px;">
      <div style="font-size:24px; font-weight:bold; margin-bottom:5px;">
        <span id="milesValue">0</span> бонусные мили
      </div>
    </div>

    <!-- Прогресс -->
    <div style="margin-bottom:10px; font-size:14px;">
      <span id="currentMiles" style="background:#8bc34a; color:#fff; border-radius:8px; padding:2px 8px; font-weight:bold;">0 миль</span>
      <span style="margin-left:10px; color:#666;">0 полётов</span>
    </div>

    <div style="background:#e9ecef; border-radius:6px; height:12px; width:100%; overflow:hidden;">
      <div id="milesProgress" style="background:#8bc34a; height:100%; width:0%;"></div>
    </div>

    <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:12px; color:#999;">
      <span id="nextLevelName">Classic Master</span>
      <span id="nextLevelMiles">5000</span>
    </div>

    <div style="margin-top:15px; font-size:14px; color:#666;">
      Статусных миль: <b id="statusMiles">0</b><br>
      Полётов: <b id="flights">0</b>
    </div>

    <!-- Привилегии -->
    <div style="margin-top:20px;">
      <h3 style="font-size:15px; margin-bottom:10px; color:#444;">Привилегии статуса:</h3>
      <ul id="privileges" style="list-style:none; padding-left:15px; color:#333;">
        <!-- сюда вставим пункты -->
      </ul>
    </div>

    <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">

    <div style="font-size:14px; color:#444; display:flex; justify-content:space-between; align-items:center;">
      <div>
        Дата регистрации: <b id="registrationDate"></b>
      </div>
      <div>
        Состояние счёта: <b style="color:#2e7d32;" id="accountStatus">Активный</b>
      </div>
    </div>

  </div>
</div>

<script>
  // Настройки статусов
  const statuses = {
    Classic: {
      name: "Classic",
      nextLevel: "Classic Master",
      maxMiles: 5000,
      color: "#8bc34a",
      privileges: [
        "Бонусные мили копятся за покупки на сайте и в приложении. Можно тратить на авиабилеты и допуслуги.",
        "Статусные мили копятся за полеты и покупки по карте S7 — T-Bank."
      ]
    },
    VIP: {
      name: "VIP",
      nextLevel: "VIP Gold",
      maxMiles: 25000,
      color: "#fbc02d",
      privileges: [
        "Приоритетная регистрация и посадка.",
        "Доступ в бизнес-залы аэропортов.",
        "Бонусные и статусные мили за полёты и покупки."
      ]
    }
  };

  function updateStatus(type, miles, flights=0, registration="06 июл 2021", account="Активный") {
    const s = statuses[type];
    const percent = Math.min(100, (miles / s.maxMiles) * 100);

    document.getElementById("statusName").textContent = s.name;
    document.getElementById("milesValue").textContent = miles;
    document.getElementById("statusMiles").textContent = miles;
    document.getElementById("flights").textContent = flights;
    document.getElementById("currentMiles").textContent = miles + " миль";
    document.getElementById("nextLevelName").textContent = s.nextLevel;
    document.getElementById("nextLevelMiles").textContent = s.maxMiles;

    const progress = document.getElementById("milesProgress");
    progress.style.width = percent + "%";
    progress.style.background = s.color;
    document.getElementById("currentMiles").style.background = s.color;

    // Привилегии
    const list = document.getElementById("privileges");
    list.innerHTML = "";
    s.privileges.forEach(p => {
      const li = document.createElement("li");
      li.innerHTML = "• " + p;
      li.style.marginBottom = "5px";
      list.appendChild(li);
    });

    // Дата и статус
    document.getElementById("registrationDate").textContent = registration;
    document.getElementById("accountStatus").textContent = account;
  }

  // 🔹 Тест: Classic
  updateStatus("Classic", 1057, 0, "06 июл 2021", "Активный");

  // 🔹 Пример VIP:
  // updateStatus("VIP", 12340, 5, "15 мар 2022", "Активный");
</script>


      <div id="shopTab" class="card" style="display:none">
        <h3>Корзина</h3>
        <div id="cartContainer"><div class="cart-empty">Загрузка корзины...</div></div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="checkoutBtn" onclick="checkout()" disabled>Оформить заказ</button>
          <button class="btn" id="clearCartBtn" onclick="clearCart()" style="background:#999">Очистить корзину</button>
        </div>
        <div id="cartMsg" class="small-muted" style="margin-top:8px"></div>
      </div>

      <div id="settingsTab" class="card" style="display:none">
        <h3>Настройки</h3>
        <div class="field">
          <div><div class="small-muted">Сменить пароль</div><input type="password" id="newPassword" placeholder="Новый пароль"></div>
          <button class="btn" onclick="changePassword()">Сменить</button>
        </div>
        <div class="field">
          <div><div class="small-muted">Привязка VK</div><button class="btn" onclick="bindVK()">Привязать</button></div>
        </div>
        <div class="field">
          <div><div class="small-muted">Привязка Telegram</div><button class="btn" onclick="bindTelegram()">Привязать</button></div>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <h3>Быстрые действия</h3>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn" onclick="goTo('profileTab')">Редактировать профиль</button>
          <button class="btn" onclick="goTo('shopTab')">Открыть корзину</button>
          <button class="btn btn-red" onclick="logout()">Выйти</button>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Заказы</h3>
        <div id="ordersContainer" class="small-muted" style="margin-top:8px">Загрузка...</div>
      </div>
    </div>
  </div>
</div>

<script>
const el = id => document.getElementById(id);
function showTab(evt){ 
  evt && evt.preventDefault();
  const tabId = evt ? evt.currentTarget.getAttribute('data-tab') : 'profileTab';
  document.querySelectorAll('.tabs a').forEach(a=>a.classList.remove('active'));
  if(evt) evt.currentTarget.classList.add('active');
  ['profileTab','milesTab','shopTab','settingsTab'].forEach(id=>{ const e = el(id); e.style.display = id===tabId?'block':'none'; });
  if(tabId==='shopTab') loadCart();
}

// profile
async function loadProfile(){
  try{
    const res = await fetch('/api/profile',{credentials:'include'});
    if(!res.ok){ window.location.href='auth.html'; return; }
    const j = await res.json();
    applyProfile(j.user || j);
  } catch(e){ window.location.href='auth.html'; }
}
function applyProfile(p){
  el('fioField').innerText = p.fio||'—';
  el('dobField').innerText = p.dob||'—';
  el('genderField').innerText = p.gender||'—';
  el('emailField').innerText = p.email||'—';
  el('phoneField').innerText = p.phone||'—';
  el('cardField').innerText = p.cardNumber||'—';
  el('cardTypeField').innerText = p.cardType||'—';
  el('fioHeader').innerText = p.fio||'Пользователь';
  el('bonusMiles').innerText = p.bonusMiles||0;
  el('milesBar').style.width = Math.min((p.bonusMiles||0)/1000*100,100)+'%';
  el('milesBar').innerText = p.bonusMiles||0;
  if(p.avatar) el('avatar').src=p.avatar;
  renderOrders(p.orders||[]);
}
function renderOrders(orders){
  const o = el('ordersContainer'); o.innerHTML='';
  if(!orders.length){ o.innerText='Заказы отсутствуют'; return; }
  orders.slice().reverse().forEach(ord=>{
    const d = document.createElement('div');
    d.style.marginBottom='10px';
    d.innerHTML=`<strong>Заказ ${ord.id}</strong> — ${new Date(ord.createdAt).toLocaleString()} — ${ord.status}<br>Товаров: ${ord.items.length} — Сумма: ${ord.total} ₽`;
    o.appendChild(d);
  });
}

// edit profile
function enableEdit(field){
  const map={fio:['fioField','fioHeader'],dob:['dobField'],gender:['genderField'],email:['emailField'],phone:['phoneField'],cardNumber:['cardField']};
  const ids=map[field]; if(!ids) return;
  const cur = el(ids[0]).innerText==='—'?'':el(ids[0]).innerText;
  const input=document.createElement('input'); input.value=cur; input.style.width='220px';
  const ok=document.createElement('button'); ok.innerText='OK'; ok.className='btn'; ok.style.marginLeft='8px';
  const wrapper=document.createElement('div'); wrapper.appendChild(input); wrapper.appendChild(ok);
  const container = el(ids[0]); container.innerHTML=''; container.appendChild(wrapper); input.focus();
  ok.onclick=async()=>{
    const val=input.value.trim()||'';
    ids.forEach(id=>{ if(el(id)) el(id).innerText=val||'—'; });
    if(field==='fio' && el('fioHeader')) el('fioHeader').innerText=val||'Пользователь';
    try{
      await fetch('/api/profile/update',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({[field]:val})});
      await loadProfile();
    }catch(e){console.error(e);}
  };
}

// avatar
el('avatarInput').addEventListener('change', function(){
  const f=this.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async e=>{
    el('avatar').src=e.target.result;
    await fetch('/api/profile/update',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({avatar:e.target.result})});
  };
  r.readAsDataURL(f);
});

// cart
async function loadCart(){
  const container=el('cartContainer'); container.innerHTML='<div class="cart-empty">Загрузка корзины...</div>';
  try{
    const res=await fetch('/api/cart',{credentials:'include'});
    if(!res.ok){ container.innerHTML='Для работы корзины нужно войти — <a href="/auth.html">войти</a>'; el('checkoutBtn').disabled=true; return; }
    const j=await res.json(); renderCart(j.cart||[]);
  }catch(e){ container.innerHTML='<div class="cart-empty">Ошибка сети</div>'; el('checkoutBtn').disabled=true; }
}
function renderCart(cart){
  const container=el('cartContainer'); if(!cart.length){ container.innerHTML='<div class="cart-empty">Корзина пуста</div>'; el('checkoutBtn').disabled=true; return; }
  const table=document.createElement('table'); table.className='cart-table';
  table.innerHTML='<thead><tr><th>Товар</th><th>Цена</th><th>Кол-во</th><th>Действие</th></tr></thead>';
  const tbody=document.createElement('tbody'); let total=0;
  cart.forEach(item=>{
    const tr=document.createElement('tr'); const priceNum=parseFloat((item.price||0)); total+=priceNum*(item.qty||1);
    tr.innerHTML=`<td><img src="${item.image||''}" style="width:48px;height:48px;object-fit:cover;margin-right:8px;vertical-align:middle">${item.title}</td>
      <td>${item.price}</td><td>${item.qty||1}</td><td><button class="btn" onclick="removeFromCart('${item.id}')">Удалить</button></td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); const footer=document.createElement('div'); footer.style.marginTop='12px'; footer.innerHTML=`<strong>Итого: ${total} ₽</strong>`;
  container.innerHTML=''; container.appendChild(table); container.appendChild(footer); el('checkoutBtn').disabled=false;
}
async function checkout(){
  if(!confirm('Оформить заказ?')) return;
  const res=await fetch('/api/cart/checkout',{method:'POST',credentials:'include'}); const j=await res.json();
  if(!res.ok){ alert(j.error||'Ошибка'); return; }
  loadCart(); el('cartMsg').innerText='Заказ принят!'; setTimeout(()=>el('cartMsg').innerText='',2000); loadProfile();
}
async function clearCart(){ if(!confirm('Очистить корзину?')) return;
  await fetch('/api/cart/clear',{method:'POST',credentials:'include'}); loadCart(); el('cartMsg').innerText='Корзина очищена'; setTimeout(()=>el('cartMsg').innerText='',2000);
}
async function removeFromCart(id){ await fetch('/api/cart/remove',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}); loadCart(); }

// settings
async function changePassword(){
  const val=el('newPassword').value.trim(); if(!val){alert('Введите новый пароль');return;}
  const res=await fetch('/api/profile/update',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({password:val})});
  if(res.ok){alert('Пароль изменён'); el('newPassword').value='';} else alert('Ошибка');
}
function bindVK(){alert('Привязка VK пока не реализована');}
function bindTelegram(){alert('Привязка Telegram пока не реализована');}

function goTo(tab){ document.querySelectorAll('.tabs a').forEach(a=>a.classList.remove('active')); const a=[...document.querySelectorAll('.tabs a')].find(x=>x.dataset.tab===tab); if(a) a.classList.add('active'); showTab({currentTarget:a,preventDefault:()=>{}});}
async function logout(){ await fetch('/api/logout',{method:'POST',credentials:'include'}); window.location.href='auth.html'; }

document.addEventListener('DOMContentLoaded',async()=>{
  await loadProfile(); showTab({currentTarget:document.querySelector('.tabs a.active'),preventDefault:()=>{}});
});
</script>
</body>
</html>
