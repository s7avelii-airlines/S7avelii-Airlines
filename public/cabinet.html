<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Кабинет — S7avelii</title>
  <link rel="icon" href="images/favicon.png" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* сохранён внешний вид близкий к твоему */
    :root{--accent:#9cc42f;--muted:#8b97a6}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,sans-serif;background:#f5f7fa;color:#1f2937}
    header{display:flex;align-items:center;justify-content:space-between;padding:0 16px;height:60px;border-bottom:1px solid #e6e6e6;position:fixed;top:0;left:0;width:100%;background:#fff;z-index:1000}
    .logo-img{height:45px;cursor:pointer}
    nav ul{display:flex;gap:20px;margin:0;padding:0;list-style:none}
    nav a{text-decoration:none;color:#111}
    .page{max-width:1180px;margin:90px auto;padding:0 20px}
    .full-header{background:#fff;display:flex;align-items:center;gap:24px;padding:24px;border-radius:12px;box-shadow:0 6px 20px rgba(16,24,40,0.06);flex-wrap:wrap}
    .avatar{width:110px;height:110px;border-radius:999px;object-fit:cover;border:4px solid #fff;cursor:pointer}
    .tabs{display:flex;gap:14px;margin-top:18px;padding:12px 0;border-bottom:1px solid rgba(0,0,0,0.04);overflow-x:auto}
    .tabs a{padding:10px 14px;text-decoration:none;color:#495057;border-radius:8px;cursor:pointer}
    .tabs a.active{color:var(--accent);background:rgba(156,196,47,0.06)}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:22px;margin-top:18px}
    .card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 4px 12px rgba(16,24,40,0.04)}
    .field{display:flex;justify-content:space-between;padding:12px 0;border-top:1px solid rgba(0,0,0,0.03)}
    .small-muted{color:var(--muted);font-size:13px}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn.secondary{background:#eef2f7;color:#111}
    .btn.red{background:#e66}
    .progress-wrap{width:100%;margin-top:8px}
    .progress-bg{width:100%;height:14px;background:#eee;border-radius:999px;overflow:hidden}
    .progress-fill{height:100%;width:0%;background:var(--accent);transition:width .6s ease}
    .cart-table{width:100%;border-collapse:collapse}
    .cart-table th,.cart-table td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .muted{color:var(--muted)}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <div class="logo"><a href="index.html"><img src="images/1757683264306.avif" class="logo-img" alt="S7avelii"></a></div>
  <nav><ul><li><a href="bilet.html">Купить билет</a></li><li><a href="priority.html">S7avelii Priority</a></li><li><a href="body.html">Информация</a></li></ul></nav>
  <div class="right-menu">
    <button class="btn secondary" id="homeUserBtn">Вход</button>
  </div>
</header>

<div class="page">
  <div class="full-header">
    <div style="display:flex;align-items:center;gap:16px">
      <label for="avatarInput" title="Нажмите чтобы загрузить фото">
        <img id="avatar" class="avatar" src="https://via.placeholder.com/150" alt="avatar">
      </label>
      <input id="avatarInput" type="file" accept="image/*" style="display:none">
      <div>
        <h1 id="fioHeader">Загрузка...</h1>
        <div class="small-muted" id="phoneHeader">—</div>
      </div>
    </div>

    <div style="margin-left:auto;min-width:260px">
      <div class="small-muted">Бонусные мили: <strong id="bonusMiles">—</strong></div>
      <div class="progress-wrap">
        <div class="progress-bg" aria-hidden="true"><div id="milesProgressBar" class="progress-fill" style="width:0%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:12px;color:#777;margin-top:6px">
          <div id="milesLabelLeft">0 миль</div>
          <div id="milesLabelRight">—</div>
        </div>
      </div>
    </div>
  </div>

  <nav class="tabs" role="tablist" aria-label="tabs">
    <a class="active" data-tab="profileTab" onclick="showTab(event)">Профиль</a>
    <a data-tab="milesTab" onclick="showTab(event)">Мои мили</a>
    <a data-tab="shopTab" onclick="showTab(event)">S7avelii Shop</a>
    <a data-tab="settingsTab" onclick="showTab(event)">Настройки</a>
  </nav>

  <div class="grid">
    <div>
      <!-- Profile -->
      <section id="profileTab" class="card" aria-label="profile">
        <h3>Персональные данные</h3>
        <div class="field">
          <div><div class="small-muted">ФИО</div><div id="fioField">—</div></div>
          <button class="btn" onclick="enableEdit('fio')">Изменить</button>
        </div>

        <div class="field">
          <div><div class="small-muted">Дата рождения</div><div id="dobField">—</div></div>
          <button class="btn" onclick="enableEdit('dob')">Изменить</button>
        </div>

        <div class="field">
          <div><div class="small-muted">Пол</div><div id="genderField">—</div></div>
          <button class="btn" onclick="enableEdit('gender')">Изменить</button>
        </div>

        <h3 style="margin-top:16px">Контакты</h3>
        <div class="field">
          <div><div class="small-muted">E-mail</div><div id="emailField">—</div></div>
          <button class="btn" onclick="enableEdit('email')">Изменить</button>
        </div>

        <div class="field">
          <div><div class="small-muted">Телефон</div><div id="phoneField">—</div></div>
          <button class="btn" onclick="enableEdit('phone')">Изменить</button>
        </div>

        <h3 style="margin-top:16px">Карта</h3>
        <div class="field">
          <div><div class="small-muted">Номер карты</div><div id="cardField">—</div></div>
          <button class="btn" onclick="enableEdit('cardNumber')">Изменить</button>
        </div>
        <div class="field">
          <div><div class="small-muted">Тип карты</div><div id="cardTypeField">—</div></div>
        </div>
      </section>

      <!-- Miles -->
      <section id="milesTab" class="card" style="margin-top:16px;display:none">
        <h3>Мои мили</h3>
        <div class="muted">Состояние бонусов и прогресс статуса</div>

        <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
          <div class="card" style="flex:1;min-width:200px">
            <div class="small-muted">Бонусные мили</div>
            <div style="font-weight:700;font-size:20px" id="milesBonusStat">—</div>
          </div>
          <div class="card" style="flex:1;min-width:200px">
            <div class="small-muted">Статусные мили</div>
            <div style="font-weight:700;font-size:20px" id="milesStatusStat">—</div>
          </div>
        </div>

        <div style="margin-top:14px">
          <div class="small-muted">Прогресс до следующего уровня</div>
          <div class="progress-bg" style="margin-top:8px"><div id="milesProgressBar2" class="progress-fill" style="width:0%"></div></div>
          <div style="display:flex;justify-content:space-between;font-size:13px;color:#666;margin-top:6px">
            <div id="nextLevelLeft">0 / 0</div>
            <div id="nextLevelRight">—</div>
          </div>
        </div>

        <div style="margin-top:12px" id="privilegesList"></div>
      </section>

      <!-- Shop -->
      <section id="shopTab" class="card" style="margin-top:16px;display:none">
        <h3>S7avelii Shop</h3>
        <div class="muted">Товары, доступные к покупке</div>
        <div id="productGrid" class="product-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px"></div>

        <h3 style="margin-top:16px">В корзине</h3>
        <div id="cartList" style="min-height:40px"></div>
        <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
          <div id="cartTotal" class="muted">Итого: 0 ₽</div>
          <div style="margin-left:auto">
            <button id="checkoutBtn" class="btn" onclick="checkout()">Оформить</button>
          </div>
        </div>
      </section>

      <!-- Settings -->
      <section id="settingsTab" class="card" style="margin-top:16px;display:none">
        <h3>Настройки</h3>

        <div class="field">
          <div>
            <div class="small-muted">Сменить пароль</div>
            <input id="newPassword" type="password" placeholder="Новый пароль" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:260px">
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn" onclick="changePassword()">Сменить</button>
            <div id="pwdMsg" class="muted"></div>
          </div>
        </div>

        <div class="field">
          <div>
            <div class="small-muted">Привязка VK</div>
            <input id="vkHandle" placeholder="vk_id или ссылка" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:220px;margin-top:6px">
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn" onclick="bindVK()">Привязать VK</button>
            <div id="vkMsg" class="muted"></div>
          </div>
        </div>

        <div class="field">
          <div>
            <div class="small-muted">Привязка Telegram</div>
            <input id="tgHandle" placeholder="@username" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:220px;margin-top:6px">
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn" onclick="bindTelegram()">Привязать Telegram</button>
            <div id="tgMsg" class="muted"></div>
          </div>
        </div>

        <div style="margin-top:12px"><button class="btn red" onclick="logout()">Выйти</button></div>
      </section>
    </div>

    <!-- Right column -->
    <aside>
      <div class="card">
        <h3>Быстрые действия</h3>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">
          <button class="btn" onclick="goTo('profileTab')">Редактировать профиль</button>
          <button class="btn" onclick="goTo('milesTab')">Посмотреть мили</button>
          <button class="btn" onclick="goTo('shopTab')">Открыть Shop</button>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Заказы</h3>
        <div id="ordersContainer" class="muted" style="margin-top:8px">Загрузка...</div>
      </div>
    </aside>
  </div>
</div>

<script>
/* ================ CONFIG ================ */
const API = ''; // same origin
const el = id => document.getElementById(id);
let currentUser = null;

/* ================ Utilities ================ */
function fmtPrice(n){ return (typeof n==='number' ? n.toLocaleString('ru-RU') : n) + ' ₽' }
function safeJson(res){ return res.json().catch(()=>({})); }

/* ================ Init ================ */
document.addEventListener('DOMContentLoaded', async () => {
  attachHandlers();
  renderProducts();
  await loadProfile();       // attempt load profile but do NOT redirect to auth on 401
  await loadCart();
});

/* ================ Handlers & UI ================ */
function attachHandlers(){
  // avatar input
  el('avatarInput').addEventListener('change', function(){
    const f = this.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = async (ev) => {
      const dataUrl = ev.target.result;
      el('avatar').src = dataUrl;
      // optimistic update
      try {
        await fetch(API + '/api/profile/update', {
          method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify({ avatar: dataUrl })
        });
        await loadProfile();
      } catch(e){ console.warn('avatar update failed', e); }
    };
    r.readAsDataURL(f);
  });

  // home user button (top-right) toggles to cabinet or auth
  const homeBtn = document.getElementById('homeUserBtn');
  homeBtn.addEventListener('click', () => {
    if (currentUser) window.location.href = '/cabinet.html';
    else window.location.href = '/auth.html';
  });
}

// show/hide tab
function showTab(evt){
  evt && evt.preventDefault();
  const tabId = evt ? evt.currentTarget.getAttribute('data-tab') : 'profileTab';
  document.querySelectorAll('.tabs a').forEach(a=>a.classList.remove('active'));
  if (evt) evt.currentTarget.classList.add('active');
  ['profileTab','milesTab','shopTab','settingsTab'].forEach(id=>{
    const node = el(id);
    if(!node) return;
    node.style.display = (id === tabId ? 'block' : 'none');
  });
  if (tabId === 'shopTab') loadCart();
}

/* ================ Profile load / apply ================ */
async function loadProfile(){
  try {
    const res = await fetch(API + '/api/profile', { credentials: 'include' });
    if (!res.ok) {
      // not logged in or server error -> show guest state but don't redirect
      showGuestState();
      return;
    }
    const j = await res.json().catch(()=>({}));
    currentUser = j.user || null;
    applyProfile(currentUser);
  } catch (e) {
    console.warn('loadProfile failed', e);
    showGuestState();
  }
}

function showGuestState(){
  currentUser = null;
  el('fioHeader').textContent = 'Гость';
  el('fioField').textContent = '—';
  el('dobField').textContent = '—';
  el('genderField').textContent = '—';
  el('emailField').textContent = '—';
  el('phoneField').textContent = '—';
  el('cardField').textContent = '—';
  el('cardTypeField').textContent = '—';
  el('avatar').src = 'https://via.placeholder.com/150';
  el('bonusMiles').textContent = '—';
  el('milesProgressBar').style.width = '0%';
  el('milesProgressBar2').style.width = '0%';
  el('homeUserBtn').textContent = 'Вход';
  renderOrders([]);
}

// apply profile data into UI
function applyProfile(u){
  if(!u) return showGuestState();
  currentUser = u;
  el('fioHeader').textContent = u.fio || 'Пользователь';
  el('phoneHeader').textContent = u.phone || '';
  el('fioField').textContent = u.fio || '—';
  el('dobField').textContent = u.dob || '—';
  el('genderField').textContent = u.gender || '—';
  el('emailField').textContent = u.email || '—';
  el('phoneField').textContent = u.phone || '—';
  el('cardField').textContent = u.cardNumber || '—';
  el('cardTypeField').textContent = u.cardType || '—';
  el('bonusMiles').textContent = (u.bonusMiles ?? 0);
  if (u.avatar) el('avatar').src = u.avatar;
  el('homeUserBtn').textContent = u.avatar ? '' : (u.fio ? u.fio.split(' ')[0] : 'Профиль');
  if (u.avatar) {
    // show small image inside home button
    el('homeUserBtn').innerHTML = `<img src="${u.avatar}" alt="avatar" style="width:36px;height:36px;border-radius:999px;object-fit:cover">`;
  }
  // progress bars
  const bonus = Number(u.bonusMiles || 0);
  const status = Number(u.statusMiles || 0);
  // define thresholds (example) — you can adapt thresholds per cardType
  const nextLevelTarget = determineNextLevelTarget(u.cardType || 'Classic');
  const percent = Math.min(100, Math.round((bonus/nextLevelTarget)*100));
  el('milesProgressBar').style.width = percent + '%';
  el('milesLabelLeft').textContent = bonus + ' миль';
  el('milesLabelRight').textContent = nextLevelTarget + ' для уровня';
  el('milesBonusStat').textContent = bonus;
  el('milesStatusStat').textContent = status;
  // second miles progress (status miles)
  const statusTarget = Math.max(1, nextLevelTarget); // reuse
  const percent2 = Math.min(100, Math.round((status / statusTarget) * 100));
  el('milesProgressBar2').style.width = percent2 + '%';
  el('nextLevelLeft').textContent = `${status} / ${statusTarget}`;
  el('nextLevelRight').textContent = `${u.cardType || 'Classic'}`;
  // privileges example
  renderPrivileges(u.cardType || 'Classic');
  // orders
  renderOrders(u.orders || []);
}

/* determine target miles for next level (simple rules, can be adjusted) */
function determineNextLevelTarget(cardType){
  if (cardType === 'VIP') return 50000;
  if (cardType === 'Classic') return 5000;
  return 5000;
}

function renderPrivileges(cardType){
  const map = {
    Classic: ['Накопление бонусных миль', 'Акции и спецпредложения'],
    VIP: ['Приоритетная регистрация', 'Доступ в бизнес-зал', 'Дополнительные бонусы']
  };
  const list = el('privilegesList');
  list.innerHTML = '<h4>Привилегии:</h4>';
  const ul = document.createElement('ul');
  (map[cardType] || map['Classic']).forEach(p => {
    const li = document.createElement('li');
    li.textContent = '• ' + p;
    ul.appendChild(li);
  });
  list.appendChild(ul);
}

/* ================ Inline edit ================ */
function enableEdit(field){
  const map = {
    fio: 'fioField', dob: 'dobField', gender: 'genderField',
    email: 'emailField', phone: 'phoneField', cardNumber: 'cardField'
  };
  const id = map[field];
  if(!id) return;
  const container = el(id);
  const current = container.textContent === '—' ? '' : container.textContent;
  container.innerHTML = '';
  const input = document.createElement('input');
  input.value = current;
  input.style.width = '220px';
  input.type = (field === 'email') ? 'email' : (field === 'phone') ? 'tel' : 'text';
  const ok = document.createElement('button');
  ok.className = 'btn';
  ok.textContent = 'OK';
  ok.style.marginLeft = '8px';
  ok.onclick = async () => {
    const value = input.value.trim();
    container.textContent = value || '—';
    if (field === 'fio') el('fioHeader').textContent = value || 'Пользователь';
    // send update
    try {
      const body = {};
      // server expects keys like 'fio', 'phone', etc. For cardNumber use cardNumber
      body[field] = value || '';
      const res = await fetch(API + '/api/profile/update', {
        method: 'POST', headers: {'Content-Type':'application/json'}, credentials: 'include',
        body: JSON.stringify(body)
      });
      if (res.ok) {
        const j = await safeJson(res);
        if (j.user) applyProfile(j.user);
        else await loadProfile();
      } else {
        // reload to show true server state
        await loadProfile();
      }
    } catch (e) {
      console.warn('update failed', e);
      await loadProfile();
    }
  };
  container.appendChild(input);
  container.appendChild(ok);
  input.focus();
}

/* ================ Products (simple static list) ================ */
const PRODUCTS = [
  { id:'p1', title:'Блокнот S7avelii', price:550, image:'images/photo_5330078908990750485_y.avif' },
  { id:'p2', title:'Комбо Блокнот + Футболка', price:2350, image:'images/photo_5330078908990750484_y.avif' },
  { id:'p3', title:'Фирменная футболка', price:1900, image:'images/photo_5332515869139530693_y.avif' },
  { id:'p4', title:'Комбо Путешественник', price:4500, image:'images/photo_5330078908990750483_y.avif' }
];

function renderProducts(){
  const grid = el('productGrid');
  grid.innerHTML = '';
  PRODUCTS.forEach(p => {
    const card = document.createElement('div');
    card.style.background = '#fff';
    card.style.borderRadius = '10px';
    card.style.padding = '10px';
    card.style.display = 'flex';
    card.style.flexDirection = 'column';
    card.style.gap = '8px';
    card.innerHTML = `
      <img src="${p.image}" alt="${p.title}" style="width:100%;height:140px;object-fit:cover;border-radius:8px">
      <div style="font-weight:600">${p.title}</div>
      <div style="font-weight:700">${fmtPrice(p.price)}</div>
      <div style="margin-top:auto;display:flex;gap:8px">
        <button class="btn" data-buy="${p.id}">Купить</button>
        <button class="btn secondary" data-add="${p.id}">В корзину</button>
      </div>
    `;
    grid.appendChild(card);
  });
  // attach handlers
  grid.querySelectorAll('[data-add]').forEach(btn=>{
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-add');
      const product = PRODUCTS.find(x=>x.id===id);
      if (!product) return alert('Товар не найден');
      try {
        const res = await fetch(API + '/api/cart/add', {
          method: 'POST', headers: {'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify({ title: product.title, price: product.price, image: product.image, qty: 1 })
        });
        if (!res.ok) {
          const j = await safeJson(res);
          if (res.status === 401) return window.location.href = '/auth.html';
          return alert(j.error || 'Ошибка добавления в корзину');
        }
        alert('Добавлено в корзину');
        if (document.querySelector('.tabs a.active')?.getAttribute('data-tab') === 'shopTab') loadCart();
      } catch (e) { alert('Ошибка сети'); }
    });
  });
  grid.querySelectorAll('[data-buy]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-buy');
      const product = PRODUCTS.find(x=>x.id===id);
      if (!product) return;
      // redirect to telegram/shop link or add and checkout; here we add then open checkout
      try {
        const addRes = await fetch(API + '/api/cart/add', {
          method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify({ title: product.title, price: product.price, image: product.image, qty: 1 })
        });
        if (!addRes.ok) {
          const j = await safeJson(addRes);
          if (addRes.status === 401) return window.location.href = '/auth.html';
          return alert(j.error || 'Ошибка добавления');
        }
        // go to shop tab
        goTo('shopTab');
        loadCart();
      } catch (e) { alert('Ошибка сети'); }
    });
  });
}

/* ================ Cart ================ */
async function loadCart(){
  const list = el('cartList');
  list.innerHTML = '<div class="muted">Загрузка...</div>';
  try {
    const res = await fetch(API + '/api/cart', { credentials: 'include' });
    if (!res.ok) {
      const j = await safeJson(res);
      if (res.status === 401) {
        list.innerHTML = `<div class="muted">Корзина доступна после входа — <a href="/auth.html">войти</a></div>`;
        el('checkoutBtn').disabled = true;
        return;
      }
      list.innerHTML = `<div class="muted">Ошибка загрузки корзины</div>`;
      el('checkoutBtn').disabled = true;
      return;
    }
    const j = await res.json();
    renderCart(j.cart || []);
  } catch (e) {
    list.innerHTML = `<div class="muted">Ошибка сети</div>`;
    el('checkoutBtn').disabled = true;
  }
}

function renderCart(items){
  const list = el('cartList');
  if (!items || items.length === 0) {
    list.innerHTML = '<div class="muted">Корзина пуста</div>';
    el('cartTotal').textContent = 'Итого: 0 ₽';
    el('checkoutBtn').disabled = true;
    return;
  }
  let total = 0;
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.gap = '10px';
  items.forEach(it=>{
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.alignItems = 'center';
    div.style.justifyContent = 'space-between';
    div.style.borderBottom = '1px dashed rgba(0,0,0,0.06)';
    div.style.padding = '8px 0';
    const priceNum = Number(it.price) || 0;
    total += priceNum * (it.qty || 1);
    div.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center;flex:1">
        <img src="${it.image||'https://via.placeholder.com/64'}" style="width:64px;height:64px;object-fit:cover;border-radius:8px">
        <div>
          <div style="font-weight:600">${it.title}</div>
          <div class="muted">${fmtPrice(it.price)} × ${it.qty || 1}</div>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">${fmtPrice(priceNum*(it.qty||1))}</div>
        <div style="margin-top:8px"><button class="btn secondary" data-remove="${it.id}">Удалить</button></div>
      </div>
    `;
    container.appendChild(div);
  });
  list.innerHTML = '';
  list.appendChild(container);
  el('cartTotal').textContent = 'Итого: ' + fmtPrice(total);
  el('checkoutBtn').disabled = false;
  // attach remove handlers
  list.querySelectorAll('[data-remove]').forEach(btn=>{
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-remove');
      if (!confirm('Удалить товар из корзины?')) return;
      try {
        const res = await fetch(API + '/api/cart/' + encodeURIComponent(id), { method: 'DELETE', credentials: 'include' });
        if (!res.ok) { const j = await safeJson(res); return alert(j.error || 'Ошибка удаления'); }
        await loadCart();
      } catch (e) { alert('Ошибка сети'); }
    });
  });
}

async function checkout(){
  if(!confirm('Оформить заказ?')) return;
  try {
    const res = await fetch(API + '/api/cart/checkout', { method: 'POST', credentials: 'include' });
    const j = await safeJson(res);
    if (!res.ok) return alert(j.error || 'Ошибка оформления');
    // on success, refresh cart and profile (orders)
    await loadCart();
    await loadProfile();
    el('cartMsg').textContent = 'Заказ принят';
    setTimeout(()=> el('cartMsg').textContent = '', 3000);
  } catch (e) { alert('Ошибка сети'); }
}

/* ================ Orders rendering ================ */
function renderOrders(orders){
  const dest = el('ordersContainer');
  dest.innerHTML = '';
  if (!orders || !orders.length) { dest.textContent = 'Заказы отсутствуют'; return; }
  orders.slice().reverse().forEach(o=>{
    const d = document.createElement('div');
    d.style.padding = '8px 0';
    d.style.borderBottom = '1px solid rgba(0,0,0,0.04)';
    d.innerHTML = `<strong>Заказ ${o.id}</strong> — ${new Date(o.createdAt).toLocaleString()} — ${o.status}<br>Товаров: ${o.items.length} — Сумма: ${fmtPrice(o.total)}`;
    dest.appendChild(d);
  });
}

/* ================ Settings actions ================ */
async function changePassword(){
  const v = el('newPassword').value.trim();
  if (!v) return alert('Введите новый пароль');
  try {
    const res = await fetch(API + '/api/profile/update', {
      method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
      body: JSON.stringify({ password: v })
    });
    const j = await safeJson(res);
    if (!res.ok) return alert(j.error || 'Ошибка');
    el('pwdMsg').textContent = 'Пароль обновлён';
    el('newPassword').value = '';
    setTimeout(()=> el('pwdMsg').textContent = '', 3000);
  } catch (e) { alert('Ошибка сети'); }
}

async function bindVK(){
  const v = el('vkHandle').value.trim();
  if (!v) return el('vkMsg').textContent = 'Введите VK id';
  try {
    const res = await fetch(API + '/api/profile/update', {
      method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
      body: JSON.stringify({ vk: v })
    });
    const j = await safeJson(res);
    if (!res.ok) return el('vkMsg').textContent = j.error || 'Ошибка';
    el('vkMsg').textContent = 'VK привязан';
    setTimeout(()=> el('vkMsg').textContent = '', 3000);
  } catch (e) { el('vkMsg').textContent = 'Ошибка сети'; }
}

async function bindTelegram(){
  const v = el('tgHandle').value.trim();
  if (!v) return el('tgMsg').textContent = 'Введите telegram handle';
  try {
    const res = await fetch(API + '/api/profile/update', {
      method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
      body: JSON.stringify({ telegram: v })
    });
    const j = await safeJson(res);
    if (!res.ok) return el('tgMsg').textContent = j.error || 'Ошибка';
    el('tgMsg').textContent = 'Telegram привязан';
    setTimeout(()=> el('tgMsg').textContent = '', 3000);
  } catch (e) { el('tgMsg').textContent = 'Ошибка сети'; }
}

/* ================ Logout ================ */
async function logout(){
  try {
    await fetch(API + '/api/logout', { method: 'POST', credentials: 'include' });
  } catch (e) { console.warn('logout failed', e); }
  // show guest state and redirect to auth page
  showGuestState();
  window.location.href = '/auth.html';
}

/* ================ Helpers ================ */
function goTo(tab){
  const a = [...document.querySelectorAll('.tabs a')].find(x=>x.getAttribute('data-tab')===tab);
  if(a) { a.click(); a.classList.add('active'); showTab({ currentTarget: a, preventDefault: ()=>{} }); }
}
</script>
</body>
</html>
