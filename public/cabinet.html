<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Личный кабинет — S7 Airlines Style</title>

  <!-- Шрифт Montserrat -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      font-family: 'Montserrat', sans-serif;
    }

    body {
      margin: 0;
      background-color: #fff;
      color: #222;
    }

    /* === Telegram баннер === */
    .telegram-banner {
      background: linear-gradient(90deg, #37aee2 0%, #1e96c8 100%);
      color: #fff;
      text-align: center;
      padding: 10px 16px;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .telegram-banner img {
      width: 20px;
      height: 20px;
    }

    /* === Верхнее меню === */
    header {
      background: #f5f5f5;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e0e0e0;
    }

    header .logo {
      font-weight: 600;
      color: #222;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .user-area img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
    }

    .user-area span {
      cursor: pointer;
      color: #2196f3;
      font-weight: 500;
    }

    /* === Контент === */
    main {
      max-width: 1100px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .tabs {
      display: flex;
      gap: 16px;
      border-bottom: 2px solid #eee;
      margin-bottom: 24px;
    }

    .tabs a {
      padding: 8px 0;
      text-decoration: none;
      color: #555;
      font-weight: 400;
      border-bottom: 2px solid transparent;
    }

    .tabs a.active {
      color: #2196f3;
      border-color: #2196f3;
    }

    .grid section {
      display: none;
    }

    .grid section.active {
      display: block;
    }

    /* === Профиль === */
    .profile-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 24px;
    }

    .profile-header img {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #f0f0f0;
    }

    .profile-header h2 {
      margin: 0;
      font-weight: 500;
      font-size: 20px;
    }

    .profile-details {
      display: grid;
      grid-template-columns: 200px 1fr;
      row-gap: 12px;
      column-gap: 12px;
      font-size: 15px;
    }

    .profile-details div.label {
      color: #777;
      font-weight: 400;
    }

    .input-inline {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }

    /* === Магазин === */
    #productGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .card {
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
      transition: 0.2s;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    }

    .card .btn {
      background: #2196f3;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn.secondary {
      background: #eee;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }

    td, th {
      padding: 8px;
      border-bottom: 1px solid #eaeaea;
    }

    .btn {
      cursor: pointer;
    }

    .progress-bar {
      background: #eee;
      border-radius: 6px;
      overflow: hidden;
      height: 10px;
      margin-top: 6px;
    }

    .progress-bar span {
      display: block;
      height: 100%;
      background: #2196f3;
    }

    .stats {
      display: flex;
      gap: 30px;
      margin-top: 20px;
    }

    .stat {
      flex: 1;
      background: #fafafa;
      padding: 16px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid #f0f0f0;
    }
  </style>
</head>
<body>
  <!-- === Telegram баннер === -->
  <div class="telegram-banner">
    <img src="https://cdn-icons-png.flaticon.com/512/2111/2111646.png" alt="Telegram">
    <span>Подключайся к нашему Telegram, чтобы узнавать об акциях первым!</span>
  </div>

  <!-- === Шапка === -->
  <header>
    <div class="logo">S7 Airlines</div>
    <div id="userArea" class="user-area"></div>
  </header>

  <!-- === Основной контент === -->
  <main>
    <div class="tabs">
      <a href="#" class="active" data-tab="profileTab" onclick="showTab(event)">Профиль</a>
      <a href="#" data-tab="shopTab" onclick="showTab(event)">Магазин</a>
      <a href="#" data-tab="cartTab" onclick="showTab(event)">Корзина</a>
    </div>

    <div class="grid">
      <section id="profileTab" class="active">
        <div class="profile-header">
          <img id="avatar" src="https://via.placeholder.com/100" alt="Аватар">
          <div>
            <h2 id="fioHeader">—</h2>
            <p id="phoneHeader" style="color:#777;margin:4px 0 0 0;">—</p>
            <input type="file" id="avatarInput" accept="image/*" style="margin-top:8px;">
          </div>
        </div>
        <!-- === Профиль: персональные данные === -->
        <div class="card" style="margin-bottom:18px">
          <h3 style="margin:0 0 12px 0">Персональные данные</h3>

          <div class="profile-details" style="margin-bottom:8px">
            <div class="label">ФИО</div>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
              <div id="fioField">—</div>
              <button class="btn secondary" onclick="editInline('fio')">Изменить</button>
            </div>

            <div class="label">Дата рождения</div>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
              <div id="dobField">—</div>
              <button class="btn secondary" onclick="editInline('dob')">Изменить</button>
            </div>

            <div class="label">Пол</div>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
              <div id="genderField">—</div>
              <button class="btn secondary" onclick="editInline('gender')">Изменить</button>
            </div>

            <div class="label">E-mail</div>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
              <div id="emailField">—</div>
              <button class="btn secondary" onclick="editInline('email')">Изменить</button>
            </div>

            <div class="label">Телефон</div>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
              <div id="phoneField">—</div>
              <button class="btn secondary" onclick="editInline('phone')">Изменить</button>
            </div>

            <div class="label">Номер карты</div>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
              <div id="card_field">—</div>
              <button class="btn secondary" onclick="editInline('card_number')">Изменить</button>
            </div>

            <div class="label">Тип карты</div>
            <div id="cardTypeField">—</div>
          </div>
        </div>

        <!-- === Мили и статистика === -->
        <div class="stats" style="margin-bottom:18px">
          <div class="stat">
            <div class="small-muted">Бонусные мили</div>
            <div style="font-size:22px;font-weight:600" id="milesBonusStat">—</div>
          </div>
          <div class="stat">
            <div class="small-muted">Статусные мили</div>
            <div style="font-size:22px;font-weight:600" id="milesStatusStat">—</div>
          </div>
          <div class="stat">
            <div class="small-muted">Прогресс до следующего уровня</div>
            <div class="progress-bar" aria-hidden="true" style="margin-top:8px"><span id="milesProgressBar2" style="width:0%"></span></div>
            <div style="margin-top:8px;color:#666;font-size:13px;display:flex;justify-content:space-between">
              <div id="nextLevelLeft">0 / 0</div>
              <div id="nextLevelRight">—</div>
            </div>
          </div>
        </div>

        <!-- === Магазин === -->
        <div class="card" style="margin-bottom:18px">
          <h3 style="margin:0 0 12px 0">S7avelii Shop</h3>
          <div class="small-muted">Товары, доступные к покупке</div>
          <div id="productGrid" class="product-grid" style="margin-top:12px"></div>
        </div>

        <!-- === Настройки (пример) === -->
        <div class="card" style="margin-bottom:18px;display:none" id="settingsExample">
          <h3 style="margin:0 0 12px 0">Настройки</h3>
          <p class="small-muted">Здесь будут настройки пользователя.</p>
        </div>
      </section>

      <!-- === Дополнительные вкладки (корзина/магазин вынесены в сайдбар) === -->
      <section id="shopTab" class="grid-section" style="display:none"></section>
      <section id="cartTab" class="grid-section" style="display:none"></section>
    </div>

    <!-- === Сайдбар: корзина и быстрые действия === -->
    <aside style="display:flex;flex-direction:column;gap:18px">
      <div class="card">
        <h3 style="margin:0 0 12px 0">Корзина</h3>
        <table class="cart-table" id="cartTable" aria-label="Корзина">
          <thead><tr><th>Товар</th><th>Цена</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:12px;display:flex;justify-content:space-between;font-weight:600">
          <span>Итого:</span>
          <span id="cartTotal">0 ₽</span>
        </div>
        <button class="btn" style="width:100%;margin-top:12px" onclick="checkout()">Оформить</button>
      </div>

      <div class="card">
        <h4 style="margin:0 0 8px 0">Быстрые действия</h4>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn secondary" onclick="window.location.href='bilet.html'">Купить билет</button>
          <button class="btn secondary" onclick="window.location.href='priority.html'">S7avelii Priority</button>
          <button class="btn secondary" onclick="logout()">Выйти</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- === Footer (минимальный) === -->
   <footer class="footer">
  <div class="footer-inner">
    <!-- Верхнее меню -->
    <div class="footer-menu fade-in">
      <div class="footer-column">
        <h3>S7avelii Airlines</h3>
        <ul>
          <li><a href="body.html">О компании</a></li>
          <li><a href="https://t.me/s7aveliihelper">Партнеры</a></li>
          <li><a href="https://t.me/s7aveliihelper">Контакты</a></li>
          <li><a href="#">Вакансии</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <ul>
          <li><a href="office.html">Офисы продаж и представительства</a></li>
          <li><a href="https://t.me/S7saveliiairlines">Новости</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h3>Информация</h3>
        <ul>
          <li><a href="arrivel.html">Направления</a></li>
          <li><a href="bilet.html">Рейсы</a></li>
          <li><a href="https://t.me/s7aveliihelper">Справочный центр</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <ul>
          <li><a href="https://t.me/s7aveliihelper">Перевозка грузов</a></li>
          <li><a href="plane.html">Наш флот</a></li>
          <li><a href="mailto:s7avelii_airlines@mail.ru">Подать заявление на партнёрство</a></li>
        </ul>
      </div>
    </div>

    <hr>

    <!-- Верх футера -->
    <div class="footer-top fade-in">
      <div class="footer-actions">
        <a href="https://t.me/s7aveliihelper" class="action"><img src="icons/chat.svg" alt=""> Чат</a>
      </div>
      <div class="footer-phone">
        <div class="label">тел: Бесплатно по России</div>
        <div class="number">8 962 629–81–05</div>
      </div>
    </div>

    <!-- Подписка -->
    <div class="footer-subscribe fade-in">
      <h3>Подпишитесь на рассылку S7avelii</h3>
      <p>Будьте в курсе акций, открывайте новые маршруты</p>
      <form class="subscribe-form">
        <input type="email" placeholder="Ваша почта" required>
        <button type="submit">→</button>
      </form>
      <label class="checkbox">
        <input type="checkbox" required>
        Хочу узнавать про скидки и идеи путешествий по почте и соглашаюсь на 
        <a href="#">обработку персональных данных</a>
      </label>
    </div>

    <!-- Низ футера -->
    <div class="footer-bottom fade-in">
      <div class="copy">© 2025. S7avelii Airlines — Все права защищены</div>
      <div class="socials">
        <a href="https://vk.com/s7avelii"><img src="images/icons8-vk-logo-30.avif" alt="VK"></a>
        <a href="https://www.tiktok.com/@s7avelii?_t=ZT-8yviZwu6jAT&_r=1"><img src="images/icons8-tiktok-logo-50 (1).avif" alt="TikTok"></a>
        <a href="https://youtu.be/Dy31uUCFaWw?si=2gyqNYaT3ZVO8WJa"><img src="images/icons8-youtube-logo-50.avif" alt="YouTube"></a>
        <a href="https://t.me/S7saveliiairlines"><img src="images/icons8-telegram-logo-50 (1).avif" alt="Telegram"></a>
      </div>
    </div>
  </div>
</footer>

<style>
/* === Убираем горизонтальный скролл и белые полосы === */
html, body {
  overflow-x: hidden;
  margin: 0;
  padding: 0;
}

/* ==== FOOTER ==== */
.footer {
  width: 100%;
  background: #f1f5f9;
  padding: 40px 60px;
  font-family: "Inter", sans-serif;
  color: #111;
  box-sizing: border-box;
}

/* Верхнее меню */
.footer-menu {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 40px;
  margin-bottom: 30px;
}

.footer-column h3 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
}

.footer-column ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.footer-column ul li {
  margin-bottom: 8px;
}

.footer-column ul li a {
  color: #111;
  text-decoration: none;
  font-size: 14px;
  transition: all 0.2s ease;
}

.footer-column ul li a:hover {
  text-decoration: underline;
}

hr {
  border: none;
  border-top: 1px solid #e2e8f0;
  margin: 30px 0;
  width: 100%;
}

/* Верх футера */
.footer-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 30px;
}

.footer-actions {
  display: flex;
  gap: 30px;
}

.footer-actions .action {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
  cursor: pointer;
  text-decoration: none;
  color: #111;
}

.footer-actions img {
  width: 20px;
}

.footer-phone {
  text-align: right;
}

.footer-phone .label {
  font-size: 14px;
  color: #555;
}

.footer-phone .number {
  font-size: 18px;
  font-weight: 600;
}

/* Подписка */
.footer-subscribe {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 30px;
  border: 1px solid #d1d5db;
}

.footer-subscribe h3 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 6px;
}

.footer-subscribe p {
  color: #555;
  margin-bottom: 16px;
}

.subscribe-form {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.subscribe-form input {
  flex: 1;
  padding: 12px 14px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
}

.subscribe-form button {
  background: #9ac208;
  border: none;
  border-radius: 8px;
  padding: 0 20px;
  font-size: 20px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.subscribe-form button:hover {
  background: #8db807;
}

.checkbox {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
  font-size: 13px;
  color: #333;
}

.checkbox a {
  color: #abc70f;
  text-decoration: underline;
}

/* Низ футера */
.footer-bottom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  font-size: 14px;
  color: #555;
}

.socials {
  display: flex;
  gap: 12px;
}

.socials a img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #fff;
  padding: 6px;
  transition: transform 0.2s ease;
}

.socials a img:hover {
  transform: scale(1.1);
}

/* === АНИМАЦИЯ ПОЯВЛЕНИЯ === */
.fade-in {
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.6s ease, transform 0.6s ease;
}

.fade-in.visible {
  opacity: 1;
  transform: translateY(0);
}

/* === АДАПТАЦИЯ === */
@media (max-width: 1024px) {
  .footer {
    padding: 30px 40px;
  }
  .footer-top {
    flex-direction: column;
    align-items: flex-start;
    gap: 20px;
  }
  .footer-phone {
    text-align: left;
  }
}

@media (max-width: 768px) {
  .footer {
    padding: 30px 20px;
  }
  .footer-menu {
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  .footer-column h3 {
    font-size: 16px;
  }
  .footer-column ul li a {
    font-size: 13px;
  }
  .footer-subscribe {
    padding: 16px;
  }
  .subscribe-form {
    flex-direction: column;
  }
  .subscribe-form button {
    width: 100%;
    padding: 10px;
  }
  .footer-bottom {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  .socials {
    justify-content: flex-start;
  }
}

@media (max-width: 480px) {
  .footer-menu {
    grid-template-columns: 1fr;
  }
  .footer-subscribe h3 {
    font-size: 16px;
  }
  .footer-subscribe p {
    font-size: 13px;
  }
  .footer-phone .number {
    font-size: 16px;
  }
  .footer-phone .label {
    font-size: 12px;
  }
  .footer-actions .action {
    font-size: 14px;
  }
  .socials a img {
    width: 28px;
    height: 28px;
  }
}
</style>

<script>
/* === Плавное появление футера при прокрутке === */
document.addEventListener("DOMContentLoaded", () => {
  const fadeElements = document.querySelectorAll('.fade-in');
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.2 });
  fadeElements.forEach(el => observer.observe(el));
});
</script>
</main>
<script>
const API = "https://s7avelii-airlines-1.onrender.com";

function getToken(){ return localStorage.getItem('token'); }
let currentUser = null;
let products = [];
let cart = [];

// Универсальный запрос
async function apiFetch(endpoint, options = {}) {
  const token = getToken();
  options.headers = { ...(options.headers || {}) };
  if (token) options.headers['Authorization'] = 'Bearer ' + token;
  if (options.body && !(options.body instanceof FormData) && typeof options.body !== 'string') {
    options.headers['Content-Type'] = 'application/json';
    options.body = JSON.stringify(options.body);
  }
  const res = await fetch(API + endpoint, options).catch(e => { console.error('fetch err', e); return null; });
  if (!res) return null;
  if (res.status === 401) { logout(); return null; }
  const json = await res.json().catch(()=> ({}));
  return json;
}

// Обновление шапки пользователя
async function updateUserArea() {
  const userArea = document.getElementById('userArea');
  const token = getToken();
  if (!token) {
    userArea.innerHTML = `<a href="auth.html">Вход</a>`;
    return;
  }
  try {
    const user = await apiFetch('/api/profile');
    if (!user || !user.fio) {
      userArea.innerHTML = `<a href="auth.html">Вход</a>`;
      return;
    }
    currentUser = user;
    if (user.avatar) {
      const avatarUrl = (user.avatar.startsWith('http') ? user.avatar : API + user.avatar);
      userArea.innerHTML = `<img src="${avatarUrl}" alt="avatar" onclick="window.location.href='cabinet.html'">`;
      document.getElementById('avatar').src = avatarUrl;
    } else {
      const short = (user.fio && user.fio.split(' ')[0]) || user.email || 'Профиль';
      userArea.innerHTML = `<span onclick="window.location.href='cabinet.html'">${escapeHtml(short)}</span>`;
    }
    loadProfile();
  } catch (e) {
    console.error('updateUserArea err', e);
    userArea.innerHTML = `<a href="auth.html">Вход</a>`;
  }
}

// Рендер данных профиля
function loadProfile(){
  if(!currentUser) return;
  document.getElementById('fioHeader').textContent = currentUser.fio || '—';
  document.getElementById('phoneHeader').textContent = currentUser.phone || '—';
  document.getElementById('fioField').textContent = currentUser.fio || '—';
  document.getElementById('dobField').textContent = currentUser.dob || '—';
  document.getElementById('genderField').textContent = currentUser.gender || '—';
  document.getElementById('emailField').textContent = currentUser.email || '—';
  document.getElementById('phoneField').textContent = currentUser.phone || '—';
  document.getElementById('card_field').textContent = currentUser.card_number || '—';
  document.getElementById('cardTypeField').textContent = currentUser.card_type || '—';

  document.getElementById('milesBonusStat').textContent = currentUser.bonus_miles || 0;
  document.getElementById('milesStatusStat').textContent = currentUser.status_miles || 0;

  const perc = Math.min(100, (currentUser.status_miles || 0) / 1000 * 100);
  document.getElementById('milesProgressBar2').style.width = perc + '%';
  document.getElementById('nextLevelLeft').textContent = (currentUser.status_miles || 0) + '/1000';
}

// Inline редактирование
async function editInline(field) {
  if(!currentUser) return;
  const domMap = {
    fio: 'fioField',
    dob: 'dobField',
    gender: 'genderField',
    email: 'emailField',
    phone: 'phoneField',
    card_number: 'card_field'
  };
  const domId = domMap[field] || field + 'Field';
  const container = document.getElementById(domId);
  if(!container) return;
  const cur = (field === 'card_number' ? currentUser.card_number : currentUser[field]) || '';
  let input;
  if (field === 'dob') {
    input = document.createElement('input'); input.type = 'date'; input.value = cur;
  } else if (field === 'gender') {
    input = document.createElement('select');
    ['','Мужской','Женский','Другое'].forEach(val=>{
      const o = document.createElement('option'); o.value = val; o.textContent = val || 'Не указан';
      if(val === cur) o.selected = true;
      input.appendChild(o);
    });
  } else {
    input = document.createElement('input'); input.type = 'text'; input.value = cur;
  }
  input.className = 'input-inline';
  let saved = false;
  input.addEventListener('change', async () => { await saveField(field, input.value); saved = true; });
  input.addEventListener('blur', async () => { if(!saved) await saveField(field, input.value); });
  container.innerHTML = ''; container.appendChild(input); input.focus();
}

async function saveField(field, value) {
  const payload = {}; payload[field] = value;
  const res = await apiFetch('/api/profile', { method: 'PUT', body: payload });
  if (res && res.ok !== false) {
    const updated = await apiFetch('/api/profile');
    if (updated) { currentUser = updated; loadProfile(); updateUserArea(); }
  } else {
    alert('Ошибка при сохранении');
  }
}

// Аватар загрузка
document.getElementById('avatarInput').addEventListener('change', async function(){
  if(!this.files[0]) return;
  const fd = new FormData();
  fd.append('avatar', this.files[0]);
  const token = getToken();
  try{
    const res = await fetch(API + '/api/profile/avatar', {
      method: 'POST',
      headers: token ? { 'Authorization': 'Bearer ' + token } : {},
      body: fd
    });
    const data = await res.json();
    if (data && data.avatar) {
      const avatarUrl = data.avatar.startsWith('http') ? data.avatar : API + data.avatar;
      document.getElementById('avatar').src = avatarUrl;
      await updateUserArea();
    } else {
      alert('Ошибка загрузки аватара');
    }
  }catch(err){ console.error('avatar upload', err); alert('Ошибка сети при загрузке'); }
});

// Магазин
async function loadShop(){
  const data = await apiFetch('/api/shop');
  products = (data && data.products) ? data.products : [];
  renderProducts();
}

function renderProducts(){
  const grid = document.getElementById('productGrid');
  grid.innerHTML = '';
  products.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<div style="font-weight:600">${escapeHtml(p.name)}</div>
                     <div class="small-muted">${p.price} ₽</div>
                     <button class="btn" onclick="addToCart(${p.id})">В корзину</button>`;
    grid.appendChild(div);
  });
}

function addToCart(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  cart.push(p);
  renderCart();
}

function removeFromCart(i){
  cart.splice(i,1);
  renderCart();
}

function renderCart(){
  const tbody = document.getElementById('cartTable').querySelector('tbody');
  tbody.innerHTML = '';
  let total = 0;
  cart.forEach((p,i)=>{
    total += p.price;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(p.name)}</td><td>${p.price} ₽</td><td><button class="btn secondary" onclick="removeFromCart(${i})">×</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('cartTotal').textContent = total + ' ₽';
}

async function checkout(){
  if(cart.length === 0) { alert('Корзина пуста'); return; }
  const res = await apiFetch('/api/checkout', { method: 'POST', body: { items: cart } });
  if(res && res.ok) { cart = []; renderCart(); alert('Заказ оформлен!'); }
  else alert('Ошибка при оформлении заказа');
}

// Вкладки
function showTab(evt){
  evt.preventDefault();
  const tab = evt.currentTarget.dataset.tab;
  document.querySelectorAll('.tabs a').forEach(a=>a.classList.remove('active'));
  evt.currentTarget.classList.add('active');
  document.querySelectorAll('.grid section').forEach(s=>s.style.display='none');
  document.getElementById(tab).style.display = 'block';
}

// Logout
function logout(){
  localStorage.removeItem('token');
  window.location.href = 'auth.html';
}

// Escape HTML
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// Инициализация
window.addEventListener('DOMContentLoaded', async () => {
  const token = getToken();
  if(!token){ window.location.href = 'auth.html'; return; }
  await updateUserArea();
  await loadShop();
});
</script>
</body>
</html>

