<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>S7avelii | Профиль</title>
<link rel="icon" href="images/favicon.png" type="image/png">
<!-- Montserrat -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--accent:#9cc42f;--muted:#8b97a6}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,sans-serif;background:#f5f7fa;color:#1f2937}
header{display:flex;align-items:center;justify-content:space-between;padding:0 16px;height:60px;border-bottom:1px solid #e6e6e6;position:fixed;top:0;left:0;width:100%;background:#fff;z-index:1000}
.logo-img{height:45px;cursor:pointer}
nav ul{display:flex;gap:20px;margin:0;padding:0;list-style:none}
nav a{text-decoration:none;color:#111}
.page{max-width:1180px;margin:90px auto;padding:0 20px}
.full-header{background:#fff;display:flex;align-items:center;gap:24px;padding:24px;border-radius:12px;box-shadow:0 6px 20px rgba(16,24,40,0.06);flex-wrap:wrap}
.avatar{width:110px;height:110px;border-radius:999px;object-fit:cover;border:4px solid #fff;cursor:pointer}
.tabs{display:flex;gap:14px;margin-top:18px;padding:12px 0;border-bottom:1px solid rgba(0,0,0,0.04);overflow-x:auto}
.tabs a{padding:10px 14px;text-decoration:none;color:#495057;border-radius:8px;cursor:pointer}
.tabs a.active{color:var(--accent);background:rgba(156,196,47,0.06)}
.grid{display:grid;grid-template-columns:1fr 380px;gap:22px;margin-top:18px}
.card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 4px 12px rgba(16,24,40,0.04)}
.field{display:flex;justify-content:space-between;padding:12px 0;border-top:1px solid rgba(0,0,0,0.03)}
.small-muted{color:var(--muted);font-size:13px}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn.secondary{background:#eef2f7;color:#111}
.btn.red{background:#e66}
.progress-wrap{width:100%;margin-top:8px}
.progress-bg{width:100%;height:14px;background:#eee;border-radius:999px;overflow:hidden}
.progress-fill{height:100%;width:0%;background:var(--accent);transition:width .6s ease}
.cart-table{width:100%;border-collapse:collapse}
.cart-table th,.cart-table td{padding:8px;border-bottom:1px solid #eee;text-align:left}
.muted{color:var(--muted)}
.input-inline{width:70%;padding:6px;border-radius:6px;border:1px solid #d6d8db}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>

 <!-- Подключаем Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* применяем Roboto ко всем элементам */
    * {
      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
    }
    body { overflow-x: hidden; }
    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 0.25rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-width: 160px;
      z-index: 50;
    }
    .group:hover .dropdown-menu { display: block; }
  </style>
</head>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    height: 60px;
    border-bottom: 1px solid #ccc;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
    background: #fff;
  }

  .logo-img {
    height: 45px;
    width: auto;
    cursor: pointer;
  }

  nav {
    display: flex;
  }

  nav ul {
    display: flex;
    gap: 20px;
    margin: 0;
    padding: 0;
    list-style: none;
  }

  nav a {
    color: #000;
    text-decoration: none;
    font-size: 14px;
  }

  .right-menu {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
  }

  /* гамбургер */
  .hamburger {
    display: none;
    flex-direction: column;
    gap: 4px;
    cursor: pointer;
  }
  .hamburger span {
    width: 22px;
    height: 2px;
    background: #000;
  }

  /* нижнее меню */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(255,255,255,0.95);
    border-top: 1px solid #ddd;
    display: none; /* показываем только на мобилке */
    justify-content: space-around;
    padding: 6px 0;
    z-index: 1000;
  }

  .bottom-nav a {
    text-decoration: none;
    color: #666;
    font-size: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .bottom-nav a.active {
    color: #6cd100;
    font-weight: bold;
  }
  .bottom-nav svg {
    width: 22px;
    height: 22px;
    margin-bottom: 3px;
  }

  /* адаптив */
  @media (max-width: 768px) {
    nav { display: none; }
    .hamburger { display: flex; }
    .bottom-nav { display: flex; }
    header { height: 60px; padding: 0 12px; }
    .logo-img { height: 40px; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <a href="index.html">
      <img src="images/1757683264306.avif" alt="S7avelii Airlines" class="logo-img" />
    </a>
  </div>

  <!-- Кнопка-бургер -->
  <button class="burger" aria-label="Открыть меню">
    <span></span><span></span><span></span>
  </button>

  <!-- Главное меню -->
  <nav class="nav">
    <ul>
      <li>
        <a href="index.html">Покупка и управление</a>
        <div class="dropdown">
          <a href="bilet.html">Купить билет</a>
          <a href="auth.html">Управление бронированием</a>
          <a href="arrivel.html">Направления</a>
          <a href="HOTEL.html">Отели</a>
          <a href="class.html">Выбор класса</a>
        </div>
      </li>
      <li>
        <a href="priority.html">S7avelii Priority</a>
        <div class="dropdown">
          <a href="priority.html">О программе</a>
          <a href="https://t.me/s7aveliihelper">Как копить</a>
        </div>
      </li>
      <li>
        <a href="#">Информация</a>
        <div class="dropdown">
          <a href="body.html">О нас</a>
          <a href="office.html">Представительство</a>
          <a href="plane.html">Наш флот</a>
          <a href="eat.html">Питание</a>
          <a href="https://t.me/s7aveliihelper">Контакты</a>
        </div>
      </li>
      <li><a href="busines.html">Бизнесу</a></li>
      <li><a href="https://t.me/S7saveliiairlines">7PLANE7</a></li>
    </ul>
  </nav>

  <div class="right-menu">
    <button aria-label="Search">
      <svg class="icon-search" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle cx="11" cy="11" r="7"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    </button>
    <button>RUB</button>
    <div class="flag" title="Russian flag">
      <img src="https://upload.wikimedia.org/wikipedia/en/f/f3/Flag_of_Russia.svg" alt="Russia" />
    </div>
    <div id="userArea"></div>
  </div>
</header>

<style>
/* === БАЗОВЫЙ СТИЛЬ ДЛЯ ПК === */
header {
  display: flex;
  align-items: center;
  padding: 0 60px;
  height: 80px;
  border-bottom: 1px solid #ccc;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  z-index: 1000;
  background: #fff;
  justify-content: space-between;
  box-sizing: border-box;
}

.logo-img {
  height: 70px;
  width: auto;
  cursor: pointer;
}

nav {
  display: flex;
  flex-grow: 1;
  justify-content: center;
}

nav ul {
  display: flex;
  gap: 40px;
  margin: 0;
  padding: 0;
  list-style: none;
}

nav li {
  position: relative;
}

nav a {
  color: #000;
  text-decoration: none;
  font-size: 16px;
  padding: 28px 0;
  position: relative;
}

nav a::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0;
  height: 3px;
  background-color: #b3c900;
  transition: width 0.3s ease;
}
nav li:hover > a::after {
  width: 100%;
}

.dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  background: #fff;
  padding: 20px;
  border-top: 2px solid #b3c900;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
  min-width: 240px;
  z-index: 999;
  opacity: 0;
  transform: translateY(-10px);
  pointer-events: none;
  transition: all 0.3s ease;
}
nav li:hover .dropdown {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}
.dropdown a {
  display: block;
  padding: 8px 0;
  color: #000;
  font-size: 14px;
}
.dropdown a:hover {
  color: #b3c900;
}

.right-menu {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 16px;
}
.right-menu button,
.right-menu select {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 16px;
}
.flag {
  width: 20px;
  height: 14px;
  border-radius: 2px;
  overflow: hidden;
  box-shadow: 0 0 2px rgba(0, 0, 0, 0.15);
}
.flag img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#userArea a {
  padding: 8px 14px;
  border: 1px solid #7ad30d;
  border-radius: 6px;
  color: #6dd808;
  text-decoration: none;
  font-size: 14px;
}

/* === КНОПКА-БУРГЕР === */
.burger {
  display: none;
  flex-direction: column;
  justify-content: center;
  width: 28px;
  height: 24px;
  background: none;
  border: none;
  cursor: pointer;
  gap: 4px;
  z-index: 1001;
}
.burger span {
  display: block;
  height: 3px;
  background: #000;
  border-radius: 2px;
  transition: 0.3s;
}

/* === МЕДИА (адаптация под мобилки) === */
@media (max-width: 992px) {
  header {
    padding: 0 20px;
  }

  nav ul {
    gap: 24px;
  }
}

@media (max-width: 768px) {
  .burger {
    display: flex;
  }

  nav {
    position: fixed;
    top: 80px;
    left: 0;
    right: 0;
    background: white;
    flex-direction: column;
    align-items: flex-start;
    padding: 20px 30px;
    border-top: 1px solid #eee;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    transform: translateY(-120%);
    transition: transform 0.3s ease;
  }

  nav.open {
    transform: translateY(0);
  }

  nav ul {
    flex-direction: column;
    gap: 16px;
    width: 100%;
  }

  .dropdown {
    position: static;
    opacity: 1;
    transform: none;
    pointer-events: auto;
    border: none;
    box-shadow: none;
    padding: 0;
    display: none;
  }

  nav li:hover .dropdown {
    display: block;
  }

  .right-menu {
    display: none;
  }

  /* Анимация крестика */
  .burger.active span:nth-child(1) {
    transform: rotate(45deg) translateY(8px);
  }
  .burger.active span:nth-child(2) {
    opacity: 0;
  }
  .burger.active span:nth-child(3) {
    transform: rotate(-45deg) translateY(-8px);
  }
}
</style>

<script>
  // --- Бургер-меню ---
  const burger = document.querySelector(".burger");
  const nav = document.querySelector("nav");

  burger.addEventListener("click", () => {
    burger.classList.toggle("active");
    nav.classList.toggle("open");
  });

  // --- Авторизация ---
  async function updateUserArea() {
    const userArea = document.getElementById("userArea");
    try {
      const res = await fetch("/api/profile");
      if (!res.ok) throw new Error("Не авторизован");
      const data = await res.json();
      const user = data.user;

      if (user.avatar) {
        userArea.innerHTML = `
          <img src="${user.avatar}" alt="avatar"
            style="width:36px;height:36px;border-radius:50%;cursor:pointer;object-fit:cover;"
            onclick="window.location.href='cabinet.html'" />
        `;
      } else {
        userArea.innerHTML = `
          <span style="cursor:pointer;color:#2196f3;font-weight:500;"
            onclick="window.location.href='cabinet.html'">${user.fio.split(" ")[0]}</span>`;
      }
    } catch {
      userArea.innerHTML = `<a href="auth.html">Вход</a>`;
    }
  }
  window.addEventListener("DOMContentLoaded", updateUserArea);
</script>


<div class="page">
  <div class="full-header">
    <div style="display:flex;align-items:center;gap:16px">
      <label for="avatarInput" title="Нажмите чтобы загрузить фото">
        <img id="avatar" class="avatar" src="https://via.placeholder.com/150" alt="avatar">
      </label>
      <input id="avatarInput" type="file" accept="image/*" style="display:none">
      <div>
        <h1 id="fioHeader">Загрузка...</h1>
        <div class="small-muted" id="phoneHeader">—</div>
      </div>
    </div>

    <div style="margin-left:auto;min-width:260px">
      <div class="small-muted">Бонусные мили: <strong id="bonusMiles">—</strong></div>
      <div class="progress-wrap">
        <div class="progress-bg" aria-hidden="true"><div id="milesProgressBar" class="progress-fill" style="width:0%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:12px;color:#777;margin-top:6px">
          <div id="milesLabelLeft">0 миль</div>
          <div id="milesLabelRight">—</div>
        </div>
      </div>
    </div>
  </div>

 <nav class="tabs" role="tablist" aria-label="tabs">
  <a class="active" data-tab="profileTab" onclick="showTab(event)">Профиль</a>
  <a data-tab="milesTab" onclick="showTab(event)">Мои мили</a>
  <a data-tab="shopTab" onclick="showTab(event)">S7avelii Shop</a>
  <a data-tab="settingsTab" onclick="showTab(event)">Настройки</a>
</nav>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Minor helpers to match screenshot precisely */
    body { background: #f3f6f8; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .card { background: white; border-radius: 12px; box-shadow: 0 6px 20px rgba(20,31,39,0.06); }
    .small-muted { color:#7b8794; font-size:13px; }
    .btn { @apply inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium; }
    /* light green action used on screenshot */
    .accent { color:#7fc241; }
    .accent-bg { background: rgba(127,194,65,0.08); }
    .input-inline { @apply border rounded px-2 py-1; }
    .avatar-outer{ width:64px; height:64px; border-radius:50%; overflow:hidden; }
  </style>
</head>
<body>
  <!-- Header with user area (avatar or link) -->
  <header class="max-w-6xl mx-auto mt-6 px-6 flex justify-between items-center">
    <div class="flex items-center gap-4">
      <img src="" alt="logo" style="height:36px" onerror="this.style.display='none'">
      <h1 class="text-2xl font-semibold text-slate-800">Профиль</h1>
    </div>
    <div id="userArea" class="text-right"></div>
  </header>

  <main class="max-w-6xl mx-auto px-6 mt-6 grid grid-cols-1 gap-6">
    <!-- Telegram notice like on screenshot -->
    <div class="card p-5 flex items-center justify-between">
      <div>
        <div class="text-slate-800 font-medium">Уведомления в Телеграме</div>
        <div class="small-muted mt-1">Получайте важную информацию о полете прямо в мессенджере. Полезно, если вдруг пропустите письмо или пуш</div>
      </div>
      <div>
        <button class="btn bg-white border border-slate-200 rounded-md px-4 py-2">Подписаться</button>
      </div>
    </div>

    <!-- Profile card that matches screenshot layout -->
    <section id="profileTab" class="card p-8">
      <div class="flex items-start justify-between">
        <div>
          <h2 class="text-2xl font-semibold text-slate-800">Персональные данные</h2>
          <div class="mt-4 text-sm text-slate-600">Здесь вы можете изменить свои данные</div>
        </div>
        <div class="flex items-center gap-4">
          <div class="avatar-outer">
            <img id="avatar" src="/default-avatar.png" alt="avatar" style="width:100%;height:100%;object-fit:cover">
          </div>
          <label class="cursor-pointer bg-white border border-slate-200 rounded-full p-2 text-slate-600">
            <input id="avatarInput" type="file" accept="image/*" class="hidden">
            ✎
          </label>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-12 gap-4">
        <div class="col-span-7">
          <div class="flex items-center justify-between py-4 border-b">
            <div>
              <div class="small-muted">ФИО</div>
              <div id="fioField" class="text-slate-800 font-medium mt-1">—</div>
            </div>
            <div>
              <button class="btn bg-white border border-slate-200" onclick="editInline('fio')">Изменить</button>
            </div>
          </div>

          <div class="flex items-center justify-between py-4 border-b">
            <div>
              <div class="small-muted">Дата рождения</div>
              <div id="dobField" class="text-slate-800 mt-1">—</div>
            </div>
            <div>
              <button class="btn bg-white border border-slate-200" onclick="editInline('dob')">Изменить</button>
            </div>
          </div>

          <div class="flex items-center justify-between py-4">
            <div>
              <div class="small-muted">Пол</div>
              <div id="genderField" class="text-slate-800 mt-1">—</div>
            </div>
            <div>
              <button class="btn bg-white border border-slate-200" onclick="editInline('gender')">Изменить</button>
            </div>
          </div>
        </div>

        <!-- Right column: contacts preview like screenshot -->
        <div class="col-span-5 pl-6">
          <h3 class="text-xl font-semibold text-slate-800">Контакты</h3>
          <div class="mt-4">
            <div class="flex items-center justify-between py-3 border-b">
              <div>
                <div class="small-muted">E-Mail</div>
                <div id="emailField" class="text-slate-800 mt-1">—</div>
              </div>
              <div>
                <button class="btn bg-white border border-slate-200" onclick="editInline('email')">Изменить</button>
              </div>
            </div>
            <div class="flex items-center justify-between py-3">
              <div>
                <div class="small-muted">Телефон</div>
                <div id="phoneField" class="text-slate-800 mt-1">—</div>
              </div>
              <div>
                <button class="btn bg-white border border-slate-200" onclick="editInline('phone')">Изменить</button>
              </div>
            </div>
          </div>

          <div class="mt-6">
            <h3 class="text-xl font-semibold text-slate-800">Карта</h3>
            <div class="mt-3 flex items-center justify-between py-3 border-b">
              <div>
                <div class="small-muted">Номер карты</div>
                <div id="card_field" class="text-slate-800 mt-1">—</div>
              </div>
              <div>
                <button class="btn bg-white border border-slate-200" onclick="editInline('card_number')">Изменить</button>
              </div>
            </div>
            <div class="py-3">
              <div class="small-muted">Тип карты</div>
              <div id="cardTypeField" class="text-slate-800 mt-1">—</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bonus miles block under profile (matching screenshot feel) -->
      <div class="mt-6 grid grid-cols-3 gap-4">
        <div class="col-span-2 card p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="small-muted">Бонусные мили</div>
              <div id="milesBonusStat" class="text-2xl font-semibold mt-1">0</div>
            </div>
            <div class="w-1/2">
              <div class="small-muted">Прогресс до уровня</div>
              <div class="w-full bg-gray-100 h-3 rounded mt-2">
                <div id="milesProgressBar" class="h-3 rounded" style="width:0%;background:#7fc241"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="card p-4">
          <div class="small-muted">Статус миль</div>
          <div id="milesStatusStat" class="text-2xl font-semibold mt-1">0</div>
          <div class="small-muted mt-2">Уровень: <span id="statusLevel">—</span></div>
        </div>
      </div>

    </section>

    <!-- Promo / card change / shop & cart section -->
    <section class="card p-6">
      <div class="grid grid-cols-2 gap-6">
        <div>
          <h3 class="text-lg font-semibold">Активировать промокод</h3>
          <div class="mt-3 flex gap-3">
            <input id="promoInput" class="input-inline flex-1 border rounded px-3 py-2" placeholder="Введите код промокода">
            <button id="promoActivateBtn" class="btn accent-bg border border-transparent px-4">Активировать</button>
          </div>
          <div id="promoMsg" class="mt-2 small-muted">&nbsp;</div>

          <div class="mt-6">
            <h3 class="text-lg font-semibold">Смена карты</h3>
            <div class="mt-3 flex gap-3">
              <input id="cardChangeInput" class="input-inline flex-1 border rounded px-3 py-2" placeholder="Код смены карты">
              <button id="cardChangeBtn" class="btn accent-bg border border-transparent px-4">Применить</button>
            </div>
            <div id="cardMsg" class="mt-2 small-muted">&nbsp;</div>
          </div>
        </div>

        <div>
          <h3 class="text-lg font-semibold">Магазин / Корзина</h3>
          <div id="productGrid" class="mt-3 grid grid-cols-2 gap-3"></div>
          <div class="mt-4 overflow-auto">
            <table id="cartTable" class="w-full text-sm">
              <thead class="text-left text-slate-600"><tr><th>Товар</th><th>Цена</th><th>Кол-во</th><th>Итог</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
            <div class="mt-2 text-right font-semibold">Итого: <span id="cartTotal">0 ₽</span></div>
            <div class="mt-3 text-right"><button class="btn bg-blue-600 text-white px-4" onclick="checkout()">Оформить заказ</button></div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Hidden: simple auth link used by scripts -->
  <script>
    // ============ Configuration & helpers ============
    const API = "https://s7avelii-airlines-1.onrender.com"; // change if needed
    function getToken(){ return localStorage.getItem('token'); }
    let currentUser = null;
    let products = [];
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');

    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    async function apiFetch(endpoint, options = {}){
      const token = getToken();
      options.headers = { ...(options.headers||{}) };
      if(token) options.headers['Authorization'] = 'Bearer ' + token;
      if(options.body && !(options.body instanceof FormData) && typeof options.body !== 'string'){
        options.headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(options.body);
      }
      try{
        const res = await fetch(API + endpoint, options);
        if(res.status === 401){ logout(); return null; }
        const json = await res.json().catch(()=>({}));
        return json;
      }catch(e){ console.error('fetch err', e); return null; }
    }

    // ============ Update header and load profile ============
    async function updateUserArea(){
      const userArea = document.getElementById('userArea');
      const token = getToken();
      if(!token){ userArea.innerHTML = '<a href="auth.html" class="text-blue-600">Вход</a>'; return; }
      const user = await apiFetch('/api/profile');
      if(!user || !user.fio){ userArea.innerHTML = '<a href="auth.html" class="text-blue-600">Вход</a>'; return; }
      currentUser = user;
      if(user.avatar){
        const avatarUrl = (user.avatar.startsWith('http') ? user.avatar : API + user.avatar);
        userArea.innerHTML = `<img src="${avatarUrl}" alt="avatar" class="w-9 h-9 rounded-full object-cover cursor-pointer" onclick="window.location.href='cabinet.html'">`;
        document.getElementById('avatar').src = avatarUrl;
      } else {
        const short = (user.fio && user.fio.split(' ')[0]) || user.email || 'Профиль';
        userArea.innerHTML = `<span class="cursor-pointer text-blue-600 font-medium" onclick="window.location.href='cabinet.html'">${escapeHtml(short)}</span>`;
      }
      loadProfile();
    }

    function loadProfile(){ if(!currentUser) return;
      document.getElementById('fioField').textContent = currentUser.fio || '—';
      document.getElementById('dobField').textContent = currentUser.dob || '—';
      document.getElementById('genderField').textContent = currentUser.gender || '—';
      document.getElementById('emailField').textContent = currentUser.email || '—';
      document.getElementById('phoneField').textContent = currentUser.phone || '—';
      document.getElementById('card_field').textContent = currentUser.card_number || '—';
      document.getElementById('cardTypeField').textContent = currentUser.card_type || '—';
      document.getElementById('milesBonusStat').textContent = (currentUser.bonus_miles || 0);
      document.getElementById('milesStatusStat').textContent = (currentUser.status_miles || 0);
      const perc = Math.min(100, (currentUser.bonus_miles || 0) / 1000 * 100);
      document.getElementById('milesProgressBar').style.width = perc + '%';
      document.getElementById('statusLevel').textContent = currentUser.card_type || '—';
    }

    // ============ Inline editing ============
    const domMap = { fio: 'fioField', dob: 'dobField', gender: 'genderField', email: 'emailField', phone: 'phoneField', card_number: 'card_field' };
    async function editInline(field){ if(!currentUser) return; const domId = domMap[field] || field + 'Field'; const container = document.getElementById(domId); if(!container) return; const cur = (field === 'card_number' ? currentUser.card_number : currentUser[field]) || '';
      // create appropriate input
      let input; if(field === 'dob'){ input = document.createElement('input'); input.type = 'date'; if(cur) input.value = cur; }
      else if(field === 'gender'){ input = document.createElement('select'); ['','Мужчина','Женщина','Другое'].forEach(val=>{ const o = document.createElement('option'); o.value = val; o.textContent = val || 'Не указан'; if(val === cur) o.selected = true; input.appendChild(o); }); }
      else if(field === 'phone'){ input = document.createElement('input'); input.type = 'tel'; input.value = cur; }
      else { input = document.createElement('input'); input.type = 'text'; input.value = cur; }
      input.className = 'input-inline border px-2 py-1';
      let saved = false;
      input.addEventListener('change', async ()=>{ await saveField(field, input.value); saved = true; });
      input.addEventListener('blur', async ()=>{ if(!saved) await saveField(field, input.value); });
      container.innerHTML = '';
      container.appendChild(input);
      input.focus();
    }

    async function saveField(field, value){ const payload = {}; payload[field] = value; const res = await apiFetch('/api/profile', { method:'PUT', body: payload }); if(res && res.ok){ const updated = await apiFetch('/api/profile'); if(updated){ currentUser = updated; loadProfile(); updateUserArea(); } } else { alert('Ошибка при сохранении'); const re = await apiFetch('/api/profile'); if(re){ currentUser = re; loadProfile(); } } }

    // ============ Avatar upload ============
    document.addEventListener('DOMContentLoaded', ()=>{
      const avatarInput = document.getElementById('avatarInput');
      avatarInput && avatarInput.addEventListener('change', async function(){ if(!this.files[0]) return; const fd = new FormData(); fd.append('avatar', this.files[0]); const token = getToken(); try{ const res = await fetch(API + '/api/profile/avatar', { method:'POST', headers: token ? { 'Authorization': 'Bearer ' + token } : {}, body: fd }); const data = await res.json(); if(data && data.avatar){ const avatarUrl = data.avatar.startsWith('http') ? data.avatar : API + data.avatar; document.getElementById('avatar').src = avatarUrl; await updateUserArea(); } else { alert('Ошибка загрузки аватара'); } }catch(err){ console.error('avatar upload', err); alert('Ошибка сети при загрузке'); } });
    });

    // ============ Shop & cart ============
    async function loadShop(){ const data = await apiFetch('/api/shop'); products = (data && data.products) ? data.products : []; renderProducts(); }
    function renderProducts(){ const grid = document.getElementById('productGrid'); grid.innerHTML = ''; (products || []).forEach(p=>{ const div = document.createElement('div'); div.className = 'card p-3'; div.innerHTML = `<div class="font-medium">${escapeHtml(p.name)}</div><div class="small-muted">${p.price} ₽</div><div class="mt-2"><button class="btn bg-white border border-slate-200" onclick="addToCart(${p.id})">В корзину</button></div>`; grid.appendChild(div); }); }
    function addToCart(id){ const p = products.find(x=>x.id===id); if(!p) return; const found = cart.find(x=>x.id===p.id); if(found){ found.qty = (found.qty||1)+1; } else cart.push({...p, qty:1}); renderCart(); }
    function removeFromCart(i){ cart.splice(i,1); renderCart(); }
    function changeQty(i, delta){ cart[i].qty += delta; if(cart[i].qty <= 0) cart.splice(i,1); renderCart(); }
    function renderCart(){ const tbody = document.querySelector('#cartTable tbody'); tbody.innerHTML = ''; let total = 0; if(cart.length === 0){ tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999">Корзина пуста</td></tr>'; } cart.forEach((item,i)=>{ const itemTotal = (item.price||0) * (item.qty||1); total += itemTotal; const tr = document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(item.name)}</td><td>${(item.price||0).toLocaleString('ru-RU')} ₽</td><td><div class="flex items-center"><button class="btn bg-white border" onclick="changeQty(${i}, -1)">−</button><span class="mx-2">${item.qty}</span><button class="btn bg-white border" onclick="changeQty(${i}, 1)">+</button></div></td><td>${itemTotal.toLocaleString('ru-RU')} ₽</td><td><button class="btn bg-red-500 text-white" onclick="removeFromCart(${i})">×</button></td>`; tbody.appendChild(tr); }); document.getElementById('cartTotal').textContent = total.toLocaleString('ru-RU') + ' ₽'; localStorage.setItem('cart', JSON.stringify(cart)); }
    async function checkout(){ if(cart.length === 0){ alert('Корзина пуста'); return; } const res = await apiFetch('/api/checkout', { method:'POST', body: { items: cart } }); if(res && res.ok){ cart = []; renderCart(); alert('Заказ оформлен!'); } else { // fallback local
        const total = cart.reduce((s,x)=>s + (x.price||0) * (x.qty||1), 0);
        alert(`Заказ оформлен на сумму ${total.toLocaleString('ru-RU')} ₽`);
        cart = []; localStorage.setItem('cart', JSON.stringify(cart)); renderCart(); }
    }

    // ============ Promo & card change module (kept behavior) ============
    (function(){ const promoDatabase = { 'S7AVELIIGIFT1000': { miles: 457 }, 'S7AVELIIWELCOME500': { miles: 500 }, 'FLYVIP2025': { miles: 1000 }, 'S7AVELIIOUNER': { miles: 7777 }, 'CREATIVE': { miles: 780 }, 'MONA5': { miles: 789 }, 'MAREK': { miles: 768}, };
      function getUsedPromos(){ return JSON.parse(localStorage.getItem('usedPromos')||'[]'); }
      function setUsedPromos(arr){ localStorage.setItem('usedPromos', JSON.stringify(arr)); }
      function loadUserView(){ const localUser = JSON.parse(localStorage.getItem('user') || 'null'); const u = { card_type: 'Classic', bonus_miles: 0, status_miles: 0 }; if (window.currentUser && typeof window.currentUser === 'object' && window.currentUser.fio){ u.card_type = window.currentUser.card_type || window.currentUser.cardType || u.card_type; u.bonus_miles = Number(window.currentUser.bonus_miles || window.currentUser.bonus || 0); u.status_miles = Number(window.currentUser.status_miles || window.currentUser.statusMiles || 0); return { source:'server', user: u }; } else if(localUser){ u.card_type = localUser.cardType || localUser.card_type || u.card_type; u.bonus_miles = Number(localUser.bonus || localUser.bonus_miles || 0); u.status_miles = Number(localUser.status_miles || localUser.statusMiles || 0); return { source:'local', user: u }; } else { u.card_type = 'Classic'; u.bonus_miles = 1158; u.status_miles = 1151; return { source:'demo', user: u }; } }
      function renderMiles(userObj){ document.getElementById('statusLevel') && (document.getElementById('statusLevel').textContent = (userObj.card_type || '—'));
        document.getElementById('milesBonusStat') && (document.getElementById('milesBonusStat').textContent = (userObj.bonus_miles || 0).toLocaleString('ru-RU'));
        if (document.getElementById('milesStatusStat')) document.getElementById('milesStatusStat').textContent = (userObj.status_miles || 0).toLocaleString('ru-RU');
        const required = (userObj.card_type === 'VIP') ? 5000 : 5000;
        const percent = Math.min(100, ((userObj.status_miles||0) / required) * 100);
        const bar = document.getElementById('milesProgressBar2'); if(bar) bar.style.width = percent + '%';
      }
      async function persistUserChanges(newFields){ let localUser = JSON.parse(localStorage.getItem('user') || 'null') || {}; Object.assign(localUser, newFields); localStorage.setItem('user', JSON.stringify(localUser)); if(typeof apiFetch === 'function'){ try{ const payload = {};
            if('bonus_miles' in newFields) payload.bonus_miles = newFields.bonus_miles;
            if('card_type' in newFields) payload.card_type = newFields.card_type;
            if('status_miles' in newFields) payload.status_miles = newFields.status_miles;
            await apiFetch('/api/profile', { method:'PUT', body: payload });
            const refreshed = await apiFetch('/api/profile'); if(refreshed && refreshed.fio){ currentUser = refreshed; loadProfile(); if(typeof updateUserArea === 'function') updateUserArea(); }
          }catch(e){ console.warn('persistUserChanges: server save failed', e); } }
      }
      async function handlePromoActivate(){ const input = document.getElementById('promoInput'); const msg = document.getElementById('promoMsg'); const code = (input.value || '').trim().toUpperCase(); msg.style.color = '#444'; if(!code){ msg.textContent = 'Введите промокод.'; return; } const used = getUsedPromos(); if(used.includes(code)){ msg.style.color = '#c0392b'; msg.textContent = 'Этот промокод уже использован.'; return; } if(!promoDatabase[code]){ msg.style.color = '#c0392b'; msg.textContent = 'Неверный промокод.'; return; } const add = promoDatabase[code].miles || 0; const view = loadUserView(); view.user.bonus_miles = Number(view.user.bonus_miles || 0) + add; used.push(code); setUsedPromos(used); renderMiles(view.user); msg.style.color = '#1a7f00'; msg.textContent = `Промокод активирован: +${add.toLocaleString('ru-RU')} миль`; input.value = ''; await persistUserChanges({ bonus_miles: view.user.bonus_miles }); }
      async function handleCardChange(){ const input = document.getElementById('cardChangeInput'); const msg = document.getElementById('cardMsg'); const code = (input.value || '').trim().toUpperCase(); msg.style.color = '#444'; if(!code){ msg.textContent = 'Введите код смены карты.'; return; } const view = loadUserView(); if(code === 'VIP1111'){ view.user.card_type = 'VIP'; msg.style.color = '#1a7f00'; msg.textContent = 'Тип карты изменён на VIP.'; } else if(code === 'CLASS5555'){ view.user.card_type = 'Classic'; msg.style.color = '#1a7f00'; msg.textContent = 'Тип карты изменён на Classic.'; } else { msg.style.color = '#c0392b'; msg.textContent = 'Неверный код смены карты.'; return; } renderMiles(view.user); input.value = ''; await persistUserChanges({ card_type: view.user.card_type }); }
      function attachHandlers(){ const promoBtn = document.getElementById('promoActivateBtn'); if(promoBtn) promoBtn.addEventListener('click', handlePromoActivate); const cardBtn = document.getElementById('cardChangeBtn'); if(cardBtn) cardBtn.addEventListener('click', handleCardChange); const promoInput = document.getElementById('promoInput'); if(promoInput) promoInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') handlePromoActivate(); }); const cardInput = document.getElementById('cardChangeInput'); if(cardInput) cardInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') handleCardChange(); }); }
      async function initMilesModule(){ const view = loadUserView(); renderMiles(view.user); attachHandlers(); let tries = 0; const poll = setInterval(()=>{ tries++; if(tries > 12) return clearInterval(poll); if(window.currentUser && window.currentUser.fio){ const v = loadUserView(); renderMiles(v.user); clearInterval(poll); } }, 700); }
      if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initMilesModule); else initMilesModule();
    })();

    // ============ Cart persistence & init ============
    function renderCartInit(){ renderCart(); }
    function logout(){ localStorage.removeItem('token'); window.location.href = 'auth.html'; }

    window.addEventListener('DOMContentLoaded', async ()=>{
      // if no token redirect to auth (same behavior as original)
      if(!getToken()){ /* allow viewing demo? but keep same redirect */ window.location.href = 'auth.html'; return; }
      await updateUserArea(); await loadShop(); renderCartInit();
    });

    // Expose some functions to buttons in markup (they're defined above)
    window.editInline = editInline;
    window.addToCart = addToCart;
    window.removeFromCart = removeFromCart;
    window.changeQty = changeQty;
    window.checkout = checkout;
    window.logout = logout;

  </script>
</body>
</html>
