<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>S7avelii | Профиль </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Mobile-first styles tuned to match the screenshot */
    :root{
      --bg: #f3f5f7;
      --card: #ffffff;
      --muted:#8b8f94;
      --accent:#9cc42f;
      --accent-dark:#6dbf2a;
      --dark-btn:#2f3337;
    }
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color:transparent;
    }

    /* center mobile look and allow scale on desktop */
    .viewport {
      width: 412px; /* mobile width from screenshot */
      margin: 0 auto;
      transform-origin: top center;
    }
    @media (min-width: 900px){
      /* scale the mobile layout to occupy a larger area on desktop */
      .viewport { transform: scale(1.1); }
    }

    header.topbar{
      position:sticky; top:0; z-index:40;
      background:var(--card); padding:14px 16px;
      display:flex; align-items:center; gap:12px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.04);
    }
    .avatar-circle{
      width:56px; height:56px; border-radius:9999px; object-fit:cover; border:4px solid var(--card); box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }
    .big-avatar{ width:86px; height:86px; border-radius:9999px; object-fit:cover; border:6px solid var(--card); box-shadow:0 8px 24px rgba(0,0,0,0.06); }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.04);
    }
    .muted { color: var(--muted); }
    .mile-badge { width:46px;height:46px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#eaf7b6,#d6ee7e);box-shadow:0 2px 6px rgba(0,0,0,0.04) }
    .progress-bg{ background:#f0f2f4;height:12px;border-radius:999px;overflow:hidden;}
    .progress-fill{ height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-dark)); width:0%; transition:width .45s ease; }

    /* big promo button */
    .big-promo-btn{
      width:100%; background:var(--dark-btn); color:#fff; border-radius:12px; padding:16px; text-align:center; font-size:22px; font-weight:600;
      box-shadow: 0 1px 0 rgba(0,0,0,0.05);
    }

    /* subtle spacing */
    .gap-y-12 > * + * { margin-top:12px; }
    .rounded-2xl { border-radius:18px; }

    /* match screenshot small text sizes */
    .small-muted{ color:var(--muted); font-size:13px; }
    .xl-title{ font-size:28px; font-weight:800; letter-spacing:0.5px; }
    .shadow-very-soft{ box-shadow: 0 6px 18px rgba(0,0,0,0.03); }

    /* list items */
    .list-row{ display:flex; gap:12px; align-items:center; padding:12px; background:var(--card); border-radius:12px; box-shadow:0 1px 0 rgba(0,0,0,0.03) }
    .list-row + .list-row { margin-top:8px; }
    .list-icon{ width:40px; height:40px; border-radius:10px; background:#f6fff0; display:flex; align-items:center; justify-content:center; }

    /* tiny helpers */
    .dot { width:14px;height:14px;border-radius:999px;background:var(--accent);display:inline-block;margin-right:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06) }
    /* ensure file inputs not visible */
    input[type="file"]{ display:none; }
  </style>
</head>
<body>
  <div class="viewport">

    <!-- top header (empty left icon same as screenshot) -->
    <header class="topbar">
      <div style="width:40px;height:40px;border-radius:9999px;background:#fff;display:flex;align-items:center;justify-content:center;">
        <!-- small left placeholder -->
      </div>
      <div style="flex:1"></div>
      <div id="userArea"></div>
    </header>

    <main style="padding:16px 16px 60px;">
      <!-- avatar & name -->
      <div style="display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:8px;">
        <label for="avatarInput" title="Нажмите чтобы загрузить фото" style="cursor:pointer;">
          <img id="bigAvatar" class="big-avatar" src="https://via.placeholder.com/150" alt="avatar">
        </label>
        <input id="avatarInput" type="file" accept="image/*">
        <div id="fioTitle" class="xl-title">Загрузка...</div>
      </div>

      <!-- top grid: left big card + right two small -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
        <!-- left large card (priority + balance) -->
        <div class="card rounded-2xl" style="display:flex;flex-direction:column;justify:space-between;padding:12px;">
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div>
              <div style="display:flex;align-items:center;gap:8px;">
                <div style="width:28px;height:28px;border-radius:6px;background:#eef2f6;display:flex;align-items:center;justify-content:center;font-weight:700;color:#556">S7</div>
                <div style="font-weight:700">Priority</div>
              </div>
              <div class="muted" style="margin-top:8px;letter-spacing:2px">115 757 155</div>
            </div>
            <div style="opacity:0.6">▢▢</div>
          </div>

          <div style="height:12px;margin:12px 0;border-top:1px solid #f1f2f4"></div>

          <div style="display:flex;align-items:center;justify-content:space-between">
            <div class="small-muted">ваш баланс</div>
            <div class="mile-badge"><img src="images/mile_icon.jpg" alt="M" style="width:20px;height:20px;object-fit:contain"></div>
          </div>
        </div>

        <!-- right column: two small action cards -->
        <div style="display:flex;flex-direction:column;gap:10px;">
          <div class="card rounded-2xl" style="padding:14px;display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div style="font-weight:700">Начисления</div>
              <div class="muted" style="font-size:13px">Списания</div>
            </div>
            <img src="images/mile_icon.jpg" alt="" style="width:44px;height:44px;object-fit:contain;opacity:0.9;border-radius:8px">
          </div>

          <div class="card rounded-2xl" style="padding:14px;display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div style="font-weight:700">Управлять</div>
              <div class="muted" style="font-size:13px">милями</div>
            </div>
            <div style="display:flex;gap:6px;align-items:center">
              <img src="images/yandex_plus.jpg" alt="" style="width:36px;height:36px;object-fit:contain;border-radius:8px">
            </div>
          </div>
        </div>
      </div>

      <!-- progress card -->
      <div class="card rounded-2xl" style="padding:14px;margin-bottom:14px;">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div style="display:flex;align-items:center;gap:10px;">
            <span class="dot"></span>
            <div class="small-muted">О статусе</div>
          </div>
          <div class="muted">О статусе ▸</div>
        </div>

        <div style="margin-top:12px;">
          <div class="progress-bg"><div id="mainProgress" class="progress-fill" style="width:0%"></div></div>
          <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:13px;color:var(--muted)">
            <div id="progressLeft">0 миль</div>
            <div id="progressRight">—</div>
          </div>
        </div>
      </div>

      <!-- big promo button -->
      <div style="margin-top:12px;">
        <button id="addPromoBtn" class="big-promo-btn">Добавить промокод</button>
      </div>

      <!-- telegram banner -->
      <div style="margin-top:14px;">
        <div class="card rounded-2xl" style="display:flex;align-items:center;justify-content:space-between;padding:18px;overflow:hidden;">
          <div style="flex:1;padding-right:12px;">
            <div style="font-weight:800;font-size:18px">Наш бот в Телеграме</div>
            <div class="muted" style="margin-top:6px">Подписывайтесь, чтобы знать о статусе рейса</div>
          </div>
          <div style="width:100px;flex-shrink:0;">
            <img src="images/telegram_block.jpg" alt="telegram" style="width:100px;height:100px;object-fit:cover;border-radius:12px;">
          </div>
        </div>
      </div>

      <!-- features list -->
      <div style="margin-top:16px;">
        <div class="list-row">
          <div class="list-icon"><img src="images/yandex_plus.jpg" alt="" style="width:22px;height:22px;object-fit:contain"></div>
          <div style="flex:1">
            <div style="font-weight:700">Яндекс Плюс x S7</div>
          </div>
        </div>

        <div class="list-row">
          <div class="list-icon"><img src="images/secret_passenger.jpg" alt="" style="width:22px;height:22px;object-fit:contain"></div>
          <div style="flex:1">
            <div style="font-weight:700">Тайный пассажир</div>
          </div>
        </div>

        <div class="list-row">
          <div class="list-icon"><img src="images/green_steps.jpg" alt="" style="width:22px;height:22px;object-fit:contain"></div>
          <div style="flex:1">
            <div style="font-weight:700">Green Steps</div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- ===== SCRIPTS: API + UI logic (интегрирован твой рабочий скрипт, адаптация под мобильный layout) ===== -->
  <script>
    /* ========== Конфигурация API ========== */
    const API = "https://s7avelii-airlines-1.onrender.com";
    function getToken(){ return localStorage.getItem('token'); }

    /* ========== apiFetch ========== */
    async function apiFetch(endpoint, options = {}) {
      const token = getToken();
      options.headers = { ...(options.headers || {}) };
      if (token) options.headers['Authorization'] = 'Bearer ' + token;
      if (options.body && !(options.body instanceof FormData) && typeof options.body !== 'string') {
        options.headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(options.body);
      }
      try {
        const res = await fetch(API + endpoint, options);
        if (!res) return null;
        if (res.status === 401) { logout(); return null; }
        const txt = await res.text();
        try { return JSON.parse(txt); } catch(e) { return { raw: txt, status: res.status }; }
      } catch (e) {
        console.error('fetch err', e);
        return null;
      }
    }

    /* ========== Helpers ========== */
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    function parseNumberSafe(v){
      if (v === null || v === undefined) return null;
      if (typeof v === 'number' && !Number.isNaN(v)) return v;
      if (typeof v === 'string'){
        const cleaned = v.replace(/\s+/g,'').replace(/[^0-9\-,.]/g,'');
        if (cleaned === '') return null;
        let normalized = cleaned;
        const commaCount = (cleaned.match(/,/g)||[]).length;
        const dotCount = (cleaned.match(/\./g)||[]).length;
        if (commaCount > 0 && dotCount === 0){ normalized = cleaned.replace(/,/g,''); }
        else if (dotCount > 0 && commaCount === 0){ normalized = cleaned; }
        else if (commaCount > 0 && dotCount > 0){
          if (cleaned.lastIndexOf(',') > cleaned.lastIndexOf('.')) normalized = cleaned.replace(/\./g,'').replace(',', '.');
          else normalized = cleaned.replace(/,/g,'');
        }
        const num = Number(normalized);
        if (!Number.isNaN(num)) return Math.floor(num);
        return null;
      }
      return null;
    }
    function findMilesInObject(obj, visited = new WeakSet()){
      if (!obj || typeof obj !== 'object') return null;
      if (visited.has(obj)) return null;
      visited.add(obj);
      try {
        const keys = Object.keys(obj);
        const keyPatterns = [/^miles?$/i, /bonus/i, /status/i, /points?/i, /balance/i, /mile/i];
        for (const pat of keyPatterns){
          for (const k of keys){
            if (pat.test(k)){
              const v = obj[k];
              const n = parseNumberSafe(v);
              if (n !== null) return n;
            }
          }
        }
        for (const k of keys){
          if (/mile|miles|bonus|points|balance|status/i.test(k)){
            const v = obj[k];
            const n = parseNumberSafe(v);
            if (n !== null) return n;
          }
        }
        for (const k of keys){
          const v = obj[k];
          if (v && typeof v === 'object'){
            const deeper = findMilesInObject(v, visited);
            if (deeper !== null) return deeper;
          }
        }
      } catch(e){}
      return null;
    }

    /* ========== Levels (твоя шкала) ========== */
    const LEVELS = [
      { name: 'Classic', min: 0, max: 1000 },
      { name: 'VIP', min: 1000, max: 10000 },
      { name: 'Master', min: 10000, max: 100000 },
      { name: 'Flight Master', min: 100000, max: 500000 }
    ];
    function getLevelByMiles(miles){
      for(let i=LEVELS.length-1;i>=0;i--){ if(miles >= LEVELS[i].min) return LEVELS[i]; }
      return LEVELS[0];
    }

    /* ========== State ========== */
    let currentUser = null;

    /* ========== Update header user area (mini widget) ========== */
    async function updateUserArea() {
      const userArea = document.getElementById('userArea');
      const token = getToken();
      if (!token) {
        if (userArea) userArea.innerHTML = `<a href="auth.html" style="color:#6dd808;border:1px solid #cfeab2;padding:6px 10px;border-radius:8px;text-decoration:none">Вход</a>`;
        return;
      }
      try {
        const res = await apiFetch('/api/profile');
        if (!res || (Object.keys(res).length===0)) { if (userArea) userArea.innerHTML = `<a href="auth.html">Вход</a>`; return; }
        const user = res.user || res;
        currentUser = user;

        const savedAvatar = localStorage.getItem('userAvatar') || '';
        let avatarUrl = null;
        if (user.avatar) avatarUrl = (String(user.avatar).startsWith('http') ? user.avatar : API + user.avatar);
        else if (savedAvatar) avatarUrl = savedAvatar;
        if (!avatarUrl) avatarUrl = 'https://via.placeholder.com/150';

        const fio = user.fio || user.email || 'Профиль';
        const parts = String(fio).split(/\s+/).filter(Boolean);
        const firstName = parts[0] || '';
        const surnameInitial = parts[1] ? parts[1][0] + '.' : '';
        const nameShort = firstName + (surnameInitial ? (' ' + surnameInitial) : '');

        let miles = null;
        if (user.miles !== undefined) miles = parseNumberSafe(user.miles);
        if (miles === null) miles = findMilesInObject(user) ?? findMilesInObject(res);
        if (miles === null) miles = 0;

        if (userArea) {
          userArea.innerHTML = `
            <div style="display:flex;align-items:center;gap:8px">
              <img src="${avatarUrl}" alt="avatar" style="width:36px;height:36px;border-radius:9999px;object-fit:cover;border:2px solid #fff">
              <div style="text-align:right">
                <div style="font-weight:700;font-size:13px">${escapeHtml(nameShort)}</div>
                <div style="font-size:12px;color:var(--muted)">${Number(miles).toLocaleString('ru-RU')} <img src="images/mile_icon.jpg" style="width:14px;height:14px;vertical-align:middle;margin-left:4px"></div>
              </div>
            </div>
          `;
        }

        if (user.avatar) {
          try { localStorage.setItem('userAvatar', avatarUrl); } catch(e){}
        }
        currentUser = user;
        renderProfileUI();
      } catch (e) {
        console.error('updateUserArea err', e);
        if (userArea) userArea.innerHTML = `<a href="auth.html">Вход</a>`;
      }
    }

    /* ========== Render profile to page (fills elements) ========== */
    function renderProfileUI(){
      if(!currentUser) return;
      // name short
      const fio = currentUser.fio || '';
      const parts = String(fio).split(/\s+/).filter(Boolean);
      const firstName = parts[0] || '';
      const surnameInitial = parts[1] ? parts[1][0] + '.' : '';
      const fioTitle = firstName ? (firstName + (surnameInitial ? (' ' + surnameInitial) : '')) : (currentUser.email || 'Профиль');
      document.getElementById('fioTitle').textContent = fioTitle;

      // avatar
      const savedAvatar = localStorage.getItem('userAvatar') || '';
      let avatarUrl = currentUser.avatar ? (String(currentUser.avatar).startsWith('http') ? currentUser.avatar : API + currentUser.avatar) : (savedAvatar || 'https://via.placeholder.com/150');
      const bigAvatar = document.getElementById('bigAvatar');
      if (bigAvatar) bigAvatar.src = avatarUrl;

      // miles
      const detectedMiles = (currentUser.miles !== undefined ? parseNumberSafe(currentUser.miles) : null) ?? findMilesInObject(currentUser) ?? 0;
      // update counters
      const topCount = document.getElementById('milesCountTop');
      const rightCount = document.getElementById('milesCount');
      if (topCount) topCount.textContent = detectedMiles.toLocaleString('ru-RU');
      if (rightCount) rightCount.textContent = detectedMiles.toLocaleString('ru-RU') + ' м';

      // progress calculation by defined levels
      const level = getLevelByMiles(detectedMiles);
      const nextLevel = LEVELS.find(l => l.min > level.min);
      const currentMin = level.min;
      const nextMin = nextLevel ? nextLevel.min : level.max;
      const denom = (nextMin - currentMin) || 1;
      const progressPercent = nextLevel ? ((detectedMiles - currentMin) / denom) * 100 : 100;

      const mainProgress = document.getElementById('mainProgress');
      if (mainProgress) mainProgress.style.width = Math.max(0, Math.min(100, progressPercent)) + '%';
      const progressLeft = document.getElementById('progressLeft');
      const progressRight = document.getElementById('progressRight');
      if (progressLeft) progressLeft.textContent = currentMin.toLocaleString('ru-RU') + ' миль';
      if (progressRight) progressRight.textContent = nextMin ? nextMin.toLocaleString('ru-RU') + ' миль' : '—';

      // level name in sidebar if exists
      const levelName = document.getElementById('levelName');
      if (levelName) levelName.textContent = level.name;

      // store avatar persistently
      if (currentUser.avatar) {
        try { localStorage.setItem('userAvatar', avatarUrl); } catch(e){}
      }
    }

    /* ========== Avatar upload (persist) ========== */
    function attachAvatarUpload(){
      const avatarInput = document.getElementById('avatarInput');
      if(!avatarInput) return;
      avatarInput.addEventListener('change', async function(){
        if(!this.files[0]) return;
        const fd = new FormData();
        fd.append('avatar', this.files[0]);
        const token = getToken();
        try{
          const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
          const resRaw = await fetch(API + '/api/profile/avatar', { method: 'POST', headers, body: fd });
          if(!resRaw) throw new Error('no response');
          const txt = await resRaw.text();
          let data;
          try { data = JSON.parse(txt); } catch(e){ data = { raw: txt }; }
          const avatarReturned = (data && (data.avatar || (data.user && data.user.avatar))) ? (data.avatar || data.user.avatar) : null;
          if (avatarReturned) {
            const avatarUrl = String(avatarReturned).startsWith('http') ? avatarReturned : API + avatarReturned;
            const avatarImg = document.getElementById('bigAvatar');
            if (avatarImg) avatarImg.src = avatarUrl;
            try { localStorage.setItem('userAvatar', avatarUrl); } catch(e){}
            await updateUserArea();
          } else {
            // If server didn't return avatar path, try to save using local blob url
            const file = this.files[0];
            const blobUrl = URL.createObjectURL(file);
            try { localStorage.setItem('userAvatar', blobUrl); } catch(e){}
            const avatarImg = document.getElementById('bigAvatar');
            if (avatarImg) avatarImg.src = blobUrl;
            await updateUserArea();
          }
        }catch(err){ console.error('avatar upload', err); alert('Ошибка сети при загрузке'); }
      });
    }

    /* ========== Promo button (opens prompt, tries to PUT to profile) ========== */
    document.getElementById && (function attachPromo(){
      const btn = document.getElementById('addPromoBtn');
      if (!btn) return;
      btn.addEventListener('click', async ()=>{
        const code = prompt('Введите промокод');
        if (!code) return;
        // example behavior: try to increase miles on server via PUT /api/profile
        const inc = 500; // demo increment (can be replaced by server-side logic)
        const profile = await apiFetch('/api/profile');
        const user = (profile && profile.user) ? profile.user : profile;
        const newMiles = (Number(user.miles || 0) + inc);
        const upd = await apiFetch('/api/profile', { method: 'PUT', body: { miles: newMiles } });
        if (upd) {
          await updateUserArea();
          alert('Промокод применён, +' + inc + ' миль');
        } else {
          alert('Ошибка применения промокода');
        }
      });
    })();

    /* ========== Init on DOMContentLoaded ========== */
    document.addEventListener('DOMContentLoaded', async ()=>{
      attachAvatarUpload();
      await updateUserArea();
      // ensure profile rendering after update
      renderProfileUI();
    });

    /* ========== Logout placeholder ========== */
    function logout(){ localStorage.removeItem('token'); /* redirect if needed */ }

    /* expose minor functions if needed */
    window.updateUserArea = updateUserArea;
    window.renderProfileUI = renderProfileUI;
  </script>
</body>
</html>

