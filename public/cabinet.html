<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî S7 Airlines</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    body {
      background-color: #f6f8fa;
      color: #222;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #0b3d2e;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 32px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    header h1 {
      font-weight: 600;
      font-size: 20px;
    }
    #userArea img {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      cursor: pointer;
      object-fit: cover;
      border: 2px solid #fff3;
      transition: 0.2s;
    }
    #userArea img:hover {
      border-color: #fff;
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 24px;
      padding: 32px;
      max-width: 1200px;
      margin: 0 auto;
    }

    nav {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    nav a {
      padding: 14px 20px;
      font-weight: 500;
      color: #0b3d2e;
      text-decoration: none;
      display: flex;
      align-items: center;
      transition: 0.2s;
    }
    nav a:hover {
      background: #eef5f2;
    }
    nav a.active {
      background: #0b3d2e;
      color: #fff;
    }
    nav a svg {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      fill: currentColor;
    }

    section {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      padding: 24px;
      display: none;
    }
    section.active { display: block; }

    h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #0b3d2e;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .profile-header img {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #e6e6e6;
    }
    .profile-info div {
      margin-bottom: 6px;
      font-size: 15px;
    }
    .input-inline {
      width: 100%;
      padding: 6px 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .progress {
      background: #eee;
      border-radius: 8px;
      overflow: hidden;
      height: 8px;
      margin: 6px 0 14px;
    }
    .progress-bar {
      height: 8px;
      background: #00b976;
      width: 0%;
      transition: width 0.4s;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px,1fr));
      gap: 16px;
      margin-top: 20px;
    }
    .stat-card {
      background: #f9fbfa;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      border: 1px solid #e0e6e3;
    }
    .stat-card h3 {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #0b3d2e;
    }
    .stat-card p {
      font-size: 18px;
      font-weight: 600;
      color: #00b976;
    }

    .btn {
      background: #00b976;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      transition: 0.2s;
      font-weight: 500;
    }
    .btn:hover {
      background: #029b63;
    }
    .btn.secondary {
      background: #ddd;
      color: #333;
    }

    #productGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(200px,1fr));
      gap: 16px;
    }
    .card {
      border: 1px solid #e0e6e3;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      background: #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    .card .small-muted {
      color: #777;
      font-size: 14px;
      margin: 4px 0 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th {
      color: #555;
      font-weight: 500;
    }
    #cartTotal {
      text-align: right;
      font-weight: 600;
      padding: 12px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
    <div id="userArea">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </header>

  <main>
    <nav class="tabs">
      <a href="#" data-tab="profile" class="active" onclick="showTab(event)">
         –ü—Ä–æ—Ñ–∏–ª—å
      </a>
      <a href="#" data-tab="miles" onclick="showTab(event)">
         –ú–∏–ª–∏
      </a>
      <a href="#" data-tab="shop" onclick="showTab(event)">
         –ú–∞–≥–∞–∑–∏–Ω
      </a>
      <a href="#" data-tab="cart" onclick="showTab(event)">
         –ö–æ—Ä–∑–∏–Ω–∞
      </a>
      <a href="#" onclick="logout()">üö™ –í—ã—Ö–æ–¥</a>
    </nav>

    <div class="grid">
      <section id="profile" class="active">
        <div class="profile-header">
          <img id="avatar" src="https://via.placeholder.com/100" alt="avatar">
          <input type="file" id="avatarInput" style="display:none">
          <div class="profile-info">
            <div><b>–§–ò–û:</b> <span id="fioField" ondblclick="editInline('fio')">‚Äî</span></div>
            <div><b>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</b> <span id="dobField" ondblclick="editInline('dob')">‚Äî</span></div>
            <div><b>–ü–æ–ª:</b> <span id="genderField" ondblclick="editInline('gender')">‚Äî</span></div>
            <div><b>Email:</b> <span id="emailField" ondblclick="editInline('email')">‚Äî</span></div>
            <div><b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> <span id="phoneField" ondblclick="editInline('phone')">‚Äî</span></div>
          </div>
        </div>
        <div class="stats">
          <div class="stat-card">
            <h3>–ë–æ–Ω—É—Å–Ω—ã–µ –º–∏–ª–∏</h3>
            <p id="bonusMiles">0</p>
          </div>
          <div class="stat-card">
            <h3>–°—Ç–∞—Ç—É—Å–Ω—ã–µ –º–∏–ª–∏</h3>
            <p id="milesStatusStat">0</p>
          </div>
        </div>
      </section>

      <section id="miles">
        <h2>–í–∞—à–∏ –º–∏–ª–∏</h2>
        <div style="margin-bottom:10px">
          <div>–ë–æ–Ω—É—Å–Ω—ã–µ –º–∏–ª–∏:</div>
          <div class="progress"><div id="milesProgressBar" class="progress-bar"></div></div>
          <div id="milesLabelRight" style="font-size:14px;color:#555">0 –º–∏–ª—å</div>
        </div>
        <div>
          <div>–°—Ç–∞—Ç—É—Å–Ω—ã–µ –º–∏–ª–∏:</div>
          <div class="progress"><div id="milesProgressBar2" class="progress-bar"></div></div>
          <div id="nextLevelLeft" style="font-size:14px;color:#555">0/1000</div>
        </div>
      </section>

      <section id="shop">
        <h2>–ú–∞–≥–∞–∑–∏–Ω</h2>
        <div id="productGrid"></div>
      </section>

      <section id="cart">
        <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
        <table id="cartTable">
          <thead><tr><th>–¢–æ–≤–∞—Ä</th><th>–¶–µ–Ω–∞</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="cartTotal">0 ‚ÇΩ</div>
        <button class="btn" onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </section>
    </div>
  </main>

  <script>
    const API = "https://s7avelii-airlines-1.onrender.com"; // <- –∑–∞–º–µ–Ω–∏, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω —Å–≤–æ–π backend
    function getToken(){return localStorage.getItem('token');}
    let currentUser=null;let products=[];let cart=[];
    async function apiFetch(endpoint,options={}) {
      const token=getToken();
      options.headers={...(options.headers||{})};
      if(token)options.headers['Authorization']='Bearer '+token;
      if(options.body && !(options.body instanceof FormData) && typeof options.body!=='string'){
        options.headers['Content-Type']='application/json';
        options.body=JSON.stringify(options.body);
      }
      const res=await fetch(API+endpoint,options).catch(e=>{console.error('fetch err',e);return null;});
      if(!res)return null;
      if(res.status===401){logout();return null;}
      const json=await res.json().catch(()=>({}));
      return json;
    }

    async function updateUserArea(){
      const userArea=document.getElementById('userArea');
      const token=getToken();
      if(!token){userArea.innerHTML=`<a href="auth.html">–í—Ö–æ–¥</a>`;return;}
      try{
        const user=await apiFetch('/api/profile');
        if(!user||!user.fio){userArea.innerHTML=`<a href="auth.html">–í—Ö–æ–¥</a>`;return;}
        currentUser=user;
        if(user.avatar){
          const avatarUrl=(user.avatar.startsWith('http')?user.avatar:API+user.avatar);
          userArea.innerHTML=`<img src="${avatarUrl}" alt="avatar" onclick="window.location.href='cabinet.html'">`;
          document.getElementById('avatar').src=avatarUrl;
        } else {
          const short=(user.fio&&user.fio.split(' ')[0])||user.email||'–ü—Ä–æ—Ñ–∏–ª—å';
          userArea.innerHTML=`<span style="cursor:pointer;color:#00b976;font-weight:500;" onclick="window.location.href='cabinet.html'">${escapeHtml(short)}</span>`;
        }
        loadProfile();
      }catch(e){
        console.error('updateUserArea err',e);
        userArea.innerHTML=`<a href="auth.html">–í—Ö–æ–¥</a>`;
      }
    }

    function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
    function showTab(evt){
      evt.preventDefault();
      const tab=evt.currentTarget.dataset.tab;
      document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
      evt.currentTarget.classList.add('active');
      document.querySelectorAll('section').forEach(s=>s.style.display='none');
      document.getElementById(tab).style.display='block';
    }

    function loadProfile(){
      if(!currentUser)return;
      const set=(id,val)=>document.getElementById(id).textContent=val||'‚Äî';
      set('fioField',currentUser.fio);
      set('dobField',currentUser.dob);
      set('genderField',currentUser.gender);
      set('emailField',currentUser.email);
      set('phoneField',currentUser.phone);
      document.getElementById('bonusMiles').textContent=currentUser.bonus_miles||0;
      const perc=Math.min(100,(currentUser.bonus_miles||0)/1000*100);
      document.getElementById('milesProgressBar').style.width=perc+'%';
      document.getElementById('milesLabelRight').textContent=(currentUser.bonus_miles||0)+' –º–∏–ª—å';
      document.getElementById('milesStatusStat').textContent=currentUser.status_miles||0;
      document.getElementById('milesProgressBar2').style.width=Math.min(100,(currentUser.status_miles||0)/1000*100)+'%';
      document.getElementById('nextLevelLeft').textContent=(currentUser.status_miles||0)+'/1000';
    }
    async function editInline(field){
      if(!currentUser)return;
      const map={fio:'fioField',dob:'dobField',gender:'genderField',email:'emailField',phone:'phoneField',card_number:'card_field'};
      const domId=map[field]||field+'Field';
      const container=document.getElementById(domId);
      if(!container)return;
      const cur=(field==='card_number'?currentUser.card_number:currentUser[field])||'';
      let input;
      if(field==='dob'){input=document.createElement('input');input.type='date';input.value=cur;}
      else if(field==='gender'){
        input=document.createElement('select');
        ['','–ú—É–∂—Å–∫–æ–π','–ñ–µ–Ω—Å–∫–∏–π','–î—Ä—É–≥–æ–µ'].forEach(v=>{
          const o=document.createElement('option');o.value=v;o.textContent=v||'–ù–µ —É–∫–∞–∑–∞–Ω';if(v===cur)o.selected=true;
          input.appendChild(o);
        });
      } else if(field==='phone'){input=document.createElement('input');input.type='tel';input.value=cur;}
      else {input=document.createElement('input');input.type='text';input.value=cur;}
      input.className='input-inline';
      let saved=false;
      input.addEventListener('change',async()=>{await saveField(field,input.value);saved=true;});
      input.addEventListener('blur',async()=>{if(!saved)await saveField(field,input.value);});
      container.innerHTML='';container.appendChild(input);input.focus();
    }

    async function saveField(field,value){
      const payload={};payload[field]=value;
      const res=await apiFetch('/api/profile',{method:'PUT',body:payload});
      if(res&&res.ok){
        const updated=await apiFetch('/api/profile');
        if(updated){currentUser=updated;loadProfile();updateUserArea();}
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        const re=await apiFetch('/api/profile');if(re){currentUser=re;loadProfile();}
      }
    }

    document.getElementById('avatar').addEventListener('click',()=>document.getElementById('avatarInput').click());
    document.getElementById('avatarInput').addEventListener('change',async function(){
      if(!this.files[0])return;
      const fd=new FormData();fd.append('avatar',this.files[0]);
      const token=getToken();
      try{
        const res=await fetch(API+'/api/profile/avatar',{method:'POST',headers:token?{'Authorization':'Bearer '+token}:{},body:fd});
        const data=await res.json();
        if(data&&data.avatar){
          const avatarUrl=data.avatar.startsWith('http')?data.avatar:API+data.avatar;
          document.getElementById('avatar').src=avatarUrl;
          await updateUserArea();
        } else alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞');
      }catch(err){console.error('avatar upload',err);alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ');}
    });

    async function loadShop(){
      const data=await apiFetch('/api/shop');
      products=(data&&data.products)?data.products:[];
      renderProducts();
    }

    function renderProducts(){
      const grid=document.getElementById('productGrid');
      grid.innerHTML='';
      products.forEach(p=>{
        const div=document.createElement('div');
        div.className='card';
        div.innerHTML=`<div style="font-weight:600">${escapeHtml(p.name)}</div>
                       <div class="small-muted">${p.price} ‚ÇΩ</div>
                       <button class="btn" onclick="addToCart(${p.id})">–í –∫–æ—Ä–∑–∏–Ω—É</button>`;
        grid.appendChild(div);
      });
    }

    function addToCart(id){
      const p=products.find(x=>x.id===id);
      if(!p)return;
      cart.push(p);
      renderCart();
    }

    function removeFromCart(i){
      cart.splice(i,1);
      renderCart();
    }

    function renderCart(){
      const tbody=document.getElementById('cartTable').querySelector('tbody');
      tbody.innerHTML='';
      let total=0;
      cart.forEach((p,i)=>{
        total+=p.price;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${escapeHtml(p.name)}</td>
                      <td>${p.price} ‚ÇΩ</td>
                      <td><button class="btn secondary" onclick="removeFromCart(${i})">√ó</button></td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('cartTotal').textContent=total+' ‚ÇΩ';
    }

    async function checkout(){
      if(cart.length===0){alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');return;}
      const res=await apiFetch('/api/checkout',{method:'POST',body:{items:cart}});
      if(res&&res.ok){cart=[];renderCart();alert('–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!');}
      else alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
    }

    function logout(){
      localStorage.removeItem('token');
      window.location.href='auth.html';
    }

    window.addEventListener('DOMContentLoaded',async()=>{
      const token=getToken();
      if(!token){window.location.href='auth.html';return;}
      await updateUserArea();
      await loadShop();
    });
  </script>
</body>
</html>
