<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Вход / Регистрация — S7avelii</title>

<script src="https://cdn.tailwindcss.com"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root { --green:#9cc42f; --green-dark:#8ab12a; }
* { box-sizing:border-box; font-family:'Open Sans', Arial, sans-serif; }

body {
  margin:0;
  min-height:100vh;
  background:#f4f6f8;
  display:flex;
  justify-content:center;
  align-items:center;
}

.card {
  width:100%;
  max-width:420px;
  background:#fff;
  border-radius:16px;
  padding:24px;
  box-shadow:0 12px 30px rgba(0,0,0,.15);
}

h2 {
  margin:0 0 10px;
  font-size:22px;
}

.subtitle {
  font-size:14px;
  color:#6b7280;
  margin-bottom:16px;
}

input, select {
  width:100%;
  padding:14px;
  font-size:16px;
  border-radius:12px;
  border:1px solid #d1d5db;
  margin-bottom:14px;
}

.btn {
  width:100%;
  background:var(--green);
  color:#fff;
  padding:14px;
  border-radius:14px;
  border:none;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
}

.btn:hover { background:var(--green-dark); }
.btn:disabled { opacity:.6; cursor:not-allowed; }

.switch {
  margin-top:16px;
  text-align:center;
  font-size:14px;
}

.switch button {
  background:none;
  border:0;
  color:var(--green);
  cursor:pointer;
  font-weight:600;
}

.error { color:#dc2626; font-size:14px; margin-top:10px; }
.success { color:#16a34a; font-size:14px; margin-top:10px; }
.hidden { display:none; }

.row { display:flex; gap:10px; flex-wrap:wrap; }
.half { flex:1; min-width:120px; }

.card-type {
  display:inline-flex;
  align-items:center;
  gap:8px;
  margin-top:8px;
  margin-right:10px;
}
</style>
</head>

<body>

<div class="card">

<!-- ================= ВХОД ПО SMS ================= -->
<div id="loginBlock">
  <h2>Вход в профиль</h2>
  <div class="subtitle">
    Введите телефон. Если вы ещё не регистрировались — только телефон
  </div>

  <input id="loginPhone" type="tel" placeholder="Телефон">

  <button id="sendCodeBtn" class="btn">Получить код</button>

  <div id="codeBlock" class="hidden">
    <input id="loginCode" type="text" placeholder="Код из SMS">
    <button id="verifyBtn" class="btn">Войти</button>
  </div>

  <div id="loginError" class="error"></div>

  <div class="switch">
    Нет аккаунта?
    <button id="toRegister">Зарегистрироваться</button>
  </div>
</div>

<!-- ================= РЕГИСТРАЦИЯ (КАК БЫЛА) ================= -->
<div id="registerBlock" class="hidden">
  <h2>Регистрация</h2>

  <input id="regFio" placeholder="ФИО">
  <input id="regEmail" type="email" placeholder="Email">

  <div class="row">
    <div class="half"><input id="regPhone" placeholder="Телефон"></div>
    <div class="half"><input id="regPassword" type="password" placeholder="Пароль (мин. 6)"></div>
  </div>

  <div class="row">
    <div class="half">
      <label>Дата рождения</label>
      <input id="regDob" type="date">
    </div>
    <div class="half">
      <label>Пол</label>
      <select id="regGender">
        <option value="">Не указан</option>
        <option value="Мужской">Мужской</option>
        <option value="Женский">Женский</option>
        <option value="Другое">Другое</option>
      </select>
    </div>
  </div>

  <input id="regCard" placeholder="Номер карты S7avelii Priority">

  <div>
    <label class="card-type"><input type="radio" name="cardType" value="VIP"> VIP</label>
    <label class="card-type"><input type="radio" name="cardType" value="Classic"> Classic</label>
    <label class="card-type"><input type="radio" name="cardType" value="None" checked> Нет</label>
  </div>

  <button id="registerBtn" class="btn">Зарегистрироваться</button>

  <div id="regError" class="error"></div>
  <div id="regSuccess" class="success"></div>

  <div class="switch">
    Уже есть аккаунт?
    <button id="toLogin">Войти</button>
  </div>
</div>

</div>

<script>
const API = 'https://s7avelii-airlines-1.onrender.com';

// --- Переключение ---
const loginBlock = document.getElementById('loginBlock');
const registerBlock = document.getElementById('registerBlock');

document.getElementById('toRegister').onclick = () => {
  loginBlock.classList.add('hidden');
  registerBlock.classList.remove('hidden');
};

document.getElementById('toLogin').onclick = () => {
  registerBlock.classList.add('hidden');
  loginBlock.classList.remove('hidden');
};

// --- ВХОД ПО SMS ---
const sendCodeBtn = document.getElementById('sendCodeBtn');
const verifyBtn = document.getElementById('verifyBtn');
const codeBlock = document.getElementById('codeBlock');
const loginError = document.getElementById('loginError');

sendCodeBtn.onclick = async () => {
  loginError.textContent = '';
  const phone = document.getElementById('loginPhone').value.trim();
  if (!phone) return loginError.textContent = 'Введите телефон';

  try {
    const res = await fetch(`${API}/api/auth/request-code`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ phone })
    });
    const data = await res.json();
    if (!res.ok) return loginError.textContent = data.error || 'Ошибка';

    codeBlock.classList.remove('hidden');
    sendCodeBtn.disabled = true;
    sendCodeBtn.textContent = 'Код отправлен';

  } catch {
    loginError.textContent = 'Ошибка сети';
  }
};

verifyBtn.onclick = async () => {
  loginError.textContent = '';
  const phone = document.getElementById('loginPhone').value.trim();
  const code = document.getElementById('loginCode').value.trim();

  if (!code) return loginError.textContent = 'Введите код';

  try {
    const res = await fetch(`${API}/api/auth/verify-code`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ phone, code })
    });
    const data = await res.json();
    if (!res.ok) return loginError.textContent = data.error || 'Неверный код';

    localStorage.setItem('token', data.token);
    window.location.href = 'cabinet.html';

  } catch {
    loginError.textContent = 'Ошибка сети';
  }
};

// --- РЕГИСТРАЦИЯ ---
document.getElementById('registerBtn').onclick = async () => {
  const fio = regFio.value.trim();
  const email = regEmail.value.trim();
  const phone = regPhone.value.trim();
  const password = regPassword.value;
  const dob = regDob.value || null;
  const gender = regGender.value || null;
  const cardNumber = regCard.value.trim();
  const cardType = document.querySelector('input[name="cardType"]:checked').value;

  if (!fio || !email || !phone || password.length < 6) {
    return regError.textContent = 'Заполните обязательные поля';
  }

  try {
    const res = await fetch(`${API}/api/register`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ fio,email,phone,password,dob,gender,cardNumber,cardType })
    });
    const data = await res.json();
    if (!res.ok) return regError.textContent = data.error || 'Ошибка';

    localStorage.setItem('token', data.token);
    regSuccess.textContent = 'Регистрация успешна';
    setTimeout(()=>window.location.href='cabinet.html',700);

  } catch {
    regError.textContent = 'Ошибка сети';
  }
};
</script>
<script>
function phoneMask(input) {
  let value = input.value.replace(/\D/g, '');

  if (value.startsWith('8')) value = '7' + value.slice(1);
  if (!value.startsWith('7')) value = '7' + value;

  let formatted = '+7';

  if (value.length > 1) formatted += ' (' + value.slice(1,4);
  if (value.length >= 5) formatted += ') ' + value.slice(4,7);
  if (value.length >= 8) formatted += '-' + value.slice(7,9);
  if (value.length >= 10) formatted += '-' + value.slice(9,11);

  input.value = formatted;
}

document.querySelectorAll('input[type="tel"]').forEach(input => {
  input.addEventListener('input', () => phoneMask(input));
  input.addEventListener('focus', () => {
    if (!input.value) input.value = '+7 ';
  });
});
</script>

</body>
</html>
