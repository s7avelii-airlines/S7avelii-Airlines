<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>S7avelii ‚Äî ID</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --green:#9cc42f;
  --green-dark:#8ab12a;
  --bg:#f4f6f8;
  --text:#111827;
  --muted:#6b7280;
}
*{box-sizing:border-box;font-family:'Inter',sans-serif}
body{margin:0;min-height:100vh;background:var(--bg);display:flex;justify-content:center;align-items:center;padding:16px;}
.card{width:100%;max-width:420px;background:#fff;border-radius:20px;padding:32px 28px;box-shadow:0 20px 40px rgba(0,0,0,.12);}
h1{font-size:28px;font-weight:700;margin:0 0 12px;}
.subtitle{font-size:16px;color:var(--muted);line-height:1.4;margin-bottom:28px;}
.field{position:relative;margin-bottom:20px;}
.field input, .field select{width:100%;padding:16px 16px 16px 68px;font-size:16px;border-radius:12px;border:1px solid #d1d5db;}
.field input:focus, .field select:focus{border-color:var(--green);outline:none;}
.flag{position:absolute;left:18px;top:50%;transform:translateY(-50%);font-size:22px;}
.btn{width:100%;padding:16px;font-size:16px;font-weight:600;border-radius:18px;border:none;cursor:pointer;}
.btn-primary{background:var(--green);color:#fff;}
.btn-primary:hover{background:var(--green-dark);}
.switch{text-align:center;margin-top:14px;font-size:14px;color:var(--muted);}
.switch button{background:none;border:0;color:var(--green);font-weight:600;cursor:pointer;}
.hidden{display:none}
.center{text-align:center}
.error{color:#dc2626;font-size:14px;margin-top:8px;}
.welcome{animation:fadeIn 0.8s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
</style>
</head>
<body>
<div class="card">

<!-- ===== –í–•–û–î –ü–û SMS ===== -->
<div id="smsLoginScreen">
  <h1>–í—Ö–æ–¥ –ø–æ SMS</h1>
  <div class="subtitle">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω</div>
  <div class="field"><span class="flag">üá∑üá∫</span><input id="smsPhone" type="tel" placeholder="+7 (___) ___-__-__"></div>
  <button id="sendSmsBtn" class="btn btn-primary">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
  <div id="smsError" class="error"></div>
  <div class="switch">–∏–ª–∏ <button onclick="showPasswordLogin()">–í–æ–π—Ç–∏ –ø–æ –ø–∞—Ä–æ–ª—é</button></div>
  <div class="switch">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <button onclick="showRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button></div>
</div>

<!-- ===== –í–•–û–î –ü–û –ü–ê–†–û–õ–Æ ===== -->
<div id="passwordLoginScreen" class="hidden">
  <h1>–í—Ö–æ–¥ –ø–æ –ø–∞—Ä–æ–ª—é</h1>
  <div class="subtitle">–¢–µ–ª–µ—Ñ–æ–Ω –∏ –ø–∞—Ä–æ–ª—å</div>
  <div class="field"><span class="flag">üá∑üá∫</span><input id="passPhone" type="tel" placeholder="+7 (___) ___-__-__"></div>
  <div class="field"><input id="passwordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å"></div>
  <button id="loginBtn" class="btn btn-primary">–í–æ–π—Ç–∏</button>
  <div id="passError" class="error"></div>
  <div class="switch">–∏–ª–∏ <button onclick="showSmsLogin()">–í–æ–π—Ç–∏ –ø–æ SMS</button></div>
  <div class="switch">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <button onclick="showRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button></div>
</div>

<!-- ===== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ===== -->
<div id="registerScreen" class="hidden">
  <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
  <div class="field"><input id="regFio" type="text" placeholder="–§–ò–û"></div>
  <div class="field"><span class="flag">üá∑üá∫</span><input id="regPhone" type="tel" placeholder="+7 (___) ___-__-__"></div>
  <div class="field"><input id="regDob" type="text" placeholder="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (–î–î/–ú–ú/–ì–ì–ì–ì)"></div>
  <div class="field"><select id="regGender"><option value="">–ü–æ–ª</option><option value="–ú">–ú</option><option value="–ñ">–ñ</option></select></div>
  <div class="field"><input id="regCard" type="text" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã"></div>
  <div class="field"><select id="regCardType"><option value="">–¢–∏–ø –∫–∞—Ä—Ç—ã</option><option value="Master">Master</option><option value="Priority">Priority</option><option value="Classik">Classik</option></select></div>
  <div class="field"><input id="regPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å"></div>
  <button id="registerBtn" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  <div id="regError" class="error"></div>
  <div class="switch">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <button onclick="showSmsLogin()">–í–æ–π—Ç–∏</button></div>
</div>

<!-- ===== WELCOME ===== -->
<div id="welcomeScreen" class="hidden center welcome">
  <h1>‚úàÔ∏è –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –±–æ—Ä—Ç</h1>
  <div id="welcomeName" class="subtitle"></div>
</div>

</div>

<script>
const API='https://s7avelii-airlines-1.onrender.com';

const smsLoginScreen=document.getElementById('smsLoginScreen');
const passwordLoginScreen=document.getElementById('passwordLoginScreen');
const registerScreen=document.getElementById('registerScreen');
const welcomeScreen=document.getElementById('welcomeScreen');
const welcomeName=document.getElementById('welcomeName');

function maskPhone(input){
  input.addEventListener('input',()=>{
    let v=input.value.replace(/\D/g,'');
    if(v.startsWith('8')) v='7'+v.slice(1);
    if(!v.startsWith('7')) v='7'+v;
    let r='+7';
    if(v.length>1) r+=' ('+v.slice(1,4);
    if(v.length>=5) r+=') '+v.slice(4,7);
    if(v.length>=8) r+='-'+v.slice(7,9);
    if(v.length>=10) r+='-'+v.slice(9,11);
    input.value=r;
  });
}
maskPhone(document.getElementById('smsPhone'));
maskPhone(document.getElementById('passPhone'));
maskPhone(document.getElementById('regPhone'));

document.getElementById('regDob').addEventListener('input',e=>{
  let v=e.target.value.replace(/\D/g,'');
  if(v.length>2) v=v.slice(0,2)+'/'+v.slice(2);
  if(v.length>5) v=v.slice(0,5)+'/'+v.slice(5,9);
  e.target.value=v;
});

document.getElementById('regCard').addEventListener('input',e=>{
  let v=e.target.value.replace(/\D/g,'').slice(0,16);
  e.target.value=v.replace(/(.{4})/g,'$1 ').trim();
});

function showSmsLogin(){smsLoginScreen.classList.remove('hidden');passwordLoginScreen.classList.add('hidden');registerScreen.classList.add('hidden');}
function showPasswordLogin(){smsLoginScreen.classList.add('hidden');passwordLoginScreen.classList.remove('hidden');registerScreen.classList.add('hidden');}
function showRegister(){smsLoginScreen.classList.add('hidden');passwordLoginScreen.classList.add('hidden');registerScreen.classList.remove('hidden');}

// SMS login
sendSmsBtn.onclick=async()=>{
  const phone=smsPhone.value.replace(/\D/g,'');
  if(phone.length!==11){smsError.textContent='–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä';return;}
  await fetch(API+'/api/auth/request-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone})});
  const code=prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS');
  const verify=await fetch(API+'/api/auth/verify-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone,code})});
  const data=await verify.json();
  if(verify.ok && data.token){
    localStorage.setItem('token',data.token);
  }
  if(!verify.ok){smsError.textContent=data.error||'–û—à–∏–±–∫–∞';return;}
  welcomeName.textContent=data.fio||'';
  smsLoginScreen.classList.add('hidden');
  welcomeScreen.classList.remove('hidden');
  setTimeout(()=>location.href='cabinet.html',2000);
};

// Password login
loginBtn.onclick=async()=>{
  const phone=passPhone.value.replace(/\D/g,'');
  const password=passwordInput.value.trim();
  if(phone.length!==11||!password){passError.textContent='–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ';return;}
  const res=await fetch(API+'/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone,password})});
  const data=await res.json();
  if(!res.ok){passError.textContent=data.error||'–û—à–∏–±–∫–∞';return;}
  localStorage.setItem('token',data.token);
  welcomeScreen.classList.remove('hidden');
  passwordLoginScreen.classList.add('hidden');
  setTimeout(()=>location.href='cabinet.html',2000);
};

// Registration FIXED
registerBtn.onclick=async()=>{
  const fio=regFio.value.trim();
  const phone=regPhone.value.replace(/\D/g,'');
  const dob=regDob.value.trim();
  const gender=regGender.value;
  const cardNumber=regCard.value.replace(/\s/g,'');
  const cardType=regCardType.value;
  const password=regPassword.value.trim();

  if(!fio||phone.length!==11||!dob||!gender||!cardNumber||!cardType||!password){
    regError.textContent='–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ';
    return;
  }

  const res=await fetch(API+'/api/register',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({fio,phone,dob,gender,cardNumber,cardType,password})
  });

  const data=await res.json();
  if(!res.ok){regError.textContent=data.error||'–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';return;}

  localStorage.setItem('token',data.token);
  welcomeName.textContent=fio;
  registerScreen.classList.add('hidden');
  welcomeScreen.classList.remove('hidden');
  setTimeout(()=>location.href='cabinet.html',2000);
};


// ===== AUTO LOGIN IF TOKEN EXISTS =====
(function(){
  const token=localStorage.getItem('token');
  if(!token) return;

  fetch(API+'/api/profile',{
    headers:{'Authorization':'Bearer '+token}
  })
  .then(r=>{
    if(!r.ok) throw new Error();
    return r.json();
  })
  .then(user=>{
    welcomeName.textContent=user.fio||'';
    smsLoginScreen.classList.add('hidden');
    passwordLoginScreen.classList.add('hidden');
    registerScreen.classList.add('hidden');
    welcomeScreen.classList.remove('hidden');

    setTimeout(()=>location.href='cabinet.html',1000);
  })
  .catch(()=>{
    localStorage.removeItem('token');
  });
})();

</script>
</body>
</html>
