<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–í—Ö–æ–¥ ‚Äî S7avelii</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --green:#9cc42f;
  --green-dark:#8ab12a;
  --bg:#f4f6f8;
  --text:#111827;
  --muted:#6b7280;
}

*{box-sizing:border-box;font-family:'Inter',sans-serif}

body{
  margin:0;
  min-height:100vh;
  background:var(--bg);
  display:flex;
  justify-content:center;
  align-items:center;
  padding:16px;
}

.card{
  width:100%;
  max-width:420px;
  background:#fff;
  border-radius:20px;
  padding:32px 28px;
  box-shadow:0 20px 40px rgba(0,0,0,.12);
}

h1{
  font-size:28px;
  font-weight:700;
  margin:0 0 12px;
}

.subtitle{
  font-size:16px;
  color:var(--muted);
  line-height:1.4;
  margin-bottom:28px;
}

.field{
  position:relative;
  margin-bottom:20px;
}

.field input{
  width:100%;
  padding:20px 20px 20px 68px;
  font-size:18px;
  border-radius:16px;
  border:1px solid #d1d5db;
}

.field input:focus{
  border-color:var(--green);
  outline:none;
}

.flag{
  position:absolute;
  left:18px;
  top:50%;
  transform:translateY(-50%);
  font-size:22px;
}

.btn{
  width:100%;
  padding:20px;
  font-size:18px;
  font-weight:600;
  border-radius:18px;
  border:none;
  cursor:pointer;
}

.btn-primary{
  background:var(--green);
  color:#fff;
}
.btn-primary:hover{background:var(--green-dark)}

.btn-secondary{
  background:#eef2f7;
  margin-top:14px;
}

.switch{
  text-align:center;
  margin-top:26px;
  font-size:15px;
  color:var(--muted);
}

.switch button{
  background:none;
  border:0;
  color:var(--green);
  font-weight:600;
  cursor:pointer;
}

.hidden{display:none}
.center{text-align:center}

.error{
  color:#dc2626;
  font-size:14px;
  margin-top:12px;
}

/* welcome animation */
.welcome{
  animation:fadeIn 0.8s ease;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:none}
}
</style>
</head>

<body>

<div class="card">

<!-- ===== –≠–ö–†–ê–ù –¢–ï–õ–ï–§–û–ù–ê ===== -->
<div id="phoneScreen">
  <h1>–í—Ö–æ–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å</h1>
  <div class="subtitle">
    –í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω. –ï—Å–ª–∏ –≤—ã –µ—â—ë –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å ‚Äî —Ç–æ–ª—å–∫–æ —Ç–µ–ª–µ—Ñ–æ–Ω
  </div>

  <div class="field">
    <span class="flag">üá∑üá∫</span>
    <input id="phoneInput" type="tel" placeholder="+7 (___) ___-__-__">
  </div>

  <button id="sendCodeBtn" class="btn btn-primary">
    –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
  </button>

  <div id="phoneError" class="error"></div>

  <div class="switch">
    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?
    <button onclick="location.href='register.html'">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  </div>
</div>

<!-- ===== –≠–ö–†–ê–ù –ö–û–î–ê ===== -->
<div id="codeScreen" class="hidden">
  <h1>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h1>
  <div class="subtitle">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS</div>

  <input id="codeInput"
         inputmode="numeric"
         maxlength="4"
         placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
         style="text-align:center;font-size:28px;padding:20px;border-radius:16px;border:1px solid #d1d5db">

  <button id="verifyBtn" class="btn btn-primary" style="margin-top:24px">
    –í–æ–π—Ç–∏
  </button>

  <div id="codeError" class="error"></div>
</div>

<!-- ===== WELCOME ===== -->
<div id="welcomeScreen" class="hidden center welcome">
  <h1>‚úàÔ∏è –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –±–æ—Ä—Ç</h1>
  <div id="welcomeName" class="subtitle"></div>
</div>

</div>

<script>
const API = 'https://s7avelii-airlines-1.onrender.com';

const phoneInput = document.getElementById('phoneInput');
const codeInput = document.getElementById('codeInput');

const phoneScreen = document.getElementById('phoneScreen');
const codeScreen = document.getElementById('codeScreen');
const welcomeScreen = document.getElementById('welcomeScreen');

const phoneError = document.getElementById('phoneError');
const codeError = document.getElementById('codeError');
const welcomeName = document.getElementById('welcomeName');

// --- phone mask ---
phoneInput.addEventListener('input', () => {
  let v = phoneInput.value.replace(/\D/g,'');
  if (v.startsWith('8')) v = '7' + v.slice(1);
  if (!v.startsWith('7')) v = '7' + v;
  let r = '+7';
  if (v.length > 1) r += ' (' + v.slice(1,4);
  if (v.length >= 5) r += ') ' + v.slice(4,7);
  if (v.length >= 8) r += '-' + v.slice(7,9);
  if (v.length >= 10) r += '-' + v.slice(9,11);
  phoneInput.value = r;
});

// --- send sms ---
sendCodeBtn.onclick = async () => {
  phoneError.textContent = '';
  if (phoneInput.value.replace(/\D/g,'').length < 11) {
    phoneError.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä';
    return;
  }

  const res = await fetch(API + '/api/auth/request-code', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ phone: phoneInput.value })
  });

  if (!res.ok) {
    phoneError.textContent = '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS';
    return;
  }

  phoneScreen.classList.add('hidden');
  codeScreen.classList.remove('hidden');
};

// --- verify code ---
verifyBtn.onclick = async () => {
  codeError.textContent = '';
  if (codeInput.value.length !== 4) {
    codeError.textContent = '–í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥';
    return;
  }

  const res = await fetch(API + '/api/auth/verify-code', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      phone: phoneInput.value,
      code: codeInput.value
    })
  });

  const data = await res.json();

  if (!res.ok) {
    codeError.textContent = data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥';
    return;
  }

  // ‚úÖ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
  localStorage.setItem('token', data.token);

  // ‚úÖ –∏–º—è –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞ (–ù–ï –∏–∑ JWT)
  welcomeName.textContent = data.fio || '';

  codeScreen.classList.add('hidden');
  welcomeScreen.classList.remove('hidden');

  setTimeout(() => {
    location.href = 'cabinet.html';
  }, 2000);
};
</script>

</body>
</html>
