<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Вход / Регистрация — S7avelii</title>
<style>
  :root{--green:#9cc42f;--green-dark:#8ab12a;--bg:#f5f7fa;--card:#fff;--muted:#666}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Arial,sans-serif;min-height:100vh;background:url("images/Blue Modern Business Proposal Presentation.avif") no-repeat center/cover}
  .card{width:100%;max-width:360px;background:rgba(255,255,255,0.95);border-radius:12px;padding:22px;margin:90px auto;box-shadow:0 6px 24px rgba(0,0,0,0.12)}
  h2{margin:0 0 14px;font-size:20px}
  input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #d6d8db;margin-top:10px;font-size:14px}
  .btn{width:100%;padding:12px;border-radius:8px;border:0;background:var(--green);color:#fff;font-weight:600;margin-top:14px;cursor:pointer}
  .btn:hover{background:var(--green-dark)}
  .error{color:#d23f44;margin-top:10px;font-size:13px}
  .success{color:green;margin-top:10px;font-size:13px}
  .switch{text-align:center;margin-top:14px}
  label.card-type{display:inline-flex;align-items:center;gap:8px;margin-right:8px}
  .small-muted{font-size:13px;color:#666;margin-top:8px}
</style>
</head>
<body>

<div class="card">
  <h2 id="title">Вход</h2>

  <form id="loginForm">
    <input id="loginFio" type="text" placeholder="ФИО" required autocomplete="name">
    <input id="loginPhone" type="tel" placeholder="Телефон" required autocomplete="tel">
    <input id="loginPassword" type="password" placeholder="Пароль" required>
    <button class="btn" type="submit">Войти</button>
    <div id="loginError" class="error"></div>
  </form>

  <form id="registerForm" class="hidden" autocomplete="on">
    <input id="regFio" type="text" placeholder="ФИО" required autocomplete="name">
    <input id="regDob" type="text" placeholder="Дата рождения (ДД.MM.ГГГГ)" autocomplete="bday">
    <input id="regGender" type="text" placeholder="Пол">
    <input id="regEmail" type="email" placeholder="Email" required autocomplete="email">
    <input id="regPhone" type="tel" placeholder="Телефон" required autocomplete="tel">
    <input id="regPassword" type="password" placeholder="Пароль" required>
    <input id="regCard" type="text" placeholder="Номер карты S7avelii Priority">

    <div class="small-muted">Выберите тип карты:</div>
    <label class="card-type"><input type="radio" name="regCardType" value="VIP"> VIP <img src="images/vip_card.png" alt="VIP" width="60"></label>
    <label class="card-type"><input type="radio" name="regCardType" value="Classic"> Classic <img src="images/classic_card.png" alt="Classic" width="60"></label>

    <button class="btn" type="submit">Зарегистрироваться</button>
    <div id="regError" class="error"></div>
    <div id="regSuccess" class="success"></div>
  </form>

  <div class="switch">Нет аккаунта? <span id="switchLink" style="color:var(--green);text-decoration:underline;cursor:pointer">Зарегистрироваться</span></div>
</div>

<script>
  // use relative API path — this avoids CORS if server serves public/ from same origin
  const API = '';

  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const switchLink = document.getElementById('switchLink');
  const title = document.getElementById('title');
  const loginError = document.getElementById('loginError');
  const regError = document.getElementById('regError');
  const regSuccess = document.getElementById('regSuccess');

  // redirect if already logged in
  window.addEventListener('DOMContentLoaded', () => {
    fetch(API + '/api/profile', { credentials: 'include' })
      .then(r => { if (r.ok) window.location.href = '/cabinet.html'; })
      .catch(() => {});
  });

  switchLink.addEventListener('click', () => {
    const loginShown = !loginForm.classList.contains('hidden');
    if(loginShown){
      loginForm.classList.add('hidden');
      registerForm.classList.remove('hidden');
      title.innerText = 'Регистрация';
      switchLink.innerText = 'Войти';
    } else {
      registerForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
      title.innerText = 'Вход';
      switchLink.innerText = 'Зарегистрироваться';
    }
    loginError.innerText=''; regError.innerText=''; regSuccess.innerText='';
  });

  // login — now sends password (server requires password)
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    loginError.innerText = '';
    const fio = document.getElementById('loginFio').value.trim();
    const phone = document.getElementById('loginPhone').value.trim();
    const password = document.getElementById('loginPassword').value;

    try{
      const resp = await fetch(API + '/api/login', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone, password })
      });
      const data = await resp.json();
      if(!resp.ok) { loginError.innerText = data.error || 'Ошибка входа'; return; }
      window.location.href = '/cabinet.html';
    }catch(err){
      loginError.innerText = 'Ошибка сети';
    }
  });

  // registration
  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    regError.innerText=''; regSuccess.innerText='';

    const fio = document.getElementById('regFio').value.trim();
    const dob = document.getElementById('regDob').value.trim();
    const gender = document.getElementById('regGender').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const phone = document.getElementById('regPhone').value.trim();
    const password = document.getElementById('regPassword').value;
    const card = document.getElementById('regCard').value.trim();
    const cardType = document.querySelector('input[name="regCardType"]:checked')?.value || '';

    try{
      const resp = await fetch(API + '/api/register', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fio, dob, gender, email, phone, card, cardType, password })
      });
      const data = await resp.json();
      if(!resp.ok){ regError.innerText = data.error || 'Ошибка регистрации'; return; }
      regSuccess.innerText = 'Регистрация успешна — выполняется переход...';
      setTimeout(()=> window.location.href = '/cabinet.html', 900);
    }catch(err){
      regError.innerText = 'Ошибка сети';
    }
  });
</script>
</body>
</html>
