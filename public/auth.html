<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>S7avelii ‚Äî ID</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --green:#9cc42f;
  --green-dark:#8ab12a;
  --bg:#f4f6f8;
  --text:#111827;
  --muted:#6b7280;
}
*{box-sizing:border-box;font-family:'Inter',sans-serif}
body{margin:0;min-height:100vh;background:var(--bg);display:flex;justify-content:center;align-items:center;padding:16px;}
.card{width:100%;max-width:420px;background:#fff;border-radius:20px;padding:32px 28px;box-shadow:0 20px 40px rgba(0,0,0,.12);}
h1{font-size:28px;font-weight:700;margin:0 0 12px;}
.subtitle{font-size:16px;color:var(--muted);line-height:1.4;margin-bottom:28px;}
.field{position:relative;margin-bottom:20px;}
.field input{width:100%;padding:20px 20px 20px 68px;font-size:18px;border-radius:16px;border:1px solid #d1d5db;}
.field input:focus{border-color:var(--green);outline:none;}
.flag{position:absolute;left:18px;top:50%;transform:translateY(-50%);font-size:22px;}
.btn{width:100%;padding:20px;font-size:18px;font-weight:600;border-radius:18px;border:none;cursor:pointer;}
.btn-primary{background:var(--green);color:#fff;}
.btn-primary:hover{background:var(--green-dark);}
.btn-secondary{background:#eef2f7;margin-top:14px;}
.switch{text-align:center;margin-top:26px;font-size:15px;color:var(--muted);}
.switch button{background:none;border:0;color:var(--green);font-weight:600;cursor:pointer;}
.hidden{display:none}
.center{text-align:center}
.error{color:#dc2626;font-size:14px;margin-top:12px;}
.welcome{animation:fadeIn 0.8s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
/* input icons padding for card/date/phone */
.input-icon{position:absolute;left:18px;top:50%;transform:translateY(-50%);font-size:22px;}
@media (max-width:420px){.card{padding:24px 20px;}h1{font-size:24px;}}
</style>
</head>
<body>
<div class="card">

<!-- MAIN SCREEN -->
<div id="mainScreen">
  <h1>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
  <div class="subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±</div>
  <button class="btn btn-primary" onclick="showPhoneLogin()">–ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É</button>
  <button class="btn btn-secondary" onclick="showPasswordLogin()">–ß–µ—Ä–µ–∑ –ø–∞—Ä–æ–ª—å</button>
</div>

<!-- PHONE SCREEN -->
<div id="phoneScreen" class="hidden">
  <h1>–í—Ö–æ–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å</h1>
  <div class="subtitle">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω. –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî —Ç–æ–ª—å–∫–æ —Ç–µ–ª–µ—Ñ–æ–Ω</div>
  <div class="field">
    <span class="flag">üá∑üá∫</span>
    <input id="phoneInput" type="tel" placeholder="+7 (___) ___-__-__">
  </div>
  <button id="sendCodeBtn" class="btn btn-primary">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
  <div id="phoneError" class="error"></div>
  <div class="switch">
    –ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?
    <button onclick="showPasswordLogin()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –ø–∞—Ä–æ–ª—å</button>
  </div>
</div>

<!-- CODE SCREEN -->
<div id="codeScreen" class="hidden">
  <h1>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h1>
  <div class="subtitle">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS</div>
  <input id="codeInput" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="text-align:center;font-size:28px;padding:20px;border-radius:16px;border:1px solid #d1d5db">
  <button id="verifyBtn" class="btn btn-primary" style="margin-top:24px">–í–æ–π—Ç–∏</button>
  <div id="codeError" class="error"></div>
</div>

<!-- PASSWORD SCREEN -->
<div id="passwordScreen" class="hidden">
  <h1>–í—Ö–æ–¥ —á–µ—Ä–µ–∑ –ø–∞—Ä–æ–ª—å</h1>
  <div class="field">
    <span class="flag">üá∑üá∫</span>
    <input id="loginPhone" type="tel" placeholder="+7 (___) ___-__-__">
  </div>
  <div class="field">
    <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  </div>
  <button id="loginBtn" class="btn btn-primary">–í–æ–π—Ç–∏</button>
  <div id="loginError" class="error"></div>
  <div class="switch">
    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?
    <button onclick="showPhoneLogin()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É</button>
  </div>
</div>

<!-- REGISTER SCREEN -->
<div id="registerScreen" class="hidden">
  <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
  <div class="subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ</div>
  <div class="field">
    <input id="regFio" placeholder="–§–ò–û">
  </div>
  <div class="field">
    <input id="regEmail" type="email" placeholder="Email">
  </div>
  <div class="field">
    <span class="flag">üá∑üá∫</span>
    <input id="regPhone" type="tel" placeholder="+7 (___) ___-__-__">
  </div>
  <div class="field">
    <input id="regDob" placeholder="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –î–î/–ú–ú/–ì–ì–ì–ì">
  </div>
  <div class="field">
    <input id="regCard" placeholder="–ö–∞—Ä—Ç–∞ Priority 000 000 0...">
  </div>
  <div class="field">
    <input id="regPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  </div>
  <button id="regBtn" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  <div id="regError" class="error"></div>
</div>

<!-- WELCOME SCREEN -->
<div id="welcomeScreen" class="hidden center welcome">
  <h1>‚úàÔ∏è –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –±–æ—Ä—Ç</h1>
  <div id="welcomeName" class="subtitle"></div>
</div>

</div>

<script>
const API='https://s7avelii-airlines-1.onrender.com';

// Screens
const mainScreen=document.getElementById('mainScreen');
const phoneScreen=document.getElementById('phoneScreen');
const codeScreen=document.getElementById('codeScreen');
const passwordScreen=document.getElementById('passwordScreen');
const registerScreen=document.getElementById('registerScreen');
const welcomeScreen=document.getElementById('welcomeScreen');

// Inputs
const phoneInput=document.getElementById('phoneInput');
const codeInput=document.getElementById('codeInput');
const loginPhone=document.getElementById('loginPhone');
const loginPassword=document.getElementById('loginPassword');
const regFio=document.getElementById('regFio');
const regEmail=document.getElementById('regEmail');
const regPhone=document.getElementById('regPhone');
const regDob=document.getElementById('regDob');
const regCard=document.getElementById('regCard');
const regPassword=document.getElementById('regPassword');

// Errors
const phoneError=document.getElementById('phoneError');
const codeError=document.getElementById('codeError');
const loginError=document.getElementById('loginError');
const regError=document.getElementById('regError');
const welcomeName=document.getElementById('welcomeName');

// --- SHOW FUNCTIONS ---
function showPhoneLogin(){mainScreen.classList.add('hidden');phoneScreen.classList.remove('hidden');passwordScreen.classList.add('hidden');registerScreen.classList.add('hidden');}
function showPasswordLogin(){mainScreen.classList.add('hidden');passwordScreen.classList.remove('hidden');phoneScreen.classList.add('hidden');registerScreen.classList.add('hidden');}
function showRegister(){mainScreen.classList.add('hidden');registerScreen.classList.remove('hidden');phoneScreen.classList.add('hidden');passwordScreen.classList.add('hidden');}

// --- PHONE MASK ---
[phoneInput,loginPhone,regPhone].forEach(i=>{
  i.addEventListener('input',()=>{maskPhone(i);});
});
function maskPhone(input){
  let v=input.value.replace(/\D/g,'');
  if(v.startsWith('8')) v='7'+v.slice(1);
  if(!v.startsWith('7')) v='7'+v;
  let r='+7';
  if(v.length>1) r+=' ('+v.slice(1,4);
  if(v.length>=5) r+=') '+v.slice(4,7);
  if(v.length>=8) r+='-'+v.slice(7,9);
  if(v.length>=10) r+='-'+v.slice(9,11);
  input.value=r;
}

// --- DOB MASK ---
regDob.addEventListener('input',()=>{
  let v=regDob.value.replace(/\D/g,'').slice(0,8);
  let r='';
  if(v.length>=2) r=v.slice(0,2)+'/';
  else r=v;
  if(v.length>=4) r+=v.slice(2,4)+'/';
  else if(v.length>2) r+=v.slice(2);
  if(v.length>4) r+=v.slice(4,8);
  regDob.value=r;
});

// --- CARD MASK (Priority) ---
regCard.addEventListener('input',()=>{
  let v=regCard.value.replace(/\D/g,'').slice(0,10);
  let r='';
  if(v.length>=3) r=v.slice(0,3)+' ';
  else r=v;
  if(v.length>=6) r+=v.slice(3,6)+' ';
  else if(v.length>3) r+=v.slice(3);
  if(v.length>6) r+=v.slice(6);
  regCard.value=r;
});

// --- CLEAN PHONE ---
function cleanPhone(v){const d=v.replace(/\D/g,'');return d.startsWith('7')?'+'+d:'+7'+d;}

// --- SEND SMS ---
document.getElementById('sendCodeBtn').onclick=async ()=>{
  phoneError.textContent='';
  const phone=cleanPhone(phoneInput.value);
  if(phone.replace(/\D/g,'').length<11){phoneError.textContent='–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä';return;}
  const res=await fetch(API+'/api/auth/request-code',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({phone})
  });
  if(!res.ok){phoneError.textContent='–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS';return;}
  phoneScreen.classList.add('hidden');
  codeScreen.classList.remove('hidden');
};

// --- VERIFY CODE ---
document.getElementById('verifyBtn').onclick=async ()=>{
  codeError.textContent='';
  if(codeInput.value.length!==4){codeError.textContent='–í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥';return;}
  const phone=cleanPhone(phoneInput.value);
  const res=await fetch(API+'/api/auth/verify-code',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({phone,code:codeInput.value})
  });
  const data=await res.json();
  if(!res.ok){codeError.textContent=data.error||'–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥';return;}
  localStorage.setItem('token',data.token);
  welcomeName.textContent=data.fio||'';
  codeScreen.classList.add('hidden');
  welcomeScreen.classList.remove('hidden');
  setTimeout(()=>location.href='cabinet.html',2000);
};

// --- LOGIN WITH PASSWORD ---
document.getElementById('loginBtn').onclick=async ()=>{
  loginError.textContent='';
  const phone=cleanPhone(loginPhone.value);
  const password=loginPassword.value;
  if(!phone||!password){loginError.textContent='–î–∞–Ω–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã';return;}
  const res=await fetch(API+'/api/auth/login',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({phone,password})
  });
  const data=await res.json();
  if(!res.ok){loginError.textContent=data.error||'–û—à–∏–±–∫–∞';return;}
  localStorage.setItem('token',data.token);
  welcomeName.textContent='';
  passwordScreen.classList.add('hidden');
  welcomeScreen.classList.remove('hidden');
  setTimeout(()=>location.href='cabinet.html',2000);
};

// --- REGISTER ---
document.getElementById('regBtn').onclick=async ()=>{
  regError.textContent='';
  const payload={
    fio:regFio.value,
    email:regEmail.value,
    phone:cleanPhone(regPhone.value),
    password:regPassword.value,
    dob:regDob.value,
    cardNumber:regCard.value
  };
  if(!payload.fio||!payload.email||!payload.phone||!payload.password){regError.textContent='–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è';return;}
  const res=await fetch(API+'/api/register',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
  const data=await res.json();
  if(!res.ok){regError.textContent=data.error||'–û—à–∏–±–∫–∞';return;}
  localStorage.setItem('token',data.token);
  welcomeName.textContent=data.user.fio||'';
  registerScreen.classList.add('hidden');
  welcomeScreen.classList.remove('hidden');
  setTimeout(()=>location.href='cabinet.html',2000);
};
</script>
</body>
</html>
