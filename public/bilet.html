<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Карты — 100+ маршрутов (20 самолётов)</title>

<!-- Leaflet (для удобной карты/тайлов) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
 integrity="sha512-sA+q1m7wqVJ2qpo4eG6B8q6T8xQqZrRjnk2kq0Qp5g2l+6w6Fq1E2SxQ3bq2W2c8b1Z9Wz4l9nK6YvGk6G6QA=="
 crossorigin=""/>
<style>
  :root{
    --neon-green: #baff00;
    --sky-blue: #77b7ff;
    --muted: #d9d9d9;
    --bg: #0f1720; /* dark background so neon stands out */
  }
  html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);}
  /* блок занимает весь экран (вариант A) */
  .map-screen{position:relative;height:100vh;width:100%;overflow:hidden;}

  /* контейнер карты (Leaflet) */
  #map{height:100%;width:100%;}

  /* стили маршрутов — будут добавляться в SVG overlay */
  .route-line { stroke-width:2.4; stroke-linecap:round; fill:none; opacity:0.95; filter:drop-shadow(0 0 8px rgba(186,255,0,0.15)); }
  .route-green { stroke:var(--neon-green); }
  .route-blue  { stroke:var(--sky-blue); }

  /* самолётик — маленький кружок, будет html element */
  .plane {
    position:absolute;
    width:10px;height:10px;border-radius:50%;
    transform:translate(-50%,-50%) rotate(0deg);
    box-shadow:0 0 8px rgba(186,255,0,0.9);
    pointer-events:none;
    z-index:6000;
  }
  .plane.blue { background:var(--sky-blue); box-shadow:0 0 10px rgba(119,183,255,0.9); }
  .plane.green { background:var(--neon-green); box-shadow:0 0 10px rgba(186,255,0.9); }

  /* точки-городa */
  .city-dot {
    width:12px;height:12px;border-radius:50%;
    position:absolute; transform:translate(-50%,-50%); z-index:5000;
    box-shadow:0 0 8px rgba(0,0,0,0.45);
  }
  .city-dot.small { width:8px;height:8px; box-shadow:none; opacity:0.95; }

  /* выделенные центры */
  .city-moscow { background:var(--neon-green); border:2px solid rgba(0,0,0,0.12); box-shadow:0 0 18px rgba(186,255,0,0.8); }
  .city-nsk    { background:var(--sky-blue);  border:2px solid rgba(0,0,0,0.12); box-shadow:0 0 18px rgba(119,183,255,0.9); }

  /* 100+ box */
  .counter-box {
    position:absolute; right:36px; bottom:36px; z-index:7000;
    width:220px;height:130px;border-radius:20px;
    background:linear-gradient(135deg, rgba(196,255,0,0.95), rgba(180,240,20,0.95));
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    box-shadow:0 8px 40px rgba(0,0,0,0.45);
    color:#111;
  }
  #counter { font-size:52px;font-weight:800; line-height:1; }
  .counter-sub { font-size:16px; margin-top:6px; opacity:0.85; }

  /* карта подписи (минималистичный стиль подсказки) */
  .legend {
    position:absolute; left:24px; bottom:24px; z-index:7000; color:#fff; font-size:13px;
    background: rgba(255,255,255,0.06); padding:8px 12px; border-radius:10px; backdrop-filter: blur(6px);
    box-shadow: 0 6px 24px rgba(0,0,0,0.6);
  }

  /* адаптация для мобильных */
  @media (max-width:720px){
    .counter-box{right:16px; bottom:16px; width:160px; height:110px;}
    #counter{font-size:36px}
  }
</style>
</head>
<body>

<div class="map-screen">
  <div id="map"></div>

  <!-- city dots and planes will be positioned absolutely over the map -->
  <div id="overlay" style="position:absolute; inset:0; pointer-events:none;"></div>

  <div class="counter-box">
    <div id="counter">100+</div>
    <div class="counter-sub">направлений</div>
  </div>

  <div class="legend">20 маршрутов (анимировано)</div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
 integrity="sha512-XQoYMqMTK8LvdlxU8nQ2JYjvAqv4rZ6a1Gq8qGQw7rEw5QFv1k9BNp1z1Kq0x3sQ1uF6zQfP5d7Y3gY3sY7SA=="
 crossorigin=""></script>

<script>
/* ========= ДАННЫЕ: 20 городов (реальные / приблизительные координаты) =========
   Источники: Москва и Новосибирск (см. ссылки внизу). Остальные — стандартные координаты городов.
   Формат: [name, lat, lon]
*/
const cities = [
  ['Moscow', 55.7558, 37.6173],
  ['Saint Petersburg', 59.9343, 30.3351],
  ['Novosibirsk', 55.0188, 82.9339],
  ['Yekaterinburg', 56.8389, 60.6057],
  ['Omsk', 54.9924, 73.3686],
  ['Kazan', 55.8304, 49.0661],
  ['Chelyabinsk', 55.1644, 61.4368],
  ['Samara', 53.2415, 50.2212],
  ['Rostov-on-Don', 47.2357, 39.7015],
  ['Ufa', 54.7388, 55.9721],
  ['Volgograd', 48.7080, 44.5133],
  ['Krasnoyarsk', 56.0153, 92.8932],
  ['Perm', 58.0105, 56.2502],
  ['Voronezh', 51.6720, 39.1843],
  ['Saratov', 51.5331, 46.0342],
  ['Tyumen', 57.1522, 65.5272],
  ['Irkutsk', 52.2833, 104.2833],
  ['Khabarovsk', 48.4799, 135.0725],
  ['Vladivostok', 43.1155, 131.8855],
  ['Murmansk', 68.9730, 33.0900]
];

/* ===== инициализация карты (минималистичный тайл: CartoDB Positron) ===== */
const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([60, 95], 3.2);

/* Carto Positron — минималистичные светлые тайлы (подчёркивают не мешая линиям) */
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 19
}).addTo(map);

/* overlay SVG — будем рисовать кривые в svg поверх карты */
const svgLayer = L.svg({ clickable: false }).addTo(map);
const svg = d3SelectSVG(); // helper (определён ниже)

/* helpers: latlng -> point in SVG coords */
function latLngToLayerPoint(lat, lon){
  return map.latLngToLayerPoint([lat, lon]);
}

/* рисуем точки городов и выделяем Москва + Новосиб */
const overlay = document.getElementById('overlay');

function addCityDots(){
  cities.forEach(([name, lat, lon], i)=>{
    const p = map.latLngToContainerPoint([lat, lon]);
    const el = document.createElement('div');
    el.className = 'city-dot' + ( (name==='Moscow') ? ' city-moscow' : (name==='Novosibirsk' ? ' city-nsk' : ' small' ) );
    el.style.left = p.x + 'px';
    el.style.top  = p.y + 'px';
    el.title = name;
    overlay.appendChild(el);
  });
}

/* при движении/зуме — обновляем позиции city dots */
map.on('move zoom', () => {
  // reposition dots
  const dots = overlay.querySelectorAll('.city-dot');
  dots.forEach((el, idx)=>{
    const [ , lat, lon ] = cities[idx];
    const p = map.latLngToContainerPoint([lat, lon]);
    el.style.left = p.x + 'px';
    el.style.top  = p.y + 'px';
  });
  // redraw curves
  drawAllCurves();
});

/* ===== функция для создания «кривой» между двумя точками — возвращает массив точек =====
   Мы создаём мягкую дугу, аппроксимируя её N точками (чтобы можно было анимировать движение).
*/
function curvePoints(fromLatLng, toLatLng, options = {}) {
  const steps = options.steps || 120;
  const cpFactor = options.cpFactor || 0.35; // насколько дуга выпуклая
  const lat1 = fromLatLng[0], lon1 = fromLatLng[1];
  const lat2 = toLatLng[0], lon2 = toLatLng[1];

  // промежуточная «высота» для дуги — больше расстояние => выше дуга
  const dLat = lat2 - lat1;
  const dLon = lon2 - lon1;
  const dist = Math.sqrt(dLat*dLat + dLon*dLon);
  const height = Math.max(1, dist * cpFactor);

  const pts = [];
  for (let t=0; t<=1; t+=1/steps) {
    // базовая линейная интерполяция
    const lat = lat1 + (lat2 - lat1) * t;
    const lon = lon1 + (lon2 - lon1) * t;
    // добавить «подъём» перпендикулярно отрезку — простая модель
    // вычислим нормаль (rotate 90deg)
    const nx = - (dLat);
    const ny =   (dLon);
    // нормализуем
    const nlen = Math.sqrt(nx*nx + ny*ny) || 1;
    const nxn = nx / nlen;
    const nyn = ny / nlen;
    // профиль подъёма — синус для плавности
    const lift = Math.sin(Math.PI * t) * height;
    // скорректируем lon/lat непрямолинейно (прибл.)
    const latAdj = lat + nxn * lift * 0.1;
    const lonAdj = lon + nyn * lift * 0.1;
    pts.push([latAdj, lonAdj]);
  }
  return pts;
}

/* массив объектов маршрутов (будем брать 10 маршрутов от Москвы, 10 — от Новосиба) */
const routes = [];
(function buildRoutes(){
  // отделяем Москву и Новосибирск
  const moscow = cities[0];
  const novosib = cities[2];

  // остальные индексы
  const others = cities.filter((c,i)=> i!==0 && i!==2);
  // первые 10 от Москвы, остальные 10 от Новосиба
  const first10 = others.slice(0,10);
  const second10 = others.slice(10,20);

  first10.forEach(dest => routes.push({from: moscow, to: dest, color:'green'}));
  second10.forEach(dest => routes.push({from: novosib, to: dest, color:'blue'}));
})();

/* Отрисовка кривых в SVG overlay (каждый раз при зуме/пане) */
function drawAllCurves(){
  // очистим svg
  while (svg.firstChild) svg.removeChild(svg.firstChild);

  routes.forEach((r, idx) => {
    const ptsLatLng = curvePoints([r.from[1] ? r.from[1] : r.from[0], 0], [0,0]); // placeholder, we won't use this branch
    // Instead compute actual curvePoints with correct args:
    const points = curvePoints([r.from[1] ? r.from[0] : r.from[0], r.from[1] ? r.from[1] : r.from[1]]); // normalize
    // simpler: call with arrays:
    const from = [r.from[1] ? r.from[0] : r.from[0], r.from[1] ? r.from[1] : r.from[1]];
    const to   = [r.to[1] ? r.to[0] : r.to[0], r.to[1] ? r.to[1] : r.to[1]];
    const latlngs = curvePoints([r.from[1] ? r.from[0] : r.from[0], r.from[1] ? r.from[1] : r.from[1]], 
                                [r.to[0], r.to[1]], {steps:120, cpFactor:0.4});

    // convert to svg path d
    const d = latlngs.map((ll,i)=>{
      const p = map.latLngToLayerPoint([ll[0], ll[1]]);
      return (i===0?('M'+p.x+','+p.y):('L'+p.x+','+p.y));
    }).join(' ');

    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', d);
    path.setAttribute('class', 'route-line ' + (r.color==='green' ? 'route-green' : 'route-blue'));
    path.setAttribute('data-idx', idx);
    svg.appendChild(path);

    // store polyline points in route for animation
    const segs = [];
    latlngs.forEach(ll => {
      const pt = map.latLngToLayerPoint([ll[0], ll[1]]);
      segs.push([pt.x, pt.y]);
    });
    r._segments = segs;
  });
}

/* ========== анимация самолётов: создадим 20 DOM-элементов и анимируем вдоль r._segments ========== */
const planes = [];

function createPlanes(){
  // уберём старые
  const old = overlay.querySelectorAll('.plane'); old.forEach(o=>o.remove());
  routes.forEach((r, idx) => {
    const el = document.createElement('div');
    el.className = 'plane ' + (r.color==='green' ? 'green' : 'blue');
    // случайный смещение начальной позиции по маршруту
    el.dataset.offset = Math.random();
    overlay.appendChild(el);
    planes.push({el, route: r, speed: 0.0009 + Math.random()*0.0012}); // скорость
  });
}

/* функция, двигающая каждую plane по сегментам */
let lastTime = performance.now();
function animatePlanes(now){
  const dt = now - lastTime; lastTime = now;
  planes.forEach(pl => {
    const seg = pl.route._segments;
    if(!seg || seg.length===0) return;
    // offset в [0,1)
    let off = parseFloat(pl.el.dataset.offset);
    off += pl.speed * dt; // скорость * dt
    off = off % 1;
    pl.el.dataset.offset = off;
    // compute index along seg
    const pos = off * (seg.length-1);
    const i = Math.floor(pos);
    const t = pos - i;
    const [x1,y1] = seg[i];
    const [x2,y2] = seg[Math.min(i+1, seg.length-1)];
    const x = x1 + (x2-x1)*t;
    const y = y1 + (y2-y1)*t;
    pl.el.style.left = x + 'px';
    pl.el.style.top  = y + 'px';
    // rotate to direction
    const angle = Math.atan2(y2-y1, x2-x1) * 180/Math.PI;
    pl.el.style.transform = `translate(-50%,-50%) rotate(${angle}deg)`;
  });
  requestAnimationFrame(animatePlanes);
}

/* d3SelectSVG helper: returns the SVG node added by leaflet's L.svg() */
function d3SelectSVG(){
  // leaflet puts an <svg> as first child of map.getPanes().overlayPane
  const overlayPane = map.getPanes().overlayPane;
  const svgs = overlayPane.getElementsByTagName('svg');
  if(svgs.length) return svgs[0];
  // fallback: create svg and append
  const s = document.createElementNS('http://www.w3.org/2000/svg','svg');
  s.setAttribute('width','100%'); s.setAttribute('height','100%');
  overlayPane.appendChild(s);
  return s;
}

/* === старт: разместим точки, нарисуем кривые, создадим самолёты и запустим анимацию === */
addCityDots();
drawAllCurves();
createPlanes();
requestAnimationFrame(animatePlanes);

/* также пересоздаём кривые и самолёты при завершении загрузки карты и при зуме/пане (чтобы сегменты пересчитались) */
map.whenReady(()=>{ drawAllCurves(); createPlanes(); });

map.on('zoomend moveend', ()=>{
  drawAllCurves();
  // пересоздаём planes — чтобы сегменты совпали
  planes.length = 0;
  createPlanes();
});

/* ===== счётчик 100+ (плавно меняется) ===== */
const counterEl = document.getElementById('counter');
let v = 100;
setInterval(()=> {
  v++; if(v>140) v = 100;
  counterEl.innerText = v + '+';
}, 140);

</script>
</body>
</html>
